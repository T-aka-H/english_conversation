<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Situational AI English - Ëã±‰ºöË©±Á∑¥Áøí</title>
    <link rel="icon" href="data:,">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
            overflow: hidden;
        }
        
        .header {
            background: rgba(255,255,255,0.05);
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: #4A90E2;
            margin-bottom: 5px;
            font-weight: 300;
        }
        
        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .info-item {
            background: rgba(255,255,255,0.05);
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .info-item h4 {
            color: #4A90E2;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .info-item p {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            min-height: calc(100vh - 200px);
        }
        
        .conversation-area {
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
        }
        
        .conversation-display {
            flex: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            line-height: 1.4;
        }
        
        .message.ai {
            background: rgba(74, 144, 226, 0.1);
            border-left: 3px solid #4A90E2;
        }
        
        .message.user {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28a745;
            margin-left: 20px;
        }
        
        .message .sender {
            font-weight: bold;
            font-size: 12px;
            color: #4A90E2;
            margin-bottom: 5px;
        }
        
        .message.user .sender {
            color: #28a745;
        }
        
        .input-area {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .input-group {
            flex: 1;
        }
        
        .input-textarea {
            width: 100%;
            min-height: 60px;
            max-height: 120px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .input-textarea:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.2);
        }
        
        .input-textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 100px;
        }
        
        .button:hover:not(:disabled) {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.primary {
            background: linear-gradient(135deg, #28A745, #20A042);
        }
        
        .button.primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #20A042, #1E7E3A);
        }
        
        .button.secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .button.secondary:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .sidebar {
            background: rgba(255,255,255,0.03);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 30px 20px;
        }
        
        .sidebar h3 {
            color: #4A90E2;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .sidebar-section {
            margin-bottom: 25px;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28A745, #20A042);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #4A90E2;
        }
        
        .stat-label {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-top: 2px;
        }
        
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.7);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-left: 2px solid #4A90E2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-left: none;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
            
            .conversation-area {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .session-info {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .input-area {
                flex-direction: column;
            }
            
            .input-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üéØ „Éì„Ç∏„Éç„ÇπËã±‰ºöË©±Á∑¥Áøí</h1>
            
            <div class="session-info">
                <div class="info-item">
                    <h4>„Ç∑„Éä„É™„Ç™</h4>
                    <p id="scenarioDisplay">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                </div>
                <div class="info-item">
                    <h4>Èõ£ÊòìÂ∫¶</h4>
                    <p id="difficultyDisplay">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                </div>
                <div class="info-item">
                    <h4>„Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñì</h4>
                    <p id="sessionTimer">00:00</p>
                </div>
                <div class="info-item">
                    <h4>„ÇÑ„ÇäÂèñ„ÇäÊï∞</h4>
                    <p><span id="messageCount">0</span> Âõû</p>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="conversation-area">
                <div class="conversation-display" id="conversationDisplay">
                    <div class="message ai">
                        <div class="sender">AI Assistant</div>
                        <p>Loading your scenario... Please wait a moment while I prepare the conversation.</p>
                    </div>
                </div>
                
                <div class="loading-indicator" id="loadingIndicator">
                    <span class="loading-spinner"></span>
                    AI„ÅåËÄÉ„Åà‰∏≠...
                </div>
                
                <div class="input-area">
                    <div class="input-group">
                        <textarea 
                            id="userInput" 
                            class="input-textarea"
                            placeholder="„Åì„Åì„Å´Ëã±Ë™û„ÅßËøîÁ≠î„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."
                            rows="3"
                        ></textarea>
                    </div>
                    
                    <div class="input-buttons">
                        <button id="sendButton" class="button primary" onclick="sendMessage()">
                            ÈÄÅ‰ø°
                        </button>
                        <button class="button secondary" onclick="clearConversation()">
                            „ÇØ„É™„Ç¢
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>üìä ÈÄ≤Êçó</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.7);">
                        <span id="progressText">0% ÂÆå‰∫Ü</span>
                    </p>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="accuracyScore">--</div>
                            <div class="stat-label">Ê≠£Á¢∫ÊÄß</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="fluencyScore">--</div>
                            <div class="stat-label">ÊµÅÊö¢ÊÄß</div>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3>‚ö° „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥</h3>
                    <div class="quick-actions">
                        <button class="button secondary" onclick="getHint()">
                            üí° „Éí„É≥„Éà„ÇíË¶ã„Çã
                        </button>
                        <button class="button secondary" onclick="requestFeedback()">
                            üìù „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                        </button>
                        <button class="button secondary" onclick="finishSession()">
                            ‚úÖ „Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü
                        </button>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3>‚öôÔ∏è „Çª„ÉÉ„Ç∑„Éß„É≥Âà∂Âæ°</h3>
                    <div class="quick-actions">
                        <button class="button secondary" onclick="restartSession()">
                            üîÑ „ÇÑ„ÇäÁõ¥„Åó
                        </button>
                        <button class="button secondary" onclick="goBack()">
                            ‚Üê Êàª„Çã
                        </button>
                        <button class="button secondary" onclick="logout()">
                            üö™ „É≠„Ç∞„Ç¢„Ç¶„Éà
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let messageCount = 0;
        let sessionStartTime = new Date();
        let timerInterval;
        let conversationHistory = [];
        
        console.log('üí¨ Conversation page loaded');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Initializing conversation session...');
            
            // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
            if (!checkAuthentication()) {
                return;
            }
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
            loadSessionInfo();
            
            // „Çø„Ç§„Éû„Éº„ÇíÈñãÂßã
            startSessionTimer();
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupEventListeners();
            
            console.log('‚úÖ Conversation session initialized');
        });
        
        function checkAuthentication() {
            try {
                const isAuthenticated = sessionStorage.getItem('isAuthenticated');
                const authTime = sessionStorage.getItem('authTime');
                
                if (!isAuthenticated) {
                    console.log('‚ùå No authentication found');
                    alert('Please login first.');
                    window.location.replace('index.html');
                    return false;
                }
                
                // Ë™çË®º„ÅÆÊúâÂäπÊúüÈôê„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà24ÊôÇÈñìÔºâ
                if (authTime) {
                    const currentTime = new Date().getTime();
                    const authTimeStamp = parseInt(authTime);
                    const hoursDiff = (currentTime - authTimeStamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        console.log('‚è∞ Authentication expired');
                        sessionStorage.clear();
                        alert('Session expired. Please login again.');
                        window.location.replace('index.html');
                        return false;
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Authentication check error:', error);
                window.location.replace('index.html');
                return false;
            }
        }
        
        function loadSessionInfo() {
            try {
                // „Ç∑„Éä„É™„Ç™ÊÉÖÂ†±„ÇíË°®Á§∫
                const scenario = sessionStorage.getItem('selectedScenario');
                const difficulty = sessionStorage.getItem('selectedDifficulty');
                
                document.getElementById('scenarioDisplay').textContent = 
                    scenario || '„Ç∑„Éä„É™„Ç™„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
                    
                document.getElementById('difficultyDisplay').textContent = 
                    difficulty ? (difficulty === 'normal' ? '„Éé„Éº„Éû„É´' : '„Éè„Éº„Éâ') : '„Éé„Éº„Éû„É´';
                
                console.log('üìã Loaded scenario:', scenario);
                console.log('‚öôÔ∏è Loaded difficulty:', difficulty);
                
                // „Ç∑„Éä„É™„Ç™„Å´Âü∫„Å•„ÅÑ„Å¶AI„Åã„Çâ‰ºöË©±„ÇíÈñãÂßã
                if (scenario) {
                    setTimeout(() => {
                        startScenarioBasedConversation(scenario, difficulty);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('‚ùå Error loading session info:', error);
            }
        }
        
        function setupEventListeners() {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            
            // Enter „Ç≠„Éº„Åß„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÔºàShift+Enter „ÅßÊîπË°åÔºâ
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´„Éï„Ç©„Éº„Ç´„Çπ
            userInput.focus();
        }
        
        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = now - sessionStartTime;
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) {
                alert('„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            console.log('üì§ Sending message:', message);
            
            // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            addMessageToDisplay('user', 'You', message);
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
            userInput.value = '';
            
            // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            document.getElementById('sendButton').disabled = true;
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            showLoading(true);
            
            // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
            conversationHistory.push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            
            // AI„É¨„Çπ„Éù„É≥„Çπ„Çí„Ç∑„Éü„É•„É¨„Éº„ÉàÔºàÂÆüÈöõ„ÅÆAIÈÄ£Êê∫ÊôÇ„ÅØ„Åì„Åì„ÇíÂ§âÊõ¥Ôºâ
            setTimeout(() => {
                generateAIResponse(message);
            }, 1000 + Math.random() * 2000); // 1-3Áßí„ÅÆ„É©„É≥„ÉÄ„É†ÈÅÖÂª∂
        }
        
        function generateAIResponse(userMessage) {
            // „Åì„Çå„ÅØÁ∞°ÊòìÁöÑ„Å™„Éá„É¢ÂøúÁ≠î„Åß„Åô„ÄÇÂÆüÈöõ„ÅÆAIÈÄ£Êê∫ÊôÇ„ÅØÈÅ©Âàá„Å™API„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            const responses = [
                "That's an interesting point. Could you elaborate on the specific challenges you're facing?",
                "I understand your perspective. How do you think we can move forward with this proposal?",
                "Thank you for sharing that information. What would be the next steps in your opinion?",
                "That's a valid concern. Have you considered alternative approaches to address this issue?",
                "I appreciate your input. Could you provide more details about the timeline you have in mind?",
                "Good point. How do you see this impacting our current operations?",
                "That makes sense. What resources would you need to implement this solution?",
                "Interesting approach. How would you measure the success of this initiative?"
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            // AI„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            addMessageToDisplay('ai', 'AI Assistant', randomResponse);
            
            // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
            conversationHistory.push({
                role: 'assistant',
                content: randomResponse,
                timestamp: new Date().toISOString()
            });
            
            // UIÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            showLoading(false);
            document.getElementById('sendButton').disabled = false;
            document.getElementById('userInput').focus();
            
            // ÈÄ≤Êçó„Å®„Çπ„Ç≥„Ç¢„ÇíÊõ¥Êñ∞
            updateProgress();
        }
        
        function addMessageToDisplay(type, sender, message) {
            const conversationDisplay = document.getElementById('conversationDisplay');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            messageDiv.innerHTML = `
                <div class="sender">${sender}</div>
                <p>${message}</p>
            `;
            
            conversationDisplay.appendChild(messageDiv);
            
            // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏ãÈÉ®„Å´
            conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
            
            // „É°„ÉÉ„Çª„Éº„Ç∏„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
            if (type === 'user') {
                messageCount++;
                document.getElementById('messageCount').textContent = messageCount;
            }
        }
        
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = show ? 'block' : 'none';
        }
        
        function updateProgress() {
            // Á∞°ÊòìÁöÑ„Å™ÈÄ≤ÊçóË®àÁÆóÔºà„É°„ÉÉ„Çª„Éº„Ç∏Êï∞„Å´Âü∫„Å•„ÅèÔºâ
            const progress = Math.min(messageCount * 10, 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '% ÂÆå‰∫Ü';
            
            // Á∞°ÊòìÁöÑ„Å™„Çπ„Ç≥„Ç¢Ë®àÁÆó
            const accuracy = Math.floor(Math.random() * 20) + 80; // 80-100
            const fluency = Math.floor(Math.random() * 15) + 75;  // 75-90
            
            document.getElementById('accuracyScore').textContent = accuracy + '%';
            document.getElementById('fluencyScore').textContent = fluency + '%';
        }
        
        function clearConversation() {
            if (confirm('‰ºöË©±„Çí„ÇØ„É™„Ç¢„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                document.getElementById('conversationDisplay').innerHTML = `
                    <div class="message ai">
                        <div class="sender">AI Assistant</div>
                        <p>Conversation cleared. Let's start fresh! Please begin the conversation.</p>
                    </div>
                `;
                conversationHistory = [];
                messageCount = 0;
                document.getElementById('messageCount').textContent = '0';
                updateProgress();
            }
        }
        
        function getHint() {
            const hints = [
                "„Çà„ÇäÂ∞ÇÈñÄÁöÑ„Å™„Éì„Ç∏„Éç„ÇπË™ûÂΩô„Çí‰ΩøÁî®„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                "Áõ∏Êâã„Å∏„ÅÆË≥™Âïè„ÇíÊäï„Åí„Åã„Åë„Å¶„ÄÅÁ©çÊ•µÁöÑ„Å™ÂßøÂã¢„ÇíÁ§∫„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
                "„ÄåFurthermore„Äç„ÇÑ„ÄåIn addition„Äç„Å™„Å©„ÅÆÊé•Á∂öË©û„Çí‰Ωø„Å£„Å¶„ÄÅ„Ç¢„Ç§„Éá„Ç¢„ÇíÁπã„Åí„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                "Áõ∏Êâã„ÅÆÁô∫Ë®Ä„ÇíË™ç„ÇÅ„Çã„Åì„Å®„Åß„ÄÅ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É™„Çπ„Éã„É≥„Ç∞„ÇíÂÆüË∑µ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
                "ÂÖ∑‰ΩìÁöÑ„Å™Êï∞Â≠ó„ÄÅÊó•‰ªò„ÄÅ‰æã„Çí‰Ωø„Å£„Å¶„Çà„ÇäÊòéÁ¢∫„Å´Ë°®Áèæ„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
            ];
            
            const randomHint = hints[Math.floor(Math.random() * hints.length)];
            alert('üí° „Éí„É≥„Éà: ' + randomHint);
        }
        
        function requestFeedback() {
            if (conversationHistory.length === 0) {
                alert('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Çí„É™„ÇØ„Ç®„Çπ„Éà„Åô„ÇãÂâç„Å´„ÄÅ„Åæ„Åö‰ºöË©±„ÇíÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            alert('üìù „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅØ„Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫ÜÊôÇ„Å´Êèê‰æõ„Åï„Çå„Åæ„Åô„ÄÇÁ∑¥Áøí„ÇíÁ∂ö„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
        }
        
        function finishSession() {
            if (confirm('„Åì„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁµÇ‰∫Ü„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                // „Çª„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„Çø„Çí‰øùÂ≠ò
                const sessionData = {
                    scenario: sessionStorage.getItem('selectedScenario'),
                    difficulty: sessionStorage.getItem('selectedDifficulty'),
                    messageCount: messageCount,
                    conversationHistory: conversationHistory,
                    sessionDuration: new Date() - sessionStartTime
                };
                
                sessionStorage.setItem('sessionData', JSON.stringify(sessionData));
                
                // ÊúÄÁµÇ„É¨„Éù„Éº„Éà„Éö„Éº„Ç∏„Å´ÈÅ∑ÁßªÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
                window.location.href = 'final-report.html';
            }
        }
        
        function restartSession() {
            if (confirm('„Åì„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„Çí„ÇÑ„ÇäÁõ¥„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                window.location.reload();
            }
        }
        
        function goBack() {
            if (confirm('Êàª„Å£„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºüÁèæÂú®„ÅÆÈÄ≤Êçó„ÅØÂ§±„Çè„Çå„Åæ„Åô„ÄÇ')) {
                window.location.href = 'difficulty.html';
            }
        }
        
        function logout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                sessionStorage.clear();
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                window.location.replace('index.html');
            }
        }
        
        // „Ç∑„Éä„É™„Ç™„Å´Âü∫„Å•„ÅÑ„Å¶AI„Åã„Çâ‰ºöË©±„ÇíÈñãÂßã„Åô„ÇãÈñ¢Êï∞
        function startScenarioBasedConversation(scenario, difficulty) {
            console.log('üé≠ Starting scenario-based conversation');
            
            // ‰ºöË©±Ë°®Á§∫„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
            document.getElementById('conversationDisplay').innerHTML = '';
            
            // „Ç∑„Éä„É™„Ç™„Å´Âü∫„Å•„ÅÑ„ÅüÈñãÂßã„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîüÊàê
            const openingMessage = generateScenarioOpening(scenario, difficulty);
            
            // AI„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            addMessageToDisplay('ai', 'AI Assistant', openingMessage);
            
            // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
            conversationHistory.push({
                role: 'assistant',
                content: openingMessage,
                timestamp: new Date().toISOString()
            });
        }
        
        // „Ç∑„Éä„É™„Ç™„Å´Âü∫„Å•„ÅÑ„ÅüÈñãÂßã„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîüÊàê
        function generateScenarioOpening(scenario, difficulty) {
            const lowerScenario = scenario.toLowerCase();
            
            // „ÉÅ„Éº„É†„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Èñ¢ÈÄ£
            if (lowerScenario.includes('meeting') || lowerScenario.includes('„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞') || lowerScenario.includes('‰ºöË≠∞')) {
                return "Good morning everyone! Thank you for joining today's meeting. I've called this meeting to discuss our quarterly results and plan our strategy for the upcoming quarter. Let's start by reviewing the key performance indicators from last quarter. What are your initial thoughts on our performance?";
            }
            
            // „Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥Èñ¢ÈÄ£
            if (lowerScenario.includes('presentation') || lowerScenario.includes('„Éó„É¨„Çº„É≥') || lowerScenario.includes('ÊèêÊ°à')) {
                return "Good afternoon, and thank you for taking the time to meet with us today. I'm excited to present our new product proposal that I believe will significantly impact your business growth. Before we dive into the details, could you tell me a bit about your current challenges in this market segment?";
            }
            
            // ÈõªË©±„Éª„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂØæÂøúÈñ¢ÈÄ£
            if (lowerScenario.includes('phone') || lowerScenario.includes('client') || lowerScenario.includes('ÈõªË©±') || lowerScenario.includes('„ÇØ„É©„Ç§„Ç¢„É≥„Éà')) {
                return "Hello, thank you for calling. I understand you're experiencing some service issues, and I want to make sure we resolve this matter promptly. Could you please describe the specific problem you're facing so I can better assist you?";
            }
            
            // Èù¢Êé•Èñ¢ÈÄ£
            if (lowerScenario.includes('interview') || lowerScenario.includes('Èù¢Êé•')) {
                return "Good morning! Welcome to our company. I'm pleased to meet with you today regarding the senior management position. I've reviewed your resume and I'm impressed with your background. Let's start with you telling me about your leadership experience and what motivates you in a management role.";
            }
            
            // ‰∫§Ê∏âÈñ¢ÈÄ£
            if (lowerScenario.includes('negotiation') || lowerScenario.includes('‰∫§Ê∏â') || lowerScenario.includes('Â•ëÁ¥Ñ')) {
                return "Thank you for meeting with us today to discuss the contract terms. We've reviewed your initial proposal, and while we appreciate the comprehensive scope of services, we'd like to discuss some aspects of the pricing structure and delivery timeline. Shall we start with the pricing model?";
            }
            
            // ‰∫∫‰∫ãË©ï‰æ°Èñ¢ÈÄ£
            if (lowerScenario.includes('performance') || lowerScenario.includes('review') || lowerScenario.includes('Ë©ï‰æ°') || lowerScenario.includes('‰∫∫‰∫ã')) {
                return "Hi there! Thanks for setting aside time for our performance review meeting. I've been looking forward to discussing your achievements this year and exploring opportunities for your professional development. Let's start by reflecting on your key accomplishments. What would you say were your biggest successes this year?";
            }
            
            // „Ç´„Çπ„Çø„Éû„Éº„Çµ„Éº„Éì„ÇπÈñ¢ÈÄ£
            if (lowerScenario.includes('customer service') || lowerScenario.includes('„Ç´„Çπ„Çø„Éû„Éº') || lowerScenario.includes('È°ßÂÆ¢ÂØæÂøú')) {
                return "Hello! Thank you for contacting our customer service team. I'm here to help resolve any issues you may be experiencing with our products or services. Could you please provide me with your account information and describe the nature of your inquiry?";
            }
            
            // ‰∏ÄËà¨ÁöÑ„Å™„Éì„Ç∏„Éç„Çπ„Ç∑„Éä„É™„Ç™Ôºà„Éá„Éï„Ç©„É´„ÉàÔºâ
            return `Good morning! I'm ready to engage in our business scenario: "${scenario}". Let me set the context and begin our professional interaction. How would you like to approach this situation, and what are your initial thoughts on how we should proceed?`;
        }
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', function(e) {
            console.error('‚ùå Page error:', e.error);
        });
        
        // „Éö„Éº„Ç∏„ÇíÈõ¢„Çå„ÇãÂâç„ÅÆÁ¢∫Ë™ç
        window.addEventListener('beforeunload', function(e) {
            if (messageCount > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        console.log('üìú Conversation script loaded');
    </script>
</body>
</html>