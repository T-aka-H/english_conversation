<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëã±Ë™û„Ç≥„ÇΩÁ∑¥„Ç¢„Éó„É™ - Ëã±‰ºöË©±Á∑¥Áøí</title>
    <link rel="icon" href="data:,">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
            overflow: hidden;
        }
        
        .header {
            background: rgba(255,255,255,0.05);
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: #4A90E2;
            margin-bottom: 5px;
            font-weight: 300;
        }
        
        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .info-item {
            background: rgba(255,255,255,0.05);
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .info-item h4 {
            color: #4A90E2;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .info-item p {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            min-height: calc(100vh - 200px);
        }
        
        .conversation-area {
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
        }
        
        .conversation-display {
            flex: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            line-height: 1.4;
        }
        
        .message.ai {
            background: rgba(74, 144, 226, 0.1);
            border-left: 3px solid #4A90E2;
        }
        
        .message.user {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28a745;
            margin-left: 20px;
        }
        
        .message .sender {
            font-weight: bold;
            font-size: 12px;
            color: #4A90E2;
            margin-bottom: 5px;
        }
        
        .message.user .sender {
            color: #28a745;
        }
        
        .input-area {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .input-group {
            flex: 1;
        }
        
        .input-textarea {
            width: 100%;
            min-height: 60px;
            max-height: 120px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .input-textarea:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.2);
        }
        
        .input-textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .voice-recording {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 100px;
        }
        
        .button:hover:not(:disabled) {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.primary {
            background: linear-gradient(135deg, #28A745, #20A042);
        }
        
        .button.primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #20A042, #1E7E3A);
        }
        
        .button.secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .button.secondary:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .sidebar {
            background: rgba(255,255,255,0.03);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 30px 20px;
        }
        
        .sidebar h3 {
            color: #4A90E2;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .sidebar-section {
            margin-bottom: 25px;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28A745, #20A042);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #4A90E2;
        }
        
        .stat-label {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-top: 2px;
        }
        
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.7);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-left: 2px solid #4A90E2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-left: none;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
            
            .conversation-area {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .session-info {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .input-area {
                flex-direction: column;
            }
            
            .input-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üéØ „Éì„Ç∏„Éç„ÇπËã±‰ºöË©±Á∑¥Áøí</h1>
            
            <div class="session-info">
                <div class="info-item">
                    <h4>„Ç∑„Éä„É™„Ç™</h4>
                    <p id="scenarioDisplay">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                </div>
                <div class="info-item">
                    <h4>Èõ£ÊòìÂ∫¶</h4>
                    <p id="difficultyDisplay">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                </div>
                <div class="info-item">
                    <h4>„Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñì</h4>
                    <p id="sessionTimer">00:00</p>
                </div>
                <div class="info-item">
                    <h4>„ÇÑ„ÇäÂèñ„ÇäÊï∞</h4>
                    <p><span id="messageCount">0</span> Âõû</p>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="conversation-area">
                <div class="conversation-display" id="conversationDisplay">
                    <div class="message ai">
                        <div class="sender">AI Assistant</div>
                        <p>Loading your scenario... Please wait a moment while I prepare the conversation.</p>
                    </div>
                </div>
                
                <div class="loading-indicator" id="loadingIndicator">
                    <span class="loading-spinner"></span>
                    AI„ÅåËÄÉ„Åà‰∏≠...
                </div>
                
                <div class="input-area">
                    <div class="input-group">
                        <textarea 
                            id="userInput" 
                            class="input-textarea"
                            placeholder="„Åì„Åì„Å´Ëã±Ë™û„ÅßËøîÁ≠î„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."
                            rows="3"
                        ></textarea>
                    </div>
                    
                    <div class="input-buttons">
                        <button id="voiceButton" class="button secondary" onclick="toggleVoiceInput()">
                            üé§ Èü≥Â£∞ÂÖ•Âäõ
                        </button>
                        <button id="sendButton" class="button primary" onclick="sendMessage()">
                            ÈÄÅ‰ø°
                        </button>
                        <button class="button secondary" onclick="clearConversation()">
                            „ÇØ„É™„Ç¢
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>üìä ÈÄ≤Êçó</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.7);">
                        <span id="progressText">0% ÂÆå‰∫Ü</span>
                    </p>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="accuracyScore">--</div>
                            <div class="stat-label">Ê≠£Á¢∫ÊÄß</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="fluencyScore">--</div>
                            <div class="stat-label">ÊµÅÊö¢ÊÄß</div>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3>‚ö° „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥</h3>
                    <div class="quick-actions">
                        <button class="button secondary" onclick="getHint()">
                            üí° „Éí„É≥„Éà„ÇíË¶ã„Çã
                        </button>
                        <button class="button secondary" onclick="requestFeedback()">
                            üìù „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                        </button>
                        <button class="button secondary" onclick="finishSession()">
                            ‚úÖ „Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü
                        </button>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3>‚öôÔ∏è „Çª„ÉÉ„Ç∑„Éß„É≥Âà∂Âæ°</h3>
                    <div class="quick-actions">
                        <button class="button secondary" onclick="restartSession()">
                            üîÑ „ÇÑ„ÇäÁõ¥„Åó
                        </button>
                        <button class="button secondary" onclick="goBack()">
                            ‚Üê Êàª„Çã
                        </button>
                        <button class="button secondary" onclick="logout()">
                            üö™ „É≠„Ç∞„Ç¢„Ç¶„Éà
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let messageCount = 0;
        let sessionStartTime = new Date();
        let timerInterval;
        let conversationHistory = [];
        let recognition = null;
        let isRecording = false;
        
        console.log('üí¨ Conversation page loaded');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Initializing conversation session...');
            
            // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
            if (!checkAuthentication()) {
                return;
            }
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
            loadSessionInfo();
            
            // „Çø„Ç§„Éû„Éº„ÇíÈñãÂßã
            startSessionTimer();
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupEventListeners();
            
            // Èü≥Â£∞Ë™çË≠ò„ÇíÂàùÊúüÂåñ
            initializeSpeechRecognition();
            
            console.log('‚úÖ Conversation session initialized');
        });
        
        function checkAuthentication() {
            try {
                const isAuthenticated = sessionStorage.getItem('isAuthenticated');
                const authTime = sessionStorage.getItem('authTime');
                
                if (!isAuthenticated) {
                    console.log('‚ùå No authentication found');
                    alert('Please login first.');
                    window.location.replace('index.html');
                    return false;
                }
                
                // Ë™çË®º„ÅÆÊúâÂäπÊúüÈôê„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà24ÊôÇÈñìÔºâ
                if (authTime) {
                    const currentTime = new Date().getTime();
                    const authTimeStamp = parseInt(authTime);
                    const hoursDiff = (currentTime - authTimeStamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        console.log('‚è∞ Authentication expired');
                        sessionStorage.clear();
                        alert('Session expired. Please login again.');
                        window.location.replace('index.html');
                        return false;
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Authentication check error:', error);
                window.location.replace('index.html');
                return false;
            }
        }
        
        function loadSessionInfo() {
            try {
                // „Ç∑„Éä„É™„Ç™ÊÉÖÂ†±„ÇíË°®Á§∫
                const scenario = sessionStorage.getItem('selectedScenario');
                const difficulty = sessionStorage.getItem('selectedDifficulty');
                
                document.getElementById('scenarioDisplay').textContent = 
                    scenario || '„Ç∑„Éä„É™„Ç™„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
                    
                document.getElementById('difficultyDisplay').textContent = 
                    difficulty ? (difficulty === 'normal' ? '„Éé„Éº„Éû„É´' : '„Éè„Éº„Éâ') : '„Éé„Éº„Éû„É´';
                
                console.log('üìã Loaded scenario:', scenario);
                console.log('‚öôÔ∏è Loaded difficulty:', difficulty);
                
                // „Ç∑„Éä„É™„Ç™„Å´Âü∫„Å•„ÅÑ„Å¶AI„Åã„Çâ‰ºöË©±„ÇíÈñãÂßã
                if (scenario) {
                    setTimeout(() => {
                        startScenarioBasedConversation(scenario, difficulty);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('‚ùå Error loading session info:', error);
            }
        }
        
        function setupEventListeners() {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            
            // Enter „Ç≠„Éº„Åß„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÔºàShift+Enter „ÅßÊîπË°åÔºâ
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´„Éï„Ç©„Éº„Ç´„Çπ
            userInput.focus();
        }
        
        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = now - sessionStartTime;
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) {
                alert('„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            console.log('üì§ Sending message:', message);
            
            // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            addMessageToDisplay('user', 'You', message);
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
            userInput.value = '';
            
            // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            document.getElementById('sendButton').disabled = true;
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            showLoading(true);
            
            // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
            conversationHistory.push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            
            // AI„É¨„Çπ„Éù„É≥„Çπ„Çí„Ç∑„Éü„É•„É¨„Éº„ÉàÔºàÂÆüÈöõ„ÅÆAIÈÄ£Êê∫ÊôÇ„ÅØ„Åì„Åì„ÇíÂ§âÊõ¥Ôºâ
            setTimeout(() => {
                generateAIResponse(message);
            }, 1000 + Math.random() * 2000); // 1-3Áßí„ÅÆ„É©„É≥„ÉÄ„É†ÈÅÖÂª∂
        }
        
        // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíGemini„Å´ÈÄÅ‰ø°„Åó„Å¶ÂøúÁ≠î„ÇíÂèñÂæó
        async function generateAIResponse(userMessage) {
            try {
                const englishScenario = sessionStorage.getItem('englishScenario') || 'business conversation';
                const difficulty = sessionStorage.getItem('selectedDifficulty') || 'normal';
                
                console.log('ü§ñ Sending message to Gemini:', userMessage);
                
                // Gemini API„ÇíÂëº„Å≥Âá∫„ÅóÔºàÂÆüË£ÖÊôÇ„ÅØ„Åì„Åì„ÇíÂ§âÊõ¥Ôºâ
                const aiResponse = await getGeminiResponse(userMessage, englishScenario, difficulty);
                
                // AI„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                addMessageToDisplay('ai', 'AI Assistant', aiResponse);
                
                // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
                conversationHistory.push({
                    role: 'assistant',
                    content: aiResponse,
                    timestamp: new Date().toISOString()
                });
                
            } catch (error) {
                console.error('‚ùå Error getting AI response:', error);
                
                // „Ç®„É©„ÉºÊôÇ„ÅØ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂøúÁ≠î
                const fallbackResponses = [
                    "I understand your point. Could you elaborate on that further?",
                    "That's an interesting perspective. How do you think we should move forward?",
                    "Thank you for sharing that information. What would be the next steps?",
                    "I appreciate your input. Could you provide more details about your approach?",
                    "That makes sense. How do you see this impacting our objectives?"
                ];
                
                const fallbackResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                addMessageToDisplay('ai', 'AI Assistant', fallbackResponse);
                
                conversationHistory.push({
                    role: 'assistant',
                    content: fallbackResponse,
                    timestamp: new Date().toISOString()
                });
            }
            
            // UIÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            showLoading(false);
            document.getElementById('sendButton').disabled = false;
            document.getElementById('userInput').focus();
            
            // ÈÄ≤Êçó„Å®„Çπ„Ç≥„Ç¢„ÇíÊõ¥Êñ∞
            updateProgress();
        }
        
        // Gemini API„Åã„Çâ„ÅÆÂøúÁ≠î„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        async function getGeminiResponse(userMessage, scenario, difficulty) {
            // ÂÆüÈöõ„ÅÆGemini APIÂÆüË£ÖÊôÇ„ÅØ„Åì„Åì„ÇíÂ§âÊõ¥
            
            const conversationContext = conversationHistory.slice(-4); // Áõ¥Ëøë4Âõû„ÅÆ‰ºöË©±„ÇíÊñáËÑà„Å®„Åó„Å¶‰ΩøÁî®
            const difficultyLevel = difficulty === 'hard' ? 'advanced' : 'intermediate';
            
            const prompt = `You are a professional business English conversation partner helping with this scenario: "${scenario}".
            
            Conversation difficulty: ${difficultyLevel}
            Recent conversation context: ${JSON.stringify(conversationContext)}
            
            User just said: "${userMessage}"
            
            Please respond naturally as if you are engaged in this business scenario. ${difficulty === 'hard' ? 'Use sophisticated vocabulary and complex sentence structures.' : 'Keep the language professional but accessible.'}
            
            Your response should:
            1. Be contextually relevant to the scenario
            2. Move the conversation forward meaningfully
            3. Ask engaging follow-up questions when appropriate
            4. Maintain professional business tone
            5. Be 1-3 sentences long
            
            Response:`;
            
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂøúÁ≠îÁîüÊàêÔºàAPIÂÆüË£ÖÂâçÔºâ
            return generateContextualResponse(userMessage, scenario, difficulty);
        }
        
        // ÊñáËÑà„Å´Âøú„Åò„ÅüÂøúÁ≠î„ÇíÁîüÊàêÔºàGemini APIÂÆüË£ÖÂâç„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
        function generateContextualResponse(userMessage, scenario, difficulty) {
            const message = userMessage.toLowerCase();
            const scenarioLower = scenario.toLowerCase();
            
            // ‰ºöË≠∞„Ç∑„Éä„É™„Ç™„ÅÆÂøúÁ≠î
            if (scenarioLower.includes('meeting') || scenarioLower.includes('team')) {
                if (message.includes('agree') || message.includes('good point')) {
                    return "Excellent. Since we're aligned on this, let's discuss the implementation timeline. What resources do you think we'll need to make this happen effectively?";
                }
                if (message.includes('concern') || message.includes('issue')) {
                    return "I appreciate you raising that concern. Those are valid points that we need to address. How do you suggest we mitigate these risks while still moving forward?";
                }
                return "That's a valuable insight. Building on what you've said, how do you think this will impact our Q4 targets, and what adjustments might we need to make?";
            }
            
            // „Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„Ç∑„Éä„É™„Ç™„ÅÆÂøúÁ≠î
            if (scenarioLower.includes('presentation') || scenarioLower.includes('proposal')) {
                if (message.includes('question') || message.includes('clarify')) {
                    return "Great question! Let me address that directly. The key benefit here is cost reduction while improving efficiency. How important is ROI timeline in your decision-making process?";
                }
                if (message.includes('interested') || message.includes('promising')) {
                    return "I'm glad this resonates with you. The next step would be to run a pilot program with your team. What would be the ideal timeframe for implementation from your perspective?";
                }
                return "Thank you for that feedback. Based on what you've shared, it sounds like scalability is a priority for you. How large is your current operation, and what growth are you projecting?";
            }
            
            // È°ßÂÆ¢ÂØæÂøú„Ç∑„Éä„É™„Ç™„ÅÆÂøúÁ≠î
            if (scenarioLower.includes('client') || scenarioLower.includes('customer') || scenarioLower.includes('phone')) {
                if (message.includes('problem') || message.includes('issue')) {
                    return "I completely understand your frustration, and I apologize for the inconvenience this has caused. Let me look into this immediately. Can you provide me with your account number so I can review the details?";
                }
                if (message.includes('satisfied') || message.includes('resolved')) {
                    return "I'm so glad we could resolve this for you today. Is there anything else I can help you with? Also, we'd appreciate your feedback on how we handled this situation.";
                }
                return "Thank you for providing that information. I can see exactly what happened here. Let me walk you through the solution and make sure this doesn't happen again.";
            }
            
            // Èù¢Êé•„Ç∑„Éä„É™„Ç™„ÅÆÂøúÁ≠î
            if (scenarioLower.includes('interview')) {
                if (message.includes('experience') || message.includes('background')) {
                    return "That's impressive experience. I can see how that background would be valuable here. Tell me about a time when you had to lead a team through a particularly challenging situation. How did you handle it?";
                }
                if (message.includes('challenge') || message.includes('difficult')) {
                    return "That shows great problem-solving skills and leadership under pressure. How do you typically approach building consensus when team members have different opinions on the best path forward?";
                }
                return "Excellent answer. I appreciate the specific examples you've provided. What motivates you most about this type of work, and how do you see yourself contributing to our team's success?";
            }
            
            // „Éá„Éï„Ç©„É´„ÉàÂøúÁ≠î
            const responses = [
                "That's a thoughtful approach. How do you envision implementing this strategy across different departments?",
                "I see your point clearly. What metrics would you use to measure success in this initiative?",
                "Interesting perspective. What challenges do you anticipate, and how might we address them proactively?",
                "That makes complete sense. Walk me through your thinking on the timeline for this project.",
                "Great insight. How do you think our stakeholders will respond to this proposal?",
                "I appreciate that analysis. What would be the key success factors from your experience?",
                "That's a solid foundation. What additional resources or support would you need to execute this effectively?"
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function addMessageToDisplay(type, sender, message) {
            const conversationDisplay = document.getElementById('conversationDisplay');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            messageDiv.innerHTML = `
                <div class="sender">${sender}</div>
                <p>${message}</p>
            `;
            
            conversationDisplay.appendChild(messageDiv);
            
            // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏ãÈÉ®„Å´
            conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
            
            // „É°„ÉÉ„Çª„Éº„Ç∏„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
            if (type === 'user') {
                messageCount++;
                document.getElementById('messageCount').textContent = messageCount;
            }
        }
        
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = show ? 'block' : 'none';
        }
        
        function updateProgress() {
            // Á∞°ÊòìÁöÑ„Å™ÈÄ≤ÊçóË®àÁÆóÔºà„É°„ÉÉ„Çª„Éº„Ç∏Êï∞„Å´Âü∫„Å•„ÅèÔºâ
            const progress = Math.min(messageCount * 10, 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '% ÂÆå‰∫Ü';
            
            // Á∞°ÊòìÁöÑ„Å™„Çπ„Ç≥„Ç¢Ë®àÁÆó
            const accuracy = Math.floor(Math.random() * 20) + 80; // 80-100
            const fluency = Math.floor(Math.random() * 15) + 75;  // 75-90
            
            document.getElementById('accuracyScore').textContent = accuracy + '%';
            document.getElementById('fluencyScore').textContent = fluency + '%';
        }
        
        function clearConversation() {
            if (confirm('‰ºöË©±„Çí„ÇØ„É™„Ç¢„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                document.getElementById('conversationDisplay').innerHTML = `
                    <div class="message ai">
                        <div class="sender">AI Assistant</div>
                        <p>Conversation cleared. Let's start fresh! Please begin the conversation.</p>
                    </div>
                `;
                conversationHistory = [];
                messageCount = 0;
                document.getElementById('messageCount').textContent = '0';
                updateProgress();
            }
        }
        
        function getHint() {
            const hints = [
                "„Çà„ÇäÂ∞ÇÈñÄÁöÑ„Å™„Éì„Ç∏„Éç„ÇπË™ûÂΩô„Çí‰ΩøÁî®„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                "Áõ∏Êâã„Å∏„ÅÆË≥™Âïè„ÇíÊäï„Åí„Åã„Åë„Å¶„ÄÅÁ©çÊ•µÁöÑ„Å™ÂßøÂã¢„ÇíÁ§∫„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
                "„ÄåFurthermore„Äç„ÇÑ„ÄåIn addition„Äç„Å™„Å©„ÅÆÊé•Á∂öË©û„Çí‰Ωø„Å£„Å¶„ÄÅ„Ç¢„Ç§„Éá„Ç¢„ÇíÁπã„Åí„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                "Áõ∏Êâã„ÅÆÁô∫Ë®Ä„ÇíË™ç„ÇÅ„Çã„Åì„Å®„Åß„ÄÅ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É™„Çπ„Éã„É≥„Ç∞„ÇíÂÆüË∑µ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
                "ÂÖ∑‰ΩìÁöÑ„Å™Êï∞Â≠ó„ÄÅÊó•‰ªò„ÄÅ‰æã„Çí‰Ωø„Å£„Å¶„Çà„ÇäÊòéÁ¢∫„Å´Ë°®Áèæ„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
            ];
            
            const randomHint = hints[Math.floor(Math.random() * hints.length)];
            alert('üí° „Éí„É≥„Éà: ' + randomHint);
        }
        
        function requestFeedback() {
            if (conversationHistory.length === 0) {
                alert('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Çí„É™„ÇØ„Ç®„Çπ„Éà„Åô„ÇãÂâç„Å´„ÄÅ„Åæ„Åö‰ºöË©±„ÇíÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            alert('üìù „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅØ„Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫ÜÊôÇ„Å´Êèê‰æõ„Åï„Çå„Åæ„Åô„ÄÇÁ∑¥Áøí„ÇíÁ∂ö„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
        }
        
        function finishSession() {
            if (confirm('„Åì„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁµÇ‰∫Ü„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                // „Çª„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„Çø„Çí‰øùÂ≠ò
                const sessionData = {
                    scenario: sessionStorage.getItem('selectedScenario'),
                    difficulty: sessionStorage.getItem('selectedDifficulty'),
                    messageCount: messageCount,
                    conversationHistory: conversationHistory,
                    sessionDuration: new Date() - sessionStartTime
                };
                
                sessionStorage.setItem('sessionData', JSON.stringify(sessionData));
                
                // ÊúÄÁµÇ„É¨„Éù„Éº„Éà„Éö„Éº„Ç∏„Å´ÈÅ∑ÁßªÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
                window.location.href = 'final-report.html';
            }
        }
        
        function restartSession() {
            if (confirm('„Åì„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„Çí„ÇÑ„ÇäÁõ¥„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                window.location.reload();
            }
        }
        
        function goBack() {
            if (confirm('Êàª„Å£„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºüÁèæÂú®„ÅÆÈÄ≤Êçó„ÅØÂ§±„Çè„Çå„Åæ„Åô„ÄÇ')) {
                window.location.href = 'difficulty.html';
            }
        }
        
        function logout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                sessionStorage.clear();
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                window.location.replace('index.html');
            }
        }
        
        // „Ç∑„Éä„É™„Ç™„Å´Âü∫„Å•„ÅÑ„Å¶AI„Åã„Çâ‰ºöË©±„ÇíÈñãÂßã„Åô„ÇãÈñ¢Êï∞
        function startScenarioBasedConversation(scenario, difficulty) {
            console.log('üé≠ Starting scenario-based conversation');
            console.log('üìù Original scenario (Japanese):', scenario);
            
            // ‰ºöË©±Ë°®Á§∫„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
            document.getElementById('conversationDisplay').innerHTML = '';
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            addMessageToDisplay('ai', 'AI Assistant', 'Translating scenario and preparing conversation...');
            
            // „Ç∑„Éä„É™„Ç™„ÇíËã±Ë™û„Å´ÁøªË®≥„Åó„Å¶Gemini„Åã„Çâ‰ºöË©±„ÇíÈñãÂßã
            translateScenarioAndStartConversation(scenario, difficulty);
        }
        
        // „Ç∑„Éä„É™„Ç™„ÇíËã±Ë™û„Å´ÁøªË®≥„Åó„Å¶Gemini„Åß‰ºöË©±ÈñãÂßã
        async function translateScenarioAndStartConversation(japaneseScenario, difficulty) {
            try {
                console.log('üåê Translating scenario to English...');
                
                // Êó•Êú¨Ë™û„Ç∑„Éä„É™„Ç™„ÇíËã±Ë™û„Å´ÁøªË®≥
                const englishScenario = await translateJapaneseToEnglish(japaneseScenario);
                console.log('‚úÖ Translated scenario (English):', englishScenario);
                
                // ÁøªË®≥„Åï„Çå„Åü„Ç∑„Éä„É™„Ç™„Çí„Çª„ÉÉ„Ç∑„Éß„É≥„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                sessionStorage.setItem('englishScenario', englishScenario);
                
                // Gemini„Å´‰ºöË©±ÈñãÂßã„Çí‰æùÈ†º
                const openingMessage = await getGeminiOpeningMessage(englishScenario, difficulty);
                
                // ‰ºöË©±Ë°®Á§∫„Çí„ÇØ„É™„Ç¢„Åó„Å¶Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                document.getElementById('conversationDisplay').innerHTML = '';
                addMessageToDisplay('ai', 'AI Assistant', openingMessage);
                
                // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
                conversationHistory.push({
                    role: 'assistant',
                    content: openingMessage,
                    timestamp: new Date().toISOString(),
                    scenario: englishScenario
                });
                
            } catch (error) {
                console.error('‚ùå Error in translation/conversation start:', error);
                
                // „Ç®„É©„ÉºÊôÇ„ÅØ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                document.getElementById('conversationDisplay').innerHTML = '';
                const fallbackMessage = generateScenarioOpening(japaneseScenario, difficulty);
                addMessageToDisplay('ai', 'AI Assistant', fallbackMessage);
                
                conversationHistory.push({
                    role: 'assistant',
                    content: fallbackMessage,
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        // Êó•Êú¨Ë™û„ÇíËã±Ë™û„Å´ÁøªË®≥„Åô„ÇãÈñ¢Êï∞
        async function translateJapaneseToEnglish(japaneseText) {
            // Á∞°ÊòìÁöÑ„Å™ÁøªË®≥„É≠„Ç∏„ÉÉ„ÇØÔºàÂÆüÈöõ„ÅÆAPI‰ΩøÁî®ÊôÇ„ÅØ„Åì„Åì„ÇíÂ§âÊõ¥Ôºâ
            const translationMap = {
                // ‰ºöË≠∞Èñ¢ÈÄ£
                '„ÉÅ„Éº„É†„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞': 'team meeting',
                '„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞': 'meeting',
                '‰ºöË≠∞': 'meeting',
                'ÂõõÂçäÊúüÊ•≠Á∏æ': 'quarterly results',
                'Êà¶Áï•Ë®àÁîª': 'strategic planning',
                'Âè∏‰ºö': 'leading',
                'Âè∏‰ºöÈÄ≤Ë°å': 'facilitating',
                
                // „Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥Èñ¢ÈÄ£
                '„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥': 'presentation',
                '„Éó„É¨„Çº„É≥': 'presentation',
                'Êñ∞Ë£ΩÂìÅÊèêÊ°à': 'new product proposal',
                'ÊäïË≥áÂÆ∂': 'investors',
                'Ë≥™ÁñëÂøúÁ≠î': 'Q&A session',
                
                // ÈõªË©±„Éª„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÈñ¢ÈÄ£
                'ÈõªË©±ÂØæÂøú': 'phone call',
                'ÈõªË©±': 'phone call',
                '„ÇØ„É©„Ç§„Ç¢„É≥„Éà': 'client',
                'È°ßÂÆ¢': 'customer',
                '„Çµ„Éº„Éì„ÇπÂïèÈ°å': 'service issues',
                'ÂïèÈ°åËß£Ê±∫': 'problem resolution',
                
                // Èù¢Êé•Èñ¢ÈÄ£
                'Â∞±ËÅ∑Èù¢Êé•': 'job interview',
                'Èù¢Êé•': 'interview',
                '„Ç∑„Éã„Ç¢„Éû„Éç„Ç∏„É°„É≥„Éà': 'senior management',
                'ÁÆ°ÁêÜËÅ∑': 'management position',
                'Ë°åÂãïÈù¢': 'behavioral',
                'ÊäÄË°ìÈù¢': 'technical',
                
                // ‰∫§Ê∏âÈñ¢ÈÄ£
                'Â•ëÁ¥Ñ‰∫§Ê∏â': 'contract negotiation',
                '‰∫§Ê∏â': 'negotiation',
                '‰æ°Ê†ºË®≠ÂÆö': 'pricing',
                'Á¥çÊúü': 'delivery schedule',
                '„Éô„É≥„ÉÄ„Éº': 'vendor',
                
                // ‰∫∫‰∫ãË©ï‰æ°Èñ¢ÈÄ£
                '‰∫∫‰∫ãË©ï‰æ°': 'performance review',
                'Ë©ï‰æ°Èù¢Ë´á': 'performance review',
                'ÊàêÊûú': 'achievements',
                'ÊîπÂñÑÁÇπ': 'areas for improvement',
                'ËÉΩÂäõÈñãÁô∫': 'professional development'
            };
            
            let translatedText = japaneseText;
            
            // ËæûÊõ∏„Éô„Éº„Çπ„ÅÆÁøªË®≥
            for (const [japanese, english] of Object.entries(translationMap)) {
                translatedText = translatedText.replace(new RegExp(japanese, 'g'), english);
            }
            
            // Âü∫Êú¨ÁöÑ„Å™ÊñáÊßãÈÄ†„ÅÆË™øÊï¥
            if (translatedText.includes('„Å´„Å§„ÅÑ„Å¶Ë©±„ÅóÂêà') || translatedText.includes('Ë®éË≠∞')) {
                translatedText = translatedText.replace(/„Å´„Å§„ÅÑ„Å¶Ë©±„ÅóÂêà[„ÅÜ|„ÅÑ|„Å£]/, 'discussion about');
                translatedText = translatedText.replace(/Ë®éË≠∞/, 'discussion');
            }
            
            if (translatedText.includes('„Å®„ÅÆ') || translatedText.includes('„Å´ÂØæ„Åó„Å¶')) {
                translatedText = translatedText.replace(/„Å®„ÅÆ/, 'with');
                translatedText = translatedText.replace(/„Å´ÂØæ„Åó„Å¶/, 'regarding');
            }
            
            console.log('üîÑ Translation result:', translatedText);
            return translatedText;
        }
        
        // Gemini„Åã„ÇâÈñãÂßã„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        async function getGeminiOpeningMessage(englishScenario, difficulty) {
            // ÂÆüÈöõ„ÅÆGemini API‰ΩøÁî®ÊôÇ„ÅØ„Åì„Åì„ÇíÂÆüË£Ö
            // ÁèæÂú®„ÅØ„Éá„É¢Áî®„ÅÆÂøúÁ≠î„ÇíËøî„Åô
            
            const difficultyLevel = difficulty === 'hard' ? 'advanced' : 'intermediate';
            
            const prompt = `You are a business English conversation partner. Start a realistic ${difficultyLevel} level business conversation based on this scenario: "${englishScenario}". 
            
            Please:
            1. Take the initiative and start the conversation naturally
            2. Set the appropriate business context
            3. Ask an engaging question to get the conversation flowing
            4. Use professional but approachable language
            5. Make it feel like a real business situation
            
            Begin the conversation now:`;
            
            // Gemini API„ÅÆ‰ª£„Çè„Çä„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂøúÁ≠î
            return generateGeminiStyleOpening(englishScenario, difficulty);
        }
        
        // Gemini„Çπ„Çø„Ç§„É´„ÅÆÈñãÂßã„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîüÊàêÔºàAPIÂÆüË£ÖÂâç„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
        function generateGeminiStyleOpening(englishScenario, difficulty) {
            const scenario = englishScenario.toLowerCase();
            
            if (scenario.includes('meeting') || scenario.includes('team')) {
                return "Good morning, everyone! Thank you for joining today's meeting. I've reviewed the agenda, and we have some important topics to discuss regarding our recent performance and upcoming initiatives. Before we dive in, I'd like to hear your thoughts on our current challenges. What do you see as our main priorities moving forward?";
            }
            
            if (scenario.includes('presentation') || scenario.includes('proposal')) {
                return "Thank you for taking the time to meet with me today. I'm excited to share this proposal with you, as I believe it addresses some key opportunities in your market. Before I begin the formal presentation, could you tell me about your current priorities and what success looks like for your organization this quarter?";
            }
            
            if (scenario.includes('phone') || scenario.includes('client') || scenario.includes('customer')) {
                return "Good afternoon, and thank you for calling. I understand you have some concerns about our service, and I want to make sure we address them thoroughly today. Could you walk me through what happened and how this has impacted your operations? I'm here to find the best solution for you.";
            }
            
            if (scenario.includes('interview')) {
                return "Welcome! It's great to meet you, and thank you for your interest in this position. I've had a chance to review your background, and I'm impressed with your experience. Let's start with you telling me what attracted you to this role and how you see yourself contributing to our team's success.";
            }
            
            if (scenario.includes('negotiation') || scenario.includes('contract')) {
                return "I appreciate you taking the time to meet today to discuss this partnership opportunity. I've reviewed your proposal, and there are definitely some areas where I think we can find mutual benefit. However, I'd like to discuss a few aspects of the terms. What's most important to you in structuring this agreement?";
            }
            
            if (scenario.includes('performance') || scenario.includes('review')) {
                return "Thanks for setting aside time for our review today. I've been looking forward to this conversation because I've observed some really positive developments in your work lately. Let's start by discussing your perspective on this period - what do you feel went particularly well, and where do you see opportunities for growth?";
            }
            
            // „Éá„Éï„Ç©„É´„ÉàÂøúÁ≠î
            return `I'm ready to engage in our business scenario: "${englishScenario}". Let me set the professional context for our discussion. This is an important business interaction, so I want to make sure we approach it strategically. What's your initial assessment of the situation, and how do you think we should proceed?`;
        }
        
        // „Ç∑„Éä„É™„Ç™„Å´Âü∫„Å•„ÅÑ„ÅüÈñãÂßã„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîüÊàê
        function generateScenarioOpening(scenario, difficulty) {
            const lowerScenario = scenario.toLowerCase();
            
            // „ÉÅ„Éº„É†„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Èñ¢ÈÄ£
            if (lowerScenario.includes('meeting') || lowerScenario.includes('„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞') || lowerScenario.includes('‰ºöË≠∞')) {
                return "Good morning everyone! Thank you for joining today's meeting. I've called this meeting to discuss our quarterly results and plan our strategy for the upcoming quarter. Let's start by reviewing the key performance indicators from last quarter. What are your initial thoughts on our performance?";
            }
            
            // „Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥Èñ¢ÈÄ£
            if (lowerScenario.includes('presentation') || lowerScenario.includes('„Éó„É¨„Çº„É≥') || lowerScenario.includes('ÊèêÊ°à')) {
                return "Good afternoon, and thank you for taking the time to meet with us today. I'm excited to present our new product proposal that I believe will significantly impact your business growth. Before we dive into the details, could you tell me a bit about your current challenges in this market segment?";
            }
            
            // ÈõªË©±„Éª„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂØæÂøúÈñ¢ÈÄ£
            if (lowerScenario.includes('phone') || lowerScenario.includes('client') || lowerScenario.includes('ÈõªË©±') || lowerScenario.includes('„ÇØ„É©„Ç§„Ç¢„É≥„Éà')) {
                return "Hello, thank you for calling. I understand you're experiencing some service issues, and I want to make sure we resolve this matter promptly. Could you please describe the specific problem you're facing so I can better assist you?";
            }
            
            // Èù¢Êé•Èñ¢ÈÄ£
            if (lowerScenario.includes('interview') || lowerScenario.includes('Èù¢Êé•')) {
                return "Good morning! Welcome to our company. I'm pleased to meet with you today regarding the senior management position. I've reviewed your resume and I'm impressed with your background. Let's start with you telling me about your leadership experience and what motivates you in a management role.";
            }
            
            // ‰∫§Ê∏âÈñ¢ÈÄ£
            if (lowerScenario.includes('negotiation') || lowerScenario.includes('‰∫§Ê∏â') || lowerScenario.includes('Â•ëÁ¥Ñ')) {
                return "Thank you for meeting with us today to discuss the contract terms. We've reviewed your initial proposal, and while we appreciate the comprehensive scope of services, we'd like to discuss some aspects of the pricing structure and delivery timeline. Shall we start with the pricing model?";
            }
            
            // ‰∫∫‰∫ãË©ï‰æ°Èñ¢ÈÄ£
            if (lowerScenario.includes('performance') || lowerScenario.includes('review') || lowerScenario.includes('Ë©ï‰æ°') || lowerScenario.includes('‰∫∫‰∫ã')) {
                return "Hi there! Thanks for setting aside time for our performance review meeting. I've been looking forward to discussing your achievements this year and exploring opportunities for your professional development. Let's start by reflecting on your key accomplishments. What would you say were your biggest successes this year?";
            }
            
            // „Ç´„Çπ„Çø„Éû„Éº„Çµ„Éº„Éì„ÇπÈñ¢ÈÄ£
            if (lowerScenario.includes('customer service') || lowerScenario.includes('„Ç´„Çπ„Çø„Éû„Éº') || lowerScenario.includes('È°ßÂÆ¢ÂØæÂøú')) {
                return "Hello! Thank you for contacting our customer service team. I'm here to help resolve any issues you may be experiencing with our products or services. Could you please provide me with your account information and describe the nature of your inquiry?";
            }
            
            // ‰∏ÄËà¨ÁöÑ„Å™„Éì„Ç∏„Éç„Çπ„Ç∑„Éä„É™„Ç™Ôºà„Éá„Éï„Ç©„É´„ÉàÔºâ
            return `Good morning! I'm ready to engage in our business scenario: "${scenario}". Let me set the context and begin our professional interaction. How would you like to approach this situation, and what are your initial thoughts on how we should proceed?`;
        }
        
        // Èü≥Â£∞Ë™çË≠ò„ÅÆÂàùÊúüÂåñ
        function initializeSpeechRecognition() {
            console.log('üé§ Initializing speech recognition...');
            
            // „Éñ„É©„Ç¶„Ç∂„Çµ„Éù„Éº„Éà„ÉÅ„Çß„ÉÉ„ÇØ
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.log('‚ùå Speech recognition not supported');
                document.getElementById('voiceButton').disabled = true;
                document.getElementById('voiceButton').textContent = 'üö´ Èü≥Â£∞ÈùûÂØæÂøú';
                return;
            }
            
            // Èü≥Â£∞Ë™çË≠ò„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            // Ë®≠ÂÆö
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            recognition.onstart = function() {
                console.log('üé§ Speech recognition started');
                isRecording = true;
                updateVoiceButton();
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('üé§ Speech recognized:', transcript);
                
                // ÁµêÊûú„Çí„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´ÊåøÂÖ•
                const userInput = document.getElementById('userInput');
                userInput.value = transcript;
                userInput.focus();
            };
            
            recognition.onerror = function(event) {
                console.error('üé§ Speech recognition error:', event.error);
                isRecording = false;
                updateVoiceButton();
                
                let errorMessage;
                switch(event.error) {
                    case 'no-speech':
                        errorMessage = 'Èü≥Â£∞„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                        break;
                    case 'audio-capture':
                        errorMessage = '„Éû„Ç§„ÇØ„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì„ÄÇÊ®©Èôê„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                        break;
                    case 'not-allowed':
                        errorMessage = '„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                        break;
                    case 'network':
                        errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';
                        break;
                    default:
                        errorMessage = 'Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + event.error;
                }
                alert('üé§ ' + errorMessage);
            };
            
            recognition.onend = function() {
                console.log('üé§ Speech recognition ended');
                isRecording = false;
                updateVoiceButton();
            };
            
            console.log('‚úÖ Speech recognition initialized successfully');
        }
        
        // Èü≥Â£∞ÂÖ•Âäõ„ÅÆ„Éà„Ç∞„É´
        function toggleVoiceInput() {
            if (!recognition) {
                alert('Èü≥Â£∞Ë™çË≠ò„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            if (isRecording) {
                console.log('üé§ Stopping speech recognition');
                recognition.stop();
            } else {
                console.log('üé§ Starting speech recognition');
                try {
                    recognition.start();
                } catch (error) {
                    console.error('üé§ Failed to start recognition:', error);
                    alert('Èü≥Â£∞Ë™çË≠ò„ÇíÈñãÂßã„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Éû„Ç§„ÇØ„ÅÆÊ®©Èôê„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            }
        }
        
        // Èü≥Â£∞„Éú„Çø„É≥„ÅÆË°®Á§∫Êõ¥Êñ∞
        function updateVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            if (isRecording) {
                voiceButton.textContent = '‚èπÔ∏è ÂÅúÊ≠¢';
                voiceButton.classList.add('voice-recording');
            } else {
                voiceButton.textContent = 'üé§ Èü≥Â£∞ÂÖ•Âäõ';
                voiceButton.classList.remove('voice-recording');
            }
        }
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', function(e) {
            console.error('‚ùå Page error:', e.error);
        });
        
        // „Éö„Éº„Ç∏„ÇíÈõ¢„Çå„ÇãÂâç„ÅÆÁ¢∫Ë™ç
        window.addEventListener('beforeunload', function(e) {
            if (messageCount > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        console.log('üìú Conversation script loaded');
    </script>
</body>
</html>