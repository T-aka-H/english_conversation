<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語コソ練アプリ - 英会話練習</title>
    <link rel="icon" href="data:,">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #4A90E2;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .session-details {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .session-item {
            text-align: center;
        }

        .session-item .label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .session-item .value {
            font-size: 16px;
            font-weight: 600;
            color: #4A90E2;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-right: auto;
        }

        .message .role {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message .content {
            font-size: 15px;
            line-height: 1.5;
        }

        .message .timestamp {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 8px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .user-input {
            width: 100%;
            min-height: 60px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .user-input:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.3);
        }

        .user-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .voice-button {
            padding: 15px;
            background: linear-gradient(135deg, #28a745, #20a042);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            width: 60px;
            height: 60px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        .voice-button.recording {
            background: linear-gradient(135deg, #dc3545, #c82333);
            animation: pulse 1.5s infinite;
        }

        .voice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .send-button:hover {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 144, 226, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .control-button {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .control-button.end-session {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
        }

        .control-button.end-session:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 20px;
            max-width: 80%;
        }

        .typing-indicator .dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: #4A90E2;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .input-guide {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .input-guide strong {
            color: #4A90E2;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }

        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 167, 69, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            display: none;
        }

        .status-message.error {
            background: rgba(220, 53, 69, 0.95);
        }

        .status-message.warning {
            background: rgba(255, 193, 7, 0.95);
            color: black;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; transform: scale(1); }
            30% { opacity: 1; transform: scale(1.2); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .session-details {
                flex-direction: column;
                gap: 15px;
            }
            
            .input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-buttons {
                flex-direction: row;
                justify-content: center;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .control-button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div id="statusMessage" class="status-message"></div>
    
    <div class="container">
        <div class="header">
            <h1>英語コソ練アプリ</h1>
        </div>

        <div class="session-info">
            <div class="session-details">
                <div class="session-item">
                    <div class="label">シナリオ</div>
                    <div class="value" id="scenarioName">読み込み中...</div>
                </div>
                <div class="session-item">
                    <div class="label">難易度</div>
                    <div class="value" id="difficultyLevel">--</div>
                </div>
                <div class="session-item">
                    <div class="label">経過時間</div>
                    <div class="value" id="sessionTimer">00:00</div>
                </div>
                <div class="session-item">
                    <div class="label">メッセージ数</div>
                    <div class="value" id="messageCount">0</div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai">
                <div class="role">AI Assistant</div>
                <div class="content" id="initialMessage">会話を初期化中...</div>
                <div class="timestamp" id="initialTimestamp"></div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="role">AI Assistant</div>
                <div class="dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="userInput" 
                        class="user-input" 
                        placeholder="英語でメッセージを入力してください... (音声入力も可能)"
                        rows="3"
                    ></textarea>
                </div>
                <div class="input-buttons">
                    <button id="voiceButton" class="voice-button" title="音声入力">
                        🎤
                    </button>
                    <button id="sendButton" class="send-button">
                        送信
                    </button>
                </div>
            </div>
            
            <div class="input-guide">
                <p><strong>💡 練習のコツ:</strong></p>
                <p>• 自然な英語表現を心がけましょう</p>
                <p>• 具体的な内容で会話を深めましょう</p>
                <p>• 🎤ボタンで音声入力も活用できます</p>
            </div>
        </div>

        <div class="control-buttons">
            <button class="control-button" onclick="pauseSession()">
                一時停止
            </button>
            <button class="control-button" onclick="saveProgress()">
                進捗保存
            </button>
            <button class="control-button end-session" onclick="endSession()">
                セッション終了
            </button>
        </div>

        <div class="footer">
            <p>developed by T.H.</p>
        </div>
    </div>

    <script>
        console.log('💬 Conversation page loaded');

        // グローバル変数
        let conversationHistory = [];
        let sessionStartTime = Date.now();
        let sessionTimer = null;
        let messageCounter = 0;
        let currentScenario = 'ビジネス英会話練習';
        let currentDifficulty = 'normal';
        let recognition = null;
        let isRecording = false;

        // ページ読み込み完了時の処理
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM Content Loaded');
            
            try {
                // セッション情報を読み込み
                loadSessionInfo();
                
                // セッション時間を開始
                startSessionTimer();
                
                // イベントリスナーを設定
                setupEventListeners();
                
                // 初期化完了メッセージ
                showStatus('アプリが正常に初期化されました', 'success');
                
                // 音声認識を初期化（遅延実行）
                setTimeout(initializeSpeechRecognition, 1000);
                
                console.log('✅ Conversation session initialized');
                
            } catch (error) {
                console.error('❌ Initialization error:', error);
                showStatus('初期化エラー: ' + error.message, 'error');
            }
        });

        // ステータスメッセージ表示
        function showStatus(message, type = 'success') {
            const statusElement = document.getElementById('statusMessage');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status-message ${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // セッション情報読み込み
        function loadSessionInfo() {
            try {
                console.log('📋 Loading session info...');
                
                // UIに反映
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = getDifficultyLabel(currentDifficulty);
                
                // 初期メッセージを生成
                generateInitialMessage();
                
                console.log('✅ Session info loaded successfully');
                
            } catch (error) {
                console.error('❌ Error loading session info:', error);
                showStatus('セッション情報の読み込みに失敗しました', 'error');
                
                // フォールバック処理
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = '中級';
                generateInitialMessage();
            }
        }

        // 難易度ラベル取得
        function getDifficultyLabel(difficulty) {
            const labels = {
                'easy': '初級',
                'normal': '中級',
                'hard': '上級'
            };
            return labels[difficulty] || '中級';
        }

        // 初期メッセージ生成
        function generateInitialMessage() {
            const initialMessage = "Hello! I'm excited to practice English conversation with you today. Let's have a great discussion about our business scenario. How would you like to begin?";
            
            // 初期メッセージを表示
            document.getElementById('initialMessage').textContent = initialMessage;
            document.getElementById('initialTimestamp').textContent = new Date().toLocaleTimeString('ja-JP');
            
            // 会話履歴に追加
            conversationHistory.push({
                role: 'ai',
                content: initialMessage,
                timestamp: new Date().toISOString()
            });
            
            console.log('💬 Initial message generated');
        }

        // セッションタイマー開始
        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // イベントリスナー設定
        function setupEventListeners() {
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const voiceButton = document.getElementById('voiceButton');
            
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
            
            if (userInput) {
                userInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            if (voiceButton) {
                voiceButton.addEventListener('click', toggleVoiceInput);
            }
            
            console.log('🎧 Event listeners set up');
        }

        // メッセージ送信
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) {
                showStatus('メッセージを入力してください', 'warning');
                return;
            }
            
            console.log('📤 Sending message:', message);
            
            // ユーザーメッセージを追加
            addMessage('user', message);
            
            // 入力をクリア
            userInput.value = '';
            
            // 送信ボタンを無効化
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.disabled = true;
            }
            
            // タイピングインジケーターを表示
            showTypingIndicator();
            
            // AIの応答を生成（遅延付き）
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                hideTypingIndicator();
                addMessage('ai', aiResponse);
                
                if (sendButton) {
                    sendButton.disabled = false;
                }
                userInput.focus();
            }, 1500 + Math.random() * 1000);
        }

        // メッセージ追加
        function addMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const roleSpan = document.createElement('div');
            roleSpan.className = 'role';
            roleSpan.textContent = role === 'user' ? 'You' : 'AI Assistant';
            
            const contentSpan = document.createElement('div');
            contentSpan.className = 'content';
            contentSpan.textContent = content;
            
            const timestampSpan = document.createElement('div');
            timestampSpan.className = 'timestamp';
            timestampSpan.textContent = new Date().toLocaleTimeString('ja-JP');
            
            messageDiv.appendChild(roleSpan);
            messageDiv.appendChild(contentSpan);
            messageDiv.appendChild(timestampSpan);
            
            // 初期メッセージを削除（最初のメッセージの場合）
            if (messageCounter === 0) {
                const initialMessage = chatContainer.querySelector('.message.ai');
                if (initialMessage && initialMessage.querySelector('#initialMessage')) {
                    chatContainer.removeChild(initialMessage);
                }
            }
            
            chatContainer.appendChild(messageDiv);
            
            // スクロールを最下部に
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // メッセージカウンターを更新
            messageCounter++;
            document.getElementById('messageCount').textContent = messageCounter;
            
            // 会話履歴に追加
            conversationHistory.push({
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            });
            
            console.log(`✅ Message added: ${role} - ${content.substring(0, 50)}...`);
        }

        // タイピングインジケーター表示
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'block';
                
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // タイピングインジケーター非表示
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        }

        // AI応答生成
        function generateAIResponse(userMessage) {
            const responses = [
                "That's a great point! I think we should definitely consider that approach. What do you think the timeline would look like for implementation?",
                "I appreciate you bringing that up. How do you think this aligns with our current objectives?",
                "Excellent! That could really help us move forward. Should we assign someone to look into this further?",
                "That's interesting. Could you elaborate on how you see this working in practice?",
                "I agree with your assessment. What would be the next steps to make this happen?",
                "Thank you for that question. Let me address that point specifically.",
                "That's an excellent observation. You're absolutely right to focus on that aspect.",
                "I understand your concern, and I'm here to help resolve this for you.",
                "That makes a lot of sense. How do you think we should proceed with this?",
                "You raise a good point. I hadn't considered that angle before."
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // 音声認識初期化
        function initializeSpeechRecognition() {
            console.log('🎤 Initializing speech recognition...');
            
            try {
                // ブラウザサポート確認
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    throw new Error('音声認識がサポートされていません');
                }
                
                // 音声認識オブジェクト作成
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // 設定
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                // イベントリスナー
                recognition.onstart = function() {
                    console.log('🎤 Speech recognition started');
                    isRecording = true;
                    updateVoiceButton();
                    showStatus('音声認識開始 - 話してください', 'success');
                };
                
                recognition.onresult = function(event) {
                    console.log('🎤 Speech recognition result received');
                    
                    if (event.results && event.results.length > 0) {
                        const transcript = event.results[0][0].transcript.trim();
                        console.log('🎤 Transcript:', transcript);
                        
                        if (transcript) {
                            const userInput = document.getElementById('userInput');
                            if (userInput) {
                                const currentText = userInput.value.trim();
                                userInput.value = currentText ? currentText + ' ' + transcript : transcript;
                                userInput.focus();
                                showStatus('音声認識成功: ' + transcript, 'success');
                            }
                        }
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('🎤 Speech recognition error:', event.error);
                    isRecording = false;
                    updateVoiceButton();
                    
                    let errorMessage = '音声認識エラー';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = '音声が検出されませんでした';
                            break;
                        case 'audio-capture':
                            errorMessage = 'マイクにアクセスできません';
                            break;
                        case 'not-allowed':
                            errorMessage = 'マイクの使用が許可されていません';
                            break;
                        case 'network':
                            errorMessage = 'ネットワークエラーが発生しました';
                            break;
                        default:
                            errorMessage = `音声認識エラー: ${event.error}`;
                    }
                    
                    showStatus(errorMessage, 'error');
                };
                
                recognition.onend = function() {
                    console.log('🎤 Speech recognition ended');
                    isRecording = false;
                    updateVoiceButton();
                };
                
                console.log('✅ Speech recognition initialized successfully');
                showStatus('音声認識が利用可能です', 'success');
                
            } catch (error) {
                console.error('❌ Failed to initialize speech recognition:', error);
                
                const voiceButton = document.getElementById('voiceButton');
                if (voiceButton) {
                    voiceButton.disabled = true;
                    voiceButton.textContent = '🚫';
                    voiceButton.title = '音声認識利用不可';
                }
                
                showStatus('音声認識を初期化できませんでした', 'error');
            }
        }

        // 音声入力トグル
        function toggleVoiceInput() {
            console.log('🎤 Toggle voice input, isRecording:', isRecording);
            
            if (!recognition) {
                showStatus('音声認識が初期化されていません', 'error');
                return;
            }
            
            if (isRecording) {
                try {
                    recognition.stop();
                    isRecording = false;
                    updateVoiceButton();
                    showStatus('音声認識を停止しました', 'success');
                } catch (error) {
                    console.error('🎤 Error stopping recognition:', error);
                    isRecording = false;
                    updateVoiceButton();
                }
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('🎤 Error starting recognition:', error);
                    showStatus('音声認識の開始に失敗しました', 'error');
                }
            }
        }

        // 音声ボタン更新
        function updateVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            if (!voiceButton) return;
            
            if (isRecording) {
                voiceButton.classList.add('recording');
                voiceButton.textContent = '🔴';
                voiceButton.title = '録音中 - クリックで停止';
            } else {
                voiceButton.classList.remove('recording');
                voiceButton.textContent = '🎤';
                voiceButton.title = 'クリックで音声入力開始';
            }
        }

        // セッション一時停止
        function pauseSession() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
                showStatus('セッションを一時停止しました', 'success');
                
                // 再開ボタンに変更
                const pauseButton = event.target;
                pauseButton.textContent = '再開';
                pauseButton.onclick = resumeSession;
            }
        }

        // セッション再開
        function resumeSession() {
            startSessionTimer();
            showStatus('セッションを再開しました', 'success');
            
            // 一時停止ボタンに戻す
            const resumeButton = event.target;
            resumeButton.textContent = '一時停止';
            resumeButton.onclick = pauseSession;
        }

        // 進捗保存
        function saveProgress() {
            try {
                const progressData = {
                    conversationHistory: conversationHistory,
                    messageCount: messageCounter,
                    sessionTime: Date.now() - sessionStartTime,
                    scenario: currentScenario,
                    difficulty: currentDifficulty,
                    timestamp: new Date().toISOString()
                };
                
                // メモリ内保存（実際のアプリでは localStorage や サーバーに保存）
                console.log('💾 Progress saved:', progressData);
                showStatus('進捗を保存しました', 'success');
                
            } catch (error) {
                console.error('❌ Error saving progress:', error);
                showStatus('進捗の保存に失敗しました', 'error');
            }
        }

        // セッション終了
        function endSession() {
            if (confirm('セッションを終了しますか？')) {
                // タイマー停止
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                    sessionTimer = null;
                }
                
                // 音声認識停止
                if (recognition && isRecording) {
                    try {
                        recognition.stop();
                        isRecording = false;
                        updateVoiceButton();
                    } catch (error) {
                        console.error('Error stopping recognition:', error);
                    }
                }
                
                // 最終データ保存
                saveProgress();
                
                showStatus('セッションを終了しました。お疲れ様でした！', 'success');
                
                // セッション終了後の処理
                setTimeout(() => {
                    // ここで通常はメイン画面に戻るか、結果画面を表示
                    console.log('Session ended successfully');
                    showSessionSummary();
                }, 2000);
            }
        }

        // セッション概要表示
        function showSessionSummary() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'message ai';
                summaryDiv.innerHTML = `
                    <div class="role">Session Summary</div>
                    <div class="content">
                        <strong>🎉 セッション完了！</strong><br>
                        📝 メッセージ数: ${messageCounter}<br>
                        ⏱️ 経過時間: ${document.getElementById('sessionTimer').textContent}<br>
                        📋 シナリオ: ${currentScenario}<br>
                        💪 難易度: ${getDifficultyLabel(currentDifficulty)}<br><br>
                        お疲れ様でした！また練習しましょう。
                    </div>
                    <div class="timestamp">${new Date().toLocaleTimeString('ja-JP')}</div>
                `;
                
                chatContainer.appendChild(summaryDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // エラーハンドリング
        window.addEventListener('error', function(event) {
            console.error('❌ Global error:', event.error);
            showStatus('エラーが発生しました: ' + event.error.message, 'error');
        });

        // 未処理の Promise エラー
        window.addEventListener('unhandledrejection', function(event) {
            console.error('❌ Unhandled promise rejection:', event.reason);
            showStatus('システムエラーが発生しました', 'error');
        });

        // ページが閉じられる前の確認
        window.addEventListener('beforeunload', function(event) {
            if (messageCounter > 0) {
                event.preventDefault();
                event.returnValue = '会話データが失われます。本当に終了しますか？';
                return event.returnValue;
            }
        });

        // デバッグ情報表示（開発時のみ）
        function showDebugInfo() {
            console.log('🔍 Debug Info:', {
                messageCounter,
                conversationHistory: conversationHistory.length,
                isRecording,
                currentScenario,
                currentDifficulty,
                speechRecognitionAvailable: !!recognition,
                userAgent: navigator.userAgent
            });
        }

        // コンソールでデバッグ情報を確認できるように
        window.showDebugInfo = showDebugInfo;
        
        console.log('✅ Application fully loaded and ready');
        console.log('💡 Type showDebugInfo() in console for debug information');
    </script>
</body>
</html>