<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªã‚³ã‚½ç·´ã‚¢ãƒ—ãƒª - è‹±ä¼šè©±ç·´ç¿’</title>
    <link rel="icon" href="data:,">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹ï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã—å¯èƒ½ã«ã™ã‚‹ï¼‰
        window.toggleVoiceInput = toggleVoiceInput;
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
            overflow: hidden;
        }
        
        .header {
            background: rgba(255,255,255,0.05);
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: #4A90E2;
            margin-bottom: 5px;
            font-weight: 300;
        }
        
        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .info-item {
            background: rgba(255,255,255,0.05);
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .info-item h4 {
            color: #4A90E2;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .info-item p {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            min-height: calc(100vh - 200px);
        }
        
        .conversation-area {
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
        }
        
        .conversation-display {
            flex: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            line-height: 1.4;
        }
        
        .message.ai {
            background: rgba(74, 144, 226, 0.1);
            border-left: 3px solid #4A90E2;
        }
        
        .message.ai strong {
            color: #4A90E2;
            font-weight: 600;
        }
        
        .message.ai em {
            color: #28a745;
            font-style: normal;
            font-weight: 500;
        }
        
        .feedback-section {
            background: rgba(40, 167, 69, 0.05);
            border: 1px solid rgba(40, 167, 69, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }
        
        .conversation-section {
            background: rgba(74, 144, 226, 0.05);
            border: 1px solid rgba(74, 144, 226, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .message.user {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28a745;
            margin-left: 20px;
        }
        
        .message .sender {
            font-weight: bold;
            font-size: 12px;
            color: #4A90E2;
            margin-bottom: 5px;
        }
        
        .message.user .sender {
            color: #28a745;
        }
        
        .input-area {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .input-group {
            flex: 1;
        }
        
        .input-textarea {
            width: 100%;
            min-height: 60px;
            max-height: 120px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .input-textarea:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.2);
        }
        
        .input-textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .voice-recording {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 100px;
        }
        
        .button:hover:not(:disabled) {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.primary {
            background: linear-gradient(135deg, #28A745, #20A042);
        }
        
        .button.primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #20A042, #1E7E3A);
        }
        
        .button.secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .button.secondary:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .sidebar {
            background: rgba(255,255,255,0.03);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 30px 20px;
        }
        
        .sidebar h3 {
            color: #4A90E2;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .sidebar-section {
            margin-bottom: 25px;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28A745, #20A042);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #4A90E2;
        }
        
        .stat-label {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-top: 2px;
        }
        
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.7);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-left: 2px solid #4A90E2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-left: none;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
            
            .conversation-area {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .session-info {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .input-area {
                flex-direction: column;
            }
            
            .input-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ãƒ“ã‚¸ãƒã‚¹è‹±ä¼šè©±ç·´ç¿’</h1>
            
            <div class="session-info">
                <div class="info-item">
                    <h4>ã‚·ãƒŠãƒªã‚ª</h4>
                    <p id="scenarioDisplay">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <div class="info-item">
                    <h4>é›£æ˜“åº¦</h4>
                    <p id="difficultyDisplay">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <div class="info-item">
                    <h4>ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“</h4>
                    <p id="sessionTimer">00:00</p>
                </div>
                <div class="info-item">
                    <h4>ã‚„ã‚Šå–ã‚Šæ•°</h4>
                    <p><span id="messageCount">0</span> å›</p>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="conversation-area">
                <div class="conversation-display" id="conversationDisplay">
                    <div class="message ai">
                        <div class="sender">AI Assistant</div>
                        <p>Loading your scenario... Please wait a moment while I prepare the conversation.</p>
                    </div>
                </div>
                
                <div class="loading-indicator" id="loadingIndicator">
                    <span class="loading-spinner"></span>
                    AIãŒè€ƒãˆä¸­...
                </div>
                
                <div class="input-area">
                    <div class="input-group">
                        <textarea 
                            id="userInput" 
                            class="input-textarea"
                            placeholder="ã“ã“ã«è‹±èªã§è¿”ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                            rows="3"
                        ></textarea>
                    </div>
                    
                    <div class="input-buttons">
                        <button id="voiceButton" class="button secondary" onclick="toggleVoiceInput()">
                            ğŸ¤ éŸ³å£°å…¥åŠ›
                        </button>
                        <button id="sendButton" class="button primary" onclick="sendMessage()">
                            é€ä¿¡
                        </button>
                        <button class="button secondary" onclick="clearConversation()">
                            ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>ğŸ“Š é€²æ—</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.7);">
                        <span id="progressText">0% å®Œäº†</span>
                    </p>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="accuracyScore">--</div>
                            <div class="stat-label">æ­£ç¢ºæ€§</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="fluencyScore">--</div>
                            <div class="stat-label">æµæš¢æ€§</div>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3>âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                    <div class="quick-actions">
                        <button class="button secondary" onclick="getHint()">
                            ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
                        </button>
                        <button class="button secondary" onclick="requestFeedback()">
                            ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                        </button>
                        <button class="button secondary" onclick="finishSession()">
                            âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
                        </button>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3>âš™ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡</h3>
                    <div class="quick-actions">
                        <button class="button secondary" onclick="restartSession()">
                            ğŸ”„ ã‚„ã‚Šç›´ã—
                        </button>
                        <button class="button secondary" onclick="goBack()">
                            â† æˆ»ã‚‹
                        </button>
                        <button class="button secondary" onclick="logout()">
                            ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let messageCount = 0;
        let sessionStartTime = new Date();
        let timerInterval;
        let conversationHistory = [];
        let recognition = null;
        let isRecording = false;
        
        console.log('ğŸ’¬ Conversation page loaded');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ” Initializing conversation session...');
            
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (!checkAuthentication()) {
                return;
            }
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
            loadSessionInfo();
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
            startSessionTimer();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupEventListeners();
            
            // éŸ³å£°èªè­˜ã‚’åˆæœŸåŒ–
            initializeSpeechRecognition();
            
            console.log('âœ… Conversation session initialized');
        });
        
        function checkAuthentication() {
            try {
                const isAuthenticated = sessionStorage.getItem('isAuthenticated');
                const authTime = sessionStorage.getItem('authTime');
                
                if (!isAuthenticated) {
                    console.log('âŒ No authentication found');
                    alert('Please login first.');
                    window.location.replace('index.html');
                    return false;
                }
                
                // èªè¨¼ã®æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ24æ™‚é–“ï¼‰
                if (authTime) {
                    const currentTime = new Date().getTime();
                    const authTimeStamp = parseInt(authTime);
                    const hoursDiff = (currentTime - authTimeStamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        console.log('â° Authentication expired');
                        sessionStorage.clear();
                        alert('Session expired. Please login again.');
                        window.location.replace('index.html');
                        return false;
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('âŒ Authentication check error:', error);
                window.location.replace('index.html');
                return false;
            }
        }
        
        function loadSessionInfo() {
            try {
                // ã‚·ãƒŠãƒªã‚ªæƒ…å ±ã‚’è¡¨ç¤º
                const scenario = sessionStorage.getItem('selectedScenario');
                const difficulty = sessionStorage.getItem('selectedDifficulty');
                
                document.getElementById('scenarioDisplay').textContent = 
                    scenario || 'ã‚·ãƒŠãƒªã‚ªãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“';
                    
                document.getElementById('difficultyDisplay').textContent = 
                    difficulty ? (difficulty === 'normal' ? 'ãƒãƒ¼ãƒãƒ«' : 'ãƒãƒ¼ãƒ‰') : 'ãƒãƒ¼ãƒãƒ«';
                
                console.log('ğŸ“‹ Loaded scenario:', scenario);
                console.log('âš™ï¸ Loaded difficulty:', difficulty);
                
                // ã‚·ãƒŠãƒªã‚ªã«åŸºã¥ã„ã¦AIã‹ã‚‰ä¼šè©±ã‚’é–‹å§‹
                if (scenario) {
                    setTimeout(() => {
                        startScenarioBasedConversation(scenario, difficulty);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('âŒ Error loading session info:', error);
            }
        }
        
        function setupEventListeners() {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            
            // Enter ã‚­ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆShift+Enter ã§æ”¹è¡Œï¼‰
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            userInput.focus();
        }
        
        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = now - sessionStartTime;
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('ğŸ“¤ Sending message:', message);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessageToDisplay('user', 'You', message);
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            userInput.value = '';
            
            // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            document.getElementById('sendButton').disabled = true;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            showLoading(true);
            
            // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
            conversationHistory.push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            
            // AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆå®Ÿéš›ã®AIé€£æºæ™‚ã¯ã“ã“ã‚’å¤‰æ›´ï¼‰
            setTimeout(() => {
                generateAIResponse(message);
            }, 1000 + Math.random() * 2000); // 1-3ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ é…å»¶
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Geminiã«é€ä¿¡ã—ã¦å¿œç­”ã‚’å–å¾—
        async function generateAIResponse(userMessage) {
            try {
                const englishScenario = sessionStorage.getItem('englishScenario') || 'business conversation';
                const difficulty = sessionStorage.getItem('selectedDifficulty') || 'normal';
                
                console.log('ğŸ¤– Sending message to Gemini:', userMessage);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‹±èªã‚’ã¾ãšè©•ä¾¡
                const feedback = generateEnglishFeedback(userMessage, difficulty);
                
                // ä¼šè©±ã®å¿œç­”ã‚’ç”Ÿæˆ
                const conversationResponse = await getGeminiResponse(userMessage, englishScenario, difficulty);
                
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä»˜ãã®å¿œç­”ã‚’ä½œæˆ
                const fullResponse = createFeedbackResponse(feedback, conversationResponse);
                
                // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                addMessageToDisplay('ai', 'AI Assistant', fullResponse);
                
                // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
                conversationHistory.push({
                    role: 'assistant',
                    content: fullResponse,
                    timestamp: new Date().toISOString(),
                    feedback: feedback
                });
                
            } catch (error) {
                console.error('âŒ Error getting AI response:', error);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
                const fallbackResponse = "I understand your point. Could you elaborate on that further?";
                addMessageToDisplay('ai', 'AI Assistant', fallbackResponse);
                
                conversationHistory.push({
                    role: 'assistant',
                    content: fallbackResponse,
                    timestamp: new Date().toISOString()
                });
            }
            
            // UIçŠ¶æ…‹ã‚’æ›´æ–°
            showLoading(false);
            document.getElementById('sendButton').disabled = false;
            document.getElementById('userInput').focus();
            
            // é€²æ—ã¨ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
            updateProgress();
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‹±èªã«å¯¾ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆ
        function generateEnglishFeedback(userMessage, difficulty) {
            const message = userMessage.trim();
            const wordCount = message.split(' ').length;
            const sentences = message.split(/[.!?]+/).filter(s => s.trim().length > 0);
            
            let feedback = {
                positive: [],
                improvements: [],
                score: 0
            };
            
            // åŸºæœ¬çš„ãªè©•ä¾¡åŸºæº–
            let score = 70; // ãƒ™ãƒ¼ã‚¹ã‚¹ã‚³ã‚¢
            
            // ãƒã‚¸ãƒ†ã‚£ãƒ–ãªç‚¹ã®è©•ä¾¡
            if (wordCount >= 10) {
                feedback.positive.push("Good detail in your response");
                score += 5;
            }
            
            if (message.includes('I think') || message.includes('I believe') || message.includes('In my opinion')) {
                feedback.positive.push("Nice use of opinion expressions");
                score += 3;
            }
            
            if (message.includes('However') || message.includes('Therefore') || message.includes('Furthermore') || message.includes('Moreover')) {
                feedback.positive.push("Excellent use of transition words");
                score += 5;
            }
            
            if (/[A-Z]/.test(message.charAt(0)) && /[.!?]$/.test(message)) {
                feedback.positive.push("Proper capitalization and punctuation");
                score += 2;
            }
            
            // ãƒ“ã‚¸ãƒã‚¹è¡¨ç¾ã®è©•ä¾¡
            const businessPhrases = [
                'would like to', 'I appreciate', 'moving forward', 'next steps',
                'follow up', 'let me know', 'schedule a meeting', 'discuss further',
                'coordinate with', 'keep in mind', 'take into consideration'
            ];
            
            businessPhrases.forEach(phrase => {
                if (message.toLowerCase().includes(phrase)) {
                    feedback.positive.push("Professional business language");
                    score += 3;
                    return; // ä¸€åº¦ã ã‘åŠ ç‚¹
                }
            });
            
            // æ”¹å–„ç‚¹ã®æŒ‡æ‘˜
            if (wordCount < 5) {
                feedback.improvements.push("Try to provide more detailed responses");
                score -= 5;
            }
            
            if (!message.includes('.') && !message.includes('!') && !message.includes('?')) {
                feedback.improvements.push("Remember to end sentences with proper punctuation");
                score -= 3;
            }
            
            if (!/[A-Z]/.test(message.charAt(0))) {
                feedback.improvements.push("Start sentences with capital letters");
                score -= 2;
            }
            
            // é›£æ˜“åº¦ã«å¿œã˜ãŸè©•ä¾¡èª¿æ•´
            if (difficulty === 'hard') {
                if (!message.includes(',')) {
                    feedback.improvements.push("Consider using more complex sentence structures with commas");
                    score -= 3;
                }
                
                if (sentences.length < 2) {
                    feedback.improvements.push("Try to use multiple sentences for more sophisticated expression");
                    score -= 5;
                }
                
                if (!/\b(sophisticated|comprehensive|substantial|significant|considerable)\b/i.test(message)) {
                    feedback.improvements.push("Use more advanced vocabulary to demonstrate proficiency");
                    score -= 3;
                }
            }
            
            // ä¸€èˆ¬çš„ãªé–“é•ã„ã®æ¤œå‡º
            if (message.includes(' i ') || message.startsWith('i ')) {
                feedback.improvements.push("Remember to capitalize 'I'");
                score -= 2;
            }
            
            if (message.includes('dont') || message.includes('cant') || message.includes('wont')) {
                feedback.improvements.push("Use apostrophes in contractions (don't, can't, won't)");
                score -= 2;
            }
            
            // ã‚¹ã‚³ã‚¢ã®ç¯„å›²åˆ¶é™
            feedback.score = Math.max(60, Math.min(100, score));
            
            return feedback;
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä»˜ãã®å¿œç­”ã‚’ä½œæˆ
        function createFeedbackResponse(feedback, conversationResponse) {
            let response = "";
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯éƒ¨åˆ†ï¼ˆæ—¥æœ¬èªï¼‰
            response += "ğŸ“ <strong>è‹±èªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:</strong><br>";
            
            if (feedback.positive.length > 0) {
                response += "âœ… <em>è‰¯ã„ç‚¹:</em> " + translateFeedbackToJapanese(feedback.positive).join("ã€") + "<br>";
            }
            
            if (feedback.improvements.length > 0) {
                response += "ğŸ’¡ <em>æ”¹å–„ç‚¹:</em> " + translateFeedbackToJapanese(feedback.improvements).join("ã€") + "<br>";
            }
            
            response += `ğŸ“Š <em>è‹±èªã‚¹ã‚³ã‚¢:</em> ${feedback.score}/100ç‚¹<br><br>`;
            
            // ä¼šè©±å¿œç­”éƒ¨åˆ†ï¼ˆè‹±èªï¼‰
            response += "ğŸ’¬ <strong>ä¼šè©±ã®ç¶šã:</strong><br>";
            response += conversationResponse;
            
            return response;
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªã«ç¿»è¨³
        function translateFeedbackToJapanese(feedbackArray) {
            const translations = {
                // ãƒã‚¸ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                "Good detail in your response": "è©³ç´°ãªå¿œç­”ãŒã§ãã¦ã„ã¾ã™",
                "Nice use of opinion expressions": "æ„è¦‹è¡¨ç¾ãŒã†ã¾ãä½¿ãˆã¦ã„ã¾ã™",
                "Excellent use of transition words": "æ¥ç¶šè©ã®ä½¿ã„æ–¹ãŒç´ æ™´ã‚‰ã—ã„ã§ã™",
                "Proper capitalization and punctuation": "å¤§æ–‡å­—ãƒ»å¥èª­ç‚¹ãŒæ­£ã—ãä½¿ãˆã¦ã„ã¾ã™", 
                "Professional business language": "ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ“ã‚¸ãƒã‚¹è¡¨ç¾ãŒä½¿ãˆã¦ã„ã¾ã™",
                
                // æ”¹å–„ç‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                "Try to provide more detailed responses": "ã‚‚ã†å°‘ã—è©³ã—ã„å›ç­”ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†",
                "Remember to end sentences with proper punctuation": "æ–‡æœ«ã«é©åˆ‡ãªå¥èª­ç‚¹ã‚’ã¤ã‘ã¾ã—ã‚‡ã†",
                "Start sentences with capital letters": "æ–‡ã®æœ€åˆã¯å¤§æ–‡å­—ã§å§‹ã‚ã¾ã—ã‚‡ã†",
                "Consider using more complex sentence structures with commas": "ã‚³ãƒ³ãƒã‚’ä½¿ã£ãŸè¤‡é›‘ãªæ–‡æ§‹é€ ã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†",
                "Try to use multiple sentences for more sophisticated expression": "ã‚ˆã‚Šæ´—ç·´ã•ã‚ŒãŸè¡¨ç¾ã®ãŸã‚è¤‡æ•°ã®æ–‡ã‚’ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†",
                "Use more advanced vocabulary to demonstrate proficiency": "ä¸Šç´šèªå½™ã‚’ä½¿ã£ã¦ç†Ÿç·´åº¦ã‚’ç¤ºã—ã¾ã—ã‚‡ã†",
                "Remember to capitalize 'I'": "ã€ŒIã€ã¯å¿…ãšå¤§æ–‡å­—ã«ã—ã¾ã—ã‚‡ã†",
                "Use apostrophes in contractions (don't, can't, won't)": "çŸ­ç¸®å½¢ã§ã¯ã‚¢ãƒã‚¹ãƒˆãƒ­ãƒ•ã‚£ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ï¼ˆdon't, can't, won'tï¼‰"
            };
            
            return feedbackArray.map(item => translations[item] || item);
        }
        
        // Gemini APIã‹ã‚‰ã®å¿œç­”ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function getGeminiResponse(userMessage, scenario, difficulty) {
            // å®Ÿéš›ã®Gemini APIå®Ÿè£…æ™‚ã¯ã“ã“ã‚’å¤‰æ›´
            
            const conversationContext = conversationHistory.slice(-4); // ç›´è¿‘4å›ã®ä¼šè©±ã‚’æ–‡è„ˆã¨ã—ã¦ä½¿ç”¨
            const difficultyLevel = difficulty === 'hard' ? 'advanced' : 'intermediate';
            
            const prompt = `You are a professional business English conversation partner helping with this scenario: "${scenario}".
            
            Conversation difficulty: ${difficultyLevel}
            Recent conversation context: ${JSON.stringify(conversationContext)}
            
            User just said: "${userMessage}"
            
            Please respond naturally as if you are engaged in this business scenario. ${difficulty === 'hard' ? 'Use sophisticated vocabulary and complex sentence structures.' : 'Keep the language professional but accessible.'}
            
            Your response should:
            1. Be contextually relevant to the scenario
            2. Move the conversation forward meaningfully
            3. Ask engaging follow-up questions when appropriate
            4. Maintain professional business tone
            5. Be 1-3 sentences long
            
            Response:`;
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ç”Ÿæˆï¼ˆAPIå®Ÿè£…å‰ï¼‰
            return generateContextualResponse(userMessage, scenario, difficulty);
        }
        
        // æ–‡è„ˆã«å¿œã˜ãŸå¿œç­”ã‚’ç”Ÿæˆï¼ˆGemini APIå®Ÿè£…å‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        function generateContextualResponse(userMessage, scenario, difficulty) {
            const message = userMessage.toLowerCase();
            const scenarioLower = scenario.toLowerCase();
            
            // ä¼šè­°ã‚·ãƒŠãƒªã‚ªã®å¿œç­”
            if (scenarioLower.includes('meeting') || scenarioLower.includes('team')) {
                if (message.includes('agree') || message.includes('good point')) {
                    return "Excellent. Since we're aligned on this, let's discuss the implementation timeline. What resources do you think we'll need to make this happen effectively?";
                }
                if (message.includes('concern') || message.includes('issue')) {
                    return "I appreciate you raising that concern. Those are valid points that we need to address. How do you suggest we mitigate these risks while still moving forward?";
                }
                return "That's a valuable insight. Building on what you've said, how do you think this will impact our Q4 targets, and what adjustments might we need to make?";
            }
            
            // ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒŠãƒªã‚ªã®å¿œç­”
            if (scenarioLower.includes('presentation') || scenarioLower.includes('proposal')) {
                if (message.includes('question') || message.includes('clarify')) {
                    return "Great question! Let me address that directly. The key benefit here is cost reduction while improving efficiency. How important is ROI timeline in your decision-making process?";
                }
                if (message.includes('interested') || message.includes('promising')) {
                    return "I'm glad this resonates with you. The next step would be to run a pilot program with your team. What would be the ideal timeframe for implementation from your perspective?";
                }
                return "Thank you for that feedback. Based on what you've shared, it sounds like scalability is a priority for you. How large is your current operation, and what growth are you projecting?";
            }
            
            // é¡§å®¢å¯¾å¿œã‚·ãƒŠãƒªã‚ªã®å¿œç­”
            if (scenarioLower.includes('client') || scenarioLower.includes('customer') || scenarioLower.includes('phone')) {
                if (message.includes('problem') || message.includes('issue')) {
                    return "I completely understand your frustration, and I apologize for the inconvenience this has caused. Let me look into this immediately. Can you provide me with your account number so I can review the details?";
                }
                if (message.includes('satisfied') || message.includes('resolved')) {
                    return "I'm so glad we could resolve this for you today. Is there anything else I can help you with? Also, we'd appreciate your feedback on how we handled this situation.";
                }
                return "Thank you for providing that information. I can see exactly what happened here. Let me walk you through the solution and make sure this doesn't happen again.";
            }
            
            // é¢æ¥ã‚·ãƒŠãƒªã‚ªã®å¿œç­”
            if (scenarioLower.includes('interview')) {
                if (message.includes('experience') || message.includes('background')) {
                    return "That's impressive experience. I can see how that background would be valuable here. Tell me about a time when you had to lead a team through a particularly challenging situation. How did you handle it?";
                }
                if (message.includes('challenge') || message.includes('difficult')) {
                    return "That shows great problem-solving skills and leadership under pressure. How do you typically approach building consensus when team members have different opinions on the best path forward?";
                }
                return "Excellent answer. I appreciate the specific examples you've provided. What motivates you most about this type of work, and how do you see yourself contributing to our team's success?";
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”
            const responses = [
                "That's a thoughtful approach. How do you envision implementing this strategy across different departments?",
                "I see your point clearly. What metrics would you use to measure success in this initiative?",
                "Interesting perspective. What challenges do you anticipate, and how might we address them proactively?",
                "That makes complete sense. Walk me through your thinking on the timeline for this project.",
                "Great insight. How do you think our stakeholders will respond to this proposal?",
                "I appreciate that analysis. What would be the key success factors from your experience?",
                "That's a solid foundation. What additional resources or support would you need to execute this effectively?"
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function addMessageToDisplay(type, sender, message) {
            const conversationDisplay = document.getElementById('conversationDisplay');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            messageDiv.innerHTML = `
                <div class="sender">${sender}</div>
                <p>${message}</p>
            `;
            
            conversationDisplay.appendChild(messageDiv);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
            conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
            if (type === 'user') {
                messageCount++;
                document.getElementById('messageCount').textContent = messageCount;
            }
        }
        
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = show ? 'block' : 'none';
        }
        
        function updateProgress() {
            // ç°¡æ˜“çš„ãªé€²æ—è¨ˆç®—ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã«åŸºã¥ãï¼‰
            const progress = Math.min(messageCount * 10, 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '% å®Œäº†';
            
            // å®Ÿéš›ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¹ã‚³ã‚¢ã«åŸºã¥ãçµ±è¨ˆæ›´æ–°
            if (conversationHistory.length > 0) {
                const feedbackEntries = conversationHistory.filter(entry => entry.feedback);
                
                if (feedbackEntries.length > 0) {
                    // å¹³å‡ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
                    const totalScore = feedbackEntries.reduce((sum, entry) => sum + entry.feedback.score, 0);
                    const averageScore = Math.round(totalScore / feedbackEntries.length);
                    
                    // æœ€æ–°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å–å¾—
                    const latestFeedback = feedbackEntries[feedbackEntries.length - 1].feedback;
                    
                    // æ­£ç¢ºæ€§ã‚¹ã‚³ã‚¢ï¼ˆå¹³å‡ã‚¹ã‚³ã‚¢ï¼‰
                    document.getElementById('accuracyScore').textContent = averageScore + '%';
                    
                    // æµæš¢æ€§ã‚¹ã‚³ã‚¢ï¼ˆæœ€æ–°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨ãƒã‚¸ãƒ†ã‚£ãƒ–è¦ç´ æ•°ã«åŸºã¥ãï¼‰
                    const fluencyScore = Math.min(95, latestFeedback.score + (latestFeedback.positive.length * 2));
                    document.getElementById('fluencyScore').textContent = fluencyScore + '%';
                } else {
                    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                    document.getElementById('accuracyScore').textContent = '--';
                    document.getElementById('fluencyScore').textContent = '--';
                }
            }
        }
        
        function clearConversation() {
            if (confirm('ä¼šè©±ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                document.getElementById('conversationDisplay').innerHTML = `
                    <div class="message ai">
                        <div class="sender">AI Assistant</div>
                        <p>Conversation cleared. Let's start fresh! Please begin the conversation.</p>
                    </div>
                `;
                conversationHistory = [];
                messageCount = 0;
                document.getElementById('messageCount').textContent = '0';
                updateProgress();
            }
        }
        
        function getHint() {
            const hints = [
                "ã‚ˆã‚Šå°‚é–€çš„ãªãƒ“ã‚¸ãƒã‚¹èªå½™ã‚’ä½¿ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
                "ç›¸æ‰‹ã¸ã®è³ªå•ã‚’æŠ•ã’ã‹ã‘ã¦ã€ç©æ¥µçš„ãªå§¿å‹¢ã‚’ç¤ºã—ã¾ã—ã‚‡ã†ã€‚",
                "ã€ŒFurthermoreã€ã‚„ã€ŒIn additionã€ãªã©ã®æ¥ç¶šè©ã‚’ä½¿ã£ã¦ã€ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç¹‹ã’ã¦ã¿ã¦ãã ã•ã„ã€‚",
                "ç›¸æ‰‹ã®ç™ºè¨€ã‚’èªã‚ã‚‹ã“ã¨ã§ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚’å®Ÿè·µã—ã¾ã—ã‚‡ã†ã€‚",
                "å…·ä½“çš„ãªæ•°å­—ã€æ—¥ä»˜ã€ä¾‹ã‚’ä½¿ã£ã¦ã‚ˆã‚Šæ˜ç¢ºã«è¡¨ç¾ã—ã¦ã¿ã¦ãã ã•ã„ã€‚"
            ];
            
            const randomHint = hints[Math.floor(Math.random() * hints.length)];
            alert('ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ' + randomHint);
        }
        
        function requestFeedback() {
            if (conversationHistory.length === 0) {
                alert('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹å‰ã«ã€ã¾ãšä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            alert('ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«æä¾›ã•ã‚Œã¾ã™ã€‚ç·´ç¿’ã‚’ç¶šã‘ã¦ãã ã•ã„ï¼');
        }
        
        function finishSession() {
            if (confirm('ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                const sessionData = {
                    scenario: sessionStorage.getItem('selectedScenario'),
                    difficulty: sessionStorage.getItem('selectedDifficulty'),
                    messageCount: messageCount,
                    conversationHistory: conversationHistory,
                    sessionDuration: new Date() - sessionStartTime
                };
                
                sessionStorage.setItem('sessionData', JSON.stringify(sessionData));
                
                // æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã«é·ç§»ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                window.location.href = 'final-report.html';
            }
        }
        
        function restartSession() {
            if (confirm('ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚„ã‚Šç›´ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                window.location.reload();
            }
        }
        
        function goBack() {
            if (confirm('æˆ»ã£ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿç¾åœ¨ã®é€²æ—ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
                window.location.href = 'difficulty.html';
            }
        }
        
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                sessionStorage.clear();
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                window.location.replace('index.html');
            }
        }
        
        // ã‚·ãƒŠãƒªã‚ªã«åŸºã¥ã„ã¦AIã‹ã‚‰ä¼šè©±ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        function startScenarioBasedConversation(scenario, difficulty) {
            console.log('ğŸ­ Starting scenario-based conversation');
            console.log('ğŸ“ Original scenario (Japanese):', scenario);
            
            // ä¼šè©±è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('conversationDisplay').innerHTML = '';
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            addMessageToDisplay('ai', 'AI Assistant', 'Translating scenario and preparing conversation...');
            
            // ã‚·ãƒŠãƒªã‚ªã‚’è‹±èªã«ç¿»è¨³ã—ã¦Geminiã‹ã‚‰ä¼šè©±ã‚’é–‹å§‹
            translateScenarioAndStartConversation(scenario, difficulty);
        }
        
        // ã‚·ãƒŠãƒªã‚ªã‚’è‹±èªã«ç¿»è¨³ã—ã¦Geminiã§ä¼šè©±é–‹å§‹
        async function translateScenarioAndStartConversation(japaneseScenario, difficulty) {
            try {
                console.log('ğŸŒ Translating scenario to English...');
                
                // æ—¥æœ¬èªã‚·ãƒŠãƒªã‚ªã‚’è‹±èªã«ç¿»è¨³
                const englishScenario = await translateJapaneseToEnglish(japaneseScenario);
                console.log('âœ… Translated scenario (English):', englishScenario);
                
                // ç¿»è¨³ã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                sessionStorage.setItem('englishScenario', englishScenario);
                
                // Geminiã«ä¼šè©±é–‹å§‹ã‚’ä¾é ¼
                const openingMessage = await getGeminiOpeningMessage(englishScenario, difficulty);
                
                // ä¼šè©±è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                document.getElementById('conversationDisplay').innerHTML = '';
                addMessageToDisplay('ai', 'AI Assistant', openingMessage);
                
                // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
                conversationHistory.push({
                    role: 'assistant',
                    content: openingMessage,
                    timestamp: new Date().toISOString(),
                    scenario: englishScenario
                });
                
            } catch (error) {
                console.error('âŒ Error in translation/conversation start:', error);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                document.getElementById('conversationDisplay').innerHTML = '';
                const fallbackMessage = generateScenarioOpening(japaneseScenario, difficulty);
                addMessageToDisplay('ai', 'AI Assistant', fallbackMessage);
                
                conversationHistory.push({
                    role: 'assistant',
                    content: fallbackMessage,
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        // æ—¥æœ¬èªã‚’è‹±èªã«ç¿»è¨³ã™ã‚‹é–¢æ•°
        async function translateJapaneseToEnglish(japaneseText) {
            // ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªç¿»è¨³è¾æ›¸
            const translationMap = {
                // æ—¥å¸¸ç”Ÿæ´»ãƒ»æ—…è¡Œé–¢é€£
                'å…¥å›½å¯©æŸ»': 'immigration control',
                'å…¥å›½å¯©æŸ»æ™‚': 'immigration control',
                'å…¥å›½': 'immigration',
                'ç©ºæ¸¯': 'airport',
                'é£›è¡Œæ©Ÿ': 'airplane flight',
                'ãƒ›ãƒ†ãƒ«': 'hotel',
                'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³': 'hotel check-in',
                'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³': 'restaurant',
                'é£Ÿäº‹': 'dining',
                'è²·ã„ç‰©': 'shopping',
                'åº—': 'store',
                'ç—…é™¢': 'hospital',
                'åŒ»è€…': 'doctor visit',
                'éŠ€è¡Œ': 'bank',
                'ã‚¿ã‚¯ã‚·ãƒ¼': 'taxi',
                'äº¤é€š': 'transportation',
                'éƒµä¾¿å±€': 'post office',
                'éƒµä¾¿': 'mail service',
                'å­¦æ ¡': 'school',
                'å¤§å­¦': 'university',
                'ã‚¢ãƒ‘ãƒ¼ãƒˆ': 'apartment rental',
                'è³ƒè²¸': 'rental',
                'è­¦å¯Ÿ': 'police',
                'ã‚¸ãƒ ': 'gym',
                'ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹': 'fitness',
                'ç¾å®¹é™¢': 'hair salon',
                'ç†é«ªåº—': 'barber shop',
                
                // ãƒ“ã‚¸ãƒã‚¹é–¢é€£
                'ãƒãƒ¼ãƒ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°': 'team meeting',
                'ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°': 'meeting',
                'ä¼šè­°': 'meeting',
                'å››åŠæœŸæ¥­ç¸¾': 'quarterly results',
                'æˆ¦ç•¥è¨ˆç”»': 'strategic planning',
                'å¸ä¼š': 'leading',
                'å¸ä¼šé€²è¡Œ': 'facilitating',
                'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³': 'presentation',
                'ãƒ—ãƒ¬ã‚¼ãƒ³': 'presentation',
                'æ–°è£½å“ææ¡ˆ': 'new product proposal',
                'æŠ•è³‡å®¶': 'investors',
                'è³ªç–‘å¿œç­”': 'Q&A session',
                'é›»è©±å¯¾å¿œ': 'phone call',
                'é›»è©±': 'phone call',
                'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ': 'client',
                'é¡§å®¢': 'customer',
                'ã‚µãƒ¼ãƒ“ã‚¹å•é¡Œ': 'service issues',
                'å•é¡Œè§£æ±º': 'problem resolution',
                'å°±è·é¢æ¥': 'job interview',
                'é¢æ¥': 'interview',
                'ã‚·ãƒ‹ã‚¢ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ': 'senior management',
                'ç®¡ç†è·': 'management position',
                'è¡Œå‹•é¢': 'behavioral',
                'æŠ€è¡“é¢': 'technical',
                'å¥‘ç´„äº¤æ¸‰': 'contract negotiation',
                'äº¤æ¸‰': 'negotiation',
                'ä¾¡æ ¼è¨­å®š': 'pricing',
                'ç´æœŸ': 'delivery schedule',
                'ãƒ™ãƒ³ãƒ€ãƒ¼': 'vendor',
                'äººäº‹è©•ä¾¡': 'performance review',
                'è©•ä¾¡é¢è«‡': 'performance review',
                'æˆæœ': 'achievements',
                'æ”¹å–„ç‚¹': 'areas for improvement',
                'èƒ½åŠ›é–‹ç™º': 'professional development',
                
                // å‹•ä½œãƒ»è¡Œç‚º
                'ã«ã¤ã„ã¦è©±ã—åˆ': 'discussion about',
                'è¨è­°': 'discussion',
                'ã¨ã®': 'with',
                'ã«å¯¾ã—ã¦': 'regarding',
                'æ™‚': 'situation',
                'ã§ã®': 'at',
                'ã«ãŠã‘ã‚‹': 'in',
                'ã§': 'at'
            };
            
            let translatedText = japaneseText;
            
            // è¾æ›¸ãƒ™ãƒ¼ã‚¹ã®ç¿»è¨³
            for (const [japanese, english] of Object.entries(translationMap)) {
                translatedText = translatedText.replace(new RegExp(japanese, 'g'), english);
            }
            
            // åŸºæœ¬çš„ãªæ–‡æ§‹é€ ã®èª¿æ•´
            translatedText = translatedText.replace(/ã«ã¤ã„ã¦è©±ã—åˆ[ã†|ã„|ã£]/g, 'discussion about');
            translatedText = translatedText.replace(/è¨è­°/g, 'discussion');
            translatedText = translatedText.replace(/ã¨ã®/g, 'with');
            translatedText = translatedText.replace(/ã«å¯¾ã—ã¦/g, 'regarding');
            translatedText = translatedText.replace(/æ™‚$/g, 'situation');
            translatedText = translatedText.replace(/ã§ã®/g, 'at');
            translatedText = translatedText.replace(/ã«ãŠã‘ã‚‹/g, 'in');
            
            console.log('ğŸ”„ Translation result:', translatedText);
            return translatedText;
        }
        
        // Geminiã‹ã‚‰é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function getGeminiOpeningMessage(englishScenario, difficulty) {
            // å®Ÿéš›ã®Gemini APIä½¿ç”¨æ™‚ã¯ã“ã“ã‚’å®Ÿè£…
            // ç¾åœ¨ã¯ãƒ‡ãƒ¢ç”¨ã®å¿œç­”ã‚’è¿”ã™
            
            const difficultyLevel = difficulty === 'hard' ? 'advanced' : 'intermediate';
            
            const prompt = `You are a business English conversation partner. Start a realistic ${difficultyLevel} level business conversation based on this scenario: "${englishScenario}". 
            
            Please:
            1. Take the initiative and start the conversation naturally
            2. Set the appropriate business context
            3. Ask an engaging question to get the conversation flowing
            4. Use professional but approachable language
            5. Make it feel like a real business situation
            
            Begin the conversation now:`;
            
            // Gemini APIã®ä»£ã‚ã‚Šã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
            return generateGeminiStyleOpening(englishScenario, difficulty);
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸAIã®å½¹å‰²ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
        function extractAIRole(scenarioText) {
            const text = scenarioText.toLowerCase();
            let aiRole = '';
            let situation = '';
            
            // æ‹¬å¼§å†…ã®å½¹å‰²æŒ‡å®šã‚’æ¢ã™
            const roleMatch = scenarioText.match(/ï¼ˆ(.+?)ï¼‰/);
            if (roleMatch) {
                aiRole = roleMatch[1];
                situation = scenarioText.replace(/ï¼ˆ.+?ï¼‰/, '').trim();
            } else {
                // æ‹¬å¼§ãŒãªã„å ´åˆã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰æ¨æ¸¬
                situation = scenarioText;
                aiRole = inferAIRole(text);
            }
            
            console.log('ğŸ­ Extracted AI Role:', aiRole);
            console.log('ğŸ“ Situation:', situation);
            
            return { aiRole, situation };
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰AIã®å½¹å‰²ã‚’æ¨æ¸¬ã™ã‚‹é–¢æ•°
        function inferAIRole(text) {
            if (text.includes('å…¥å›½å¯©æŸ»') || text.includes('immigration')) return 'å…¥å›½å¯©æŸ»å®˜';
            if (text.includes('ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³') || text.includes('restaurant')) return 'ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼';
            if (text.includes('ãƒ›ãƒ†ãƒ«') || text.includes('hotel')) return 'å—ä»˜ã‚¹ã‚¿ãƒƒãƒ•';
            if (text.includes('ç—…é™¢') || text.includes('åŒ»è€…') || text.includes('doctor')) return 'åŒ»å¸«';
            if (text.includes('è²·ã„ç‰©') || text.includes('shopping')) return 'åº—å“¡';
            if (text.includes('éŠ€è¡Œ') || text.includes('bank')) return 'éŠ€è¡Œå“¡';
            if (text.includes('ã‚¿ã‚¯ã‚·ãƒ¼') || text.includes('taxi')) return 'é‹è»¢æ‰‹';
            if (text.includes('éƒµä¾¿å±€') || text.includes('post office')) return 'éƒµä¾¿å±€å“¡';
            if (text.includes('ç¾å®¹é™¢') || text.includes('salon')) return 'ç¾å®¹å¸«';
            if (text.includes('é¢æ¥') || text.includes('interview')) return 'é¢æ¥å®˜';
            if (text.includes('ä¼šè­°') || text.includes('meeting')) return 'åŒåƒš';
            if (text.includes('ãƒ—ãƒ¬ã‚¼ãƒ³') || text.includes('presentation')) return 'èãæ‰‹';
            if (text.includes('é¡§å®¢') || text.includes('customer')) return 'é¡§å®¢ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“';
            if (text.includes('äº¤æ¸‰') || text.includes('negotiation')) return 'äº¤æ¸‰ç›¸æ‰‹';
            if (text.includes('è©•ä¾¡') || text.includes('review')) return 'ä¸Šå¸';
            
            return 'å¯¾è©±ç›¸æ‰‹';
        }
        
        // å½¹å‰²ã«åŸºã¥ã„ã¦é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
        function generateRoleBasedOpening(situation, aiRole, difficulty) {
            const role = aiRole.toLowerCase();
            const scene = situation.toLowerCase();
            
            // å…¥å›½å¯©æŸ»å®˜
            if (role.includes('å…¥å›½å¯©æŸ»å®˜') || role.includes('immigration officer')) {
                return "Good afternoon. Welcome to the United States. Please present your passport and any necessary documentation. What is the purpose of your visit today?";
            }
            
            // ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼
            if (role.includes('ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼') || role.includes('waiter') || role.includes('server')) {
                return "Good evening and welcome to Bella Vista Restaurant. My name is Michael, and I'll be your server tonight. Have you dined with us before? Would you like to start with something to drink?";
            }
            
            // ãƒ›ãƒ†ãƒ«å—ä»˜
            if (role.includes('å—ä»˜') || role.includes('ãƒ•ãƒ­ãƒ³ãƒˆ') || role.includes('reception') || role.includes('front desk')) {
                return "Good evening! Welcome to the Grand Hotel. My name is Sarah, and I'll be assisting you with your check-in today. May I have your reservation name, please?";
            }
            
            // åŒ»å¸«
            if (role.includes('åŒ»å¸«') || role.includes('åŒ»è€…') || role.includes('doctor')) {
                return "Good morning. I'm Dr. Johnson. I understand you're not feeling well today. Can you tell me about your symptoms and when they started?";
            }
            
            // åº—å“¡
            if (role.includes('åº—å“¡') || role.includes('sales') || role.includes('staff')) {
                return "Hi there! Welcome to our store. I'm Jessica, one of the sales associates here. Is there anything specific you're looking for today, or would you like me to show you our featured items?";
            }
            
            // éŠ€è¡Œå“¡
            if (role.includes('éŠ€è¡Œå“¡') || role.includes('bank') || role.includes('teller')) {
                return "Good afternoon! Welcome to City Bank. I'm Maria, a customer service representative. How can I assist you today? Are you looking to open an account or do you have an existing account with us?";
            }
            
            // ã‚¿ã‚¯ã‚·ãƒ¼é‹è»¢æ‰‹
            if (role.includes('é‹è»¢æ‰‹') || role.includes('driver')) {
                return "Hi! I'm your driver for today. Where would you like to go? And do you have a preferred route, or would you like me to take the fastest way?";
            }
            
            // éƒµä¾¿å±€å“¡
            if (role.includes('éƒµä¾¿å±€å“¡') || role.includes('postal') || role.includes('mail')) {
                return "Good morning! Welcome to the post office. I can help you with shipping, mailing, or any postal services you need. What can I do for you today?";
            }
            
            // ç¾å®¹å¸«
            if (role.includes('ç¾å®¹å¸«') || role.includes('stylist') || role.includes('hairdresser')) {
                return "Hi there! Welcome to Style Studio. I'm Emma, your stylist for today. What kind of look are you going for? Do you have any specific style in mind?";
            }
            
            // é¢æ¥å®˜
            if (role.includes('é¢æ¥å®˜') || role.includes('interviewer')) {
                return "Welcome! It's great to meet you, and thank you for your interest in this position. I'm Jennifer, the hiring manager for this role. I've had a chance to review your resume, and I'm impressed with your background. Let's start with you telling me what attracted you to this position.";
            }
            
            // åŒåƒšï¼ˆä¼šè­°ï¼‰
            if (role.includes('åŒåƒš') || role.includes('colleague') || scene.includes('meeting')) {
                return "Good morning everyone! Thank you for joining today's meeting. I've reviewed the agenda, and we have some important topics to discuss. Before we dive in, I'd like to hear your thoughts on our current challenges. What do you see as our main priorities?";
            }
            
            // èãæ‰‹ï¼ˆãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            if (role.includes('èãæ‰‹') || role.includes('audience') || scene.includes('presentation')) {
                return "Thank you for taking the time to present to us today. I'm interested in hearing about your proposal. Before you begin, could you give us a brief overview of what you'll be covering and how this relates to our current objectives?";
            }
            
            // é¡§å®¢ã‚µãƒ¼ãƒ“ã‚¹
            if (role.includes('é¡§å®¢') || role.includes('customer service') || role.includes('ã‚µãƒ¼ãƒ“ã‚¹')) {
                return "Good afternoon, and thank you for calling our customer service line. My name is David, and I'm here to help you today. I understand you have some concerns. Could you please provide me with your account information and describe the issue you're experiencing?";
            }
            
            // äº¤æ¸‰ç›¸æ‰‹
            if (role.includes('äº¤æ¸‰') || role.includes('negotiation')) {
                return "Thank you for meeting with us today to discuss this partnership opportunity. I'm Robert from the procurement team. I've reviewed your proposal, and while there are some interesting elements, I'd like to discuss a few aspects of the terms. What's most important to you in this agreement?";
            }
            
            // ä¸Šå¸ï¼ˆè©•ä¾¡ï¼‰
            if (role.includes('ä¸Šå¸') || role.includes('manager') || scene.includes('è©•ä¾¡') || scene.includes('review')) {
                return "Hi there! Thanks for setting aside time for our quarterly review. I'm your manager, Susan, and I've been looking forward to this conversation. Let's start by discussing your recent projects. What do you feel went particularly well this quarter?";
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            return `Hello! I'm here as your ${aiRole} for this scenario: "${situation}". I'm ready to help you practice this conversation. How can I assist you today?`;
        }
        function generateGeminiStyleOpening(englishScenario, difficulty) {
            const scenario = englishScenario.toLowerCase();
            
            // å…¥å›½å¯©æŸ»
            if (scenario.includes('immigration') || scenario.includes('å…¥å›½å¯©æŸ»') || scenario.includes('å…¥å›½')) {
                return "Good afternoon. Welcome to the United States. Please present your passport and any necessary documentation. What is the purpose of your visit today?";
            }
            
            // ç©ºæ¸¯ãƒ»é£›è¡Œæ©Ÿ
            if (scenario.includes('airport') || scenario.includes('flight') || scenario.includes('ç©ºæ¸¯') || scenario.includes('é£›è¡Œæ©Ÿ')) {
                return "Good morning! Welcome aboard flight 123 to New York. I'm your flight attendant today. Can I help you find your seat, or do you have any questions about our services?";
            }
            
            // ãƒ›ãƒ†ãƒ«
            if (scenario.includes('hotel') || scenario.includes('check-in') || scenario.includes('ãƒ›ãƒ†ãƒ«') || scenario.includes('ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³')) {
                return "Good evening! Welcome to the Grand Hotel. My name is Sarah, and I'll be assisting you with your check-in today. May I have your reservation name, please?";
            }
            
            // ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³
            if (scenario.includes('restaurant') || scenario.includes('dining') || scenario.includes('ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³') || scenario.includes('é£Ÿäº‹')) {
                return "Good evening and welcome to Bella Vista Restaurant. My name is Michael, and I'll be your server tonight. Have you dined with us before? Would you like to start with something to drink?";
            }
            
            // ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°
            if (scenario.includes('shopping') || scenario.includes('store') || scenario.includes('è²·ã„ç‰©') || scenario.includes('åº—')) {
                return "Hi there! Welcome to our store. I'm Jessica, one of the sales associates here. Is there anything specific you're looking for today, or would you like me to show you our featured items?";
            }
            
            // ç—…é™¢ãƒ»åŒ»ç™‚
            if (scenario.includes('hospital') || scenario.includes('doctor') || scenario.includes('medical') || scenario.includes('ç—…é™¢') || scenario.includes('åŒ»è€…')) {
                return "Good morning. I'm Dr. Johnson. I understand you're not feeling well today. Can you tell me about your symptoms and when they started?";
            }
            
            // éŠ€è¡Œ
            if (scenario.includes('bank') || scenario.includes('banking') || scenario.includes('éŠ€è¡Œ')) {
                return "Good afternoon! Welcome to City Bank. I'm Maria, a customer service representative. How can I assist you today? Are you looking to open an account or do you have an existing account with us?";
            }
            
            // ã‚¿ã‚¯ã‚·ãƒ¼ãƒ»äº¤é€š
            if (scenario.includes('taxi') || scenario.includes('uber') || scenario.includes('transport') || scenario.includes('ã‚¿ã‚¯ã‚·ãƒ¼') || scenario.includes('äº¤é€š')) {
                return "Hi! I'm your driver for today. Where would you like to go? And do you have a preferred route, or would you like me to take the fastest way?";
            }
            
            // éƒµä¾¿å±€
            if (scenario.includes('post office') || scenario.includes('mail') || scenario.includes('éƒµä¾¿å±€') || scenario.includes('éƒµä¾¿')) {
                return "Good morning! Welcome to the post office. I can help you with shipping, mailing, or any postal services you need. What can I do for you today?";
            }
            
            // å­¦æ ¡ãƒ»æ•™è‚²
            if (scenario.includes('school') || scenario.includes('university') || scenario.includes('education') || scenario.includes('å­¦æ ¡') || scenario.includes('å¤§å­¦')) {
                return "Hello! Welcome to our university. I'm Professor Smith from the International Student Services. Are you here for enrollment, or do you have questions about our programs?";
            }
            
            // è³ƒè²¸ãƒ»ä¸å‹•ç”£
            if (scenario.includes('apartment') || scenario.includes('rental') || scenario.includes('real estate') || scenario.includes('ã‚¢ãƒ‘ãƒ¼ãƒˆ') || scenario.includes('è³ƒè²¸')) {
                return "Good afternoon! I'm Lisa from Premier Real Estate. I understand you're looking for an apartment. What type of place are you searching for, and what's your budget range?";
            }
            
            // è­¦å¯Ÿ
            if (scenario.includes('police') || scenario.includes('officer') || scenario.includes('è­¦å¯Ÿ')) {
                return "Good afternoon. I'm Officer Davis with the Metropolitan Police. I stopped you today because you were going 45 in a 35 mph zone. May I see your driver's license and registration, please?";
            }
            
            // ã‚¸ãƒ ãƒ»ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹
            if (scenario.includes('gym') || scenario.includes('fitness') || scenario.includes('ã‚¸ãƒ ') || scenario.includes('ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹')) {
                return "Hi! Welcome to FitLife Gym. I'm Alex, one of the personal trainers here. Are you interested in a membership, or would you like to know more about our fitness programs?";
            }
            
            // ç¾å®¹é™¢ãƒ»ç†é«ªåº—
            if (scenario.includes('salon') || scenario.includes('barber') || scenario.includes('hair') || scenario.includes('ç¾å®¹é™¢') || scenario.includes('ç†é«ªåº—')) {
                return "Hi there! Welcome to Style Studio. I'm Emma, your stylist for today. What kind of look are you going for? Do you have any specific style in mind?";
            }
            
            // ãƒ“ã‚¸ãƒã‚¹ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°
            if (scenario.includes('meeting') || scenario.includes('team') || scenario.includes('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°') || scenario.includes('ä¼šè­°')) {
                return "Good morning everyone! Thank you for joining today's meeting. I've called this meeting to discuss our quarterly results and plan our strategy for the upcoming quarter. Let's start by reviewing the key performance indicators from last quarter. What are your initial thoughts on our performance?";
            }
            
            // ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
            if (scenario.includes('presentation') || scenario.includes('proposal') || scenario.includes('ãƒ—ãƒ¬ã‚¼ãƒ³') || scenario.includes('ææ¡ˆ')) {
                return "Thank you for taking the time to meet with me today. I'm excited to share this proposal with you, as I believe it addresses some key opportunities in your market. Before I begin the formal presentation, could you tell me about your current priorities and what success looks like for your organization this quarter?";
            }
            
            // é¡§å®¢ã‚µãƒ¼ãƒ“ã‚¹é›»è©±
            if (scenario.includes('phone') || scenario.includes('client') || scenario.includes('customer') || scenario.includes('é›»è©±') || scenario.includes('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ')) {
                return "Good afternoon, and thank you for calling our customer service line. My name is David, and I'm here to help you today. I understand you have some concerns about our service. Could you please provide me with your account number and describe the issue you're experiencing?";
            }
            
            // é¢æ¥
            if (scenario.includes('interview') || scenario.includes('é¢æ¥')) {
                return "Welcome! It's great to meet you, and thank you for your interest in this position. I'm Jennifer, the hiring manager for this role. I've had a chance to review your resume, and I'm impressed with your background. Let's start with you telling me what attracted you to this position and how you see yourself contributing to our team.";
            }
            
            // äº¤æ¸‰
            if (scenario.includes('negotiation') || scenario.includes('contract') || scenario.includes('äº¤æ¸‰') || scenario.includes('å¥‘ç´„')) {
                return "Thank you for meeting with us today to discuss this partnership opportunity. I'm Robert, the procurement manager. I've reviewed your proposal, and while there are some interesting elements, I'd like to discuss the pricing structure and delivery timeline. What flexibility do you have in these areas?";
            }
            
            // äººäº‹è©•ä¾¡
            if (scenario.includes('performance') || scenario.includes('review') || scenario.includes('è©•ä¾¡') || scenario.includes('äººäº‹')) {
                return "Hi there! Thanks for setting aside time for our quarterly review. I'm your manager, Susan, and I've been looking forward to this conversation. Let's start by discussing your recent projects and achievements. What do you feel went particularly well this quarter?";
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆæ±ç”¨çš„ãªå¯¾å¿œï¼‰
            return `Hello! I'm ready to help you practice this scenario: "${englishScenario}". Let me take on the appropriate role for this situation. Based on the context, I'll be your conversation partner. How can I assist you today, and what would you like to focus on in this interaction?`;
        }
        
        // ã‚·ãƒŠãƒªã‚ªã«åŸºã¥ã„ãŸé–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
        function generateScenarioOpening(scenario, difficulty) {
            const lowerScenario = scenario.toLowerCase();
            
            // ãƒãƒ¼ãƒ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢é€£
            if (lowerScenario.includes('meeting') || lowerScenario.includes('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°') || lowerScenario.includes('ä¼šè­°')) {
                return "Good morning everyone! Thank you for joining today's meeting. I've called this meeting to discuss our quarterly results and plan our strategy for the upcoming quarter. Let's start by reviewing the key performance indicators from last quarter. What are your initial thoughts on our performance?";
            }
            
            // ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£
            if (lowerScenario.includes('presentation') || lowerScenario.includes('ãƒ—ãƒ¬ã‚¼ãƒ³') || lowerScenario.includes('ææ¡ˆ')) {
                return "Good afternoon, and thank you for taking the time to meet with us today. I'm excited to present our new product proposal that I believe will significantly impact your business growth. Before we dive into the details, could you tell me a bit about your current challenges in this market segment?";
            }
            
            // é›»è©±ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¯¾å¿œé–¢é€£
            if (lowerScenario.includes('phone') || lowerScenario.includes('client') || lowerScenario.includes('é›»è©±') || lowerScenario.includes('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ')) {
                return "Hello, thank you for calling. I understand you're experiencing some service issues, and I want to make sure we resolve this matter promptly. Could you please describe the specific problem you're facing so I can better assist you?";
            }
            
            // é¢æ¥é–¢é€£
            if (lowerScenario.includes('interview') || lowerScenario.includes('é¢æ¥')) {
                return "Good morning! Welcome to our company. I'm pleased to meet with you today regarding the senior management position. I've reviewed your resume and I'm impressed with your background. Let's start with you telling me about your leadership experience and what motivates you in a management role.";
            }
            
            // äº¤æ¸‰é–¢é€£
            if (lowerScenario.includes('negotiation') || lowerScenario.includes('äº¤æ¸‰') || lowerScenario.includes('å¥‘ç´„')) {
                return "Thank you for meeting with us today to discuss the contract terms. We've reviewed your initial proposal, and while we appreciate the comprehensive scope of services, we'd like to discuss some aspects of the pricing structure and delivery timeline. Shall we start with the pricing model?";
            }
            
            // äººäº‹è©•ä¾¡é–¢é€£
            if (lowerScenario.includes('performance') || lowerScenario.includes('review') || lowerScenario.includes('è©•ä¾¡') || lowerScenario.includes('äººäº‹')) {
                return "Hi there! Thanks for setting aside time for our performance review meeting. I've been looking forward to discussing your achievements this year and exploring opportunities for your professional development. Let's start by reflecting on your key accomplishments. What would you say were your biggest successes this year?";
            }
            
            // ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒ¼ãƒ“ã‚¹é–¢é€£
            if (lowerScenario.includes('customer service') || lowerScenario.includes('ã‚«ã‚¹ã‚¿ãƒãƒ¼') || lowerScenario.includes('é¡§å®¢å¯¾å¿œ')) {
                return "Hello! Thank you for contacting our customer service team. I'm here to help resolve any issues you may be experiencing with our products or services. Could you please provide me with your account information and describe the nature of your inquiry?";
            }
            
            // ä¸€èˆ¬çš„ãªãƒ“ã‚¸ãƒã‚¹ã‚·ãƒŠãƒªã‚ªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
            return `Good morning! I'm ready to engage in our business scenario: "${scenario}". Let me set the context and begin our professional interaction. How would you like to approach this situation, and what are your initial thoughts on how we should proceed?`;
        }
        
        // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
        function initializeSpeechRecognition() {
            console.log('ğŸ¤ Initializing speech recognition...');
            console.log('ğŸ“± User Agent:', navigator.userAgent);
            console.log('ğŸŒ Platform:', navigator.platform);
            
            // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®æ¤œå‡º
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            console.log('ğŸ“± Is Mobile:', isMobile);
            
            // HTTPSãƒã‚§ãƒƒã‚¯
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                console.log('âš ï¸ HTTPS required for speech recognition');
                const voiceButton = document.getElementById('voiceButton');
                if (voiceButton) {
                    voiceButton.disabled = true;
                    voiceButton.textContent = 'ğŸ”’ HTTPSå¿…é ˆ';
                    voiceButton.style.opacity = '0.5';
                    voiceButton.title = 'éŸ³å£°èªè­˜ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™';
                }
                return;
            }
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
            const hasWebkitSpeech = 'webkitSpeechRecognition' in window;
            const hasSpeech = 'SpeechRecognition' in window;
            console.log('ğŸ¤ webkitSpeechRecognition:', hasWebkitSpeech);
            console.log('ğŸ¤ SpeechRecognition:', hasSpeech);
            
            if (!hasWebkitSpeech && !hasSpeech) {
                console.log('âŒ Speech recognition not supported in this browser');
                const voiceButton = document.getElementById('voiceButton');
                if (voiceButton) {
                    voiceButton.disabled = true;
                    voiceButton.textContent = isMobile ? 'ğŸ“± ãƒ¢ãƒã‚¤ãƒ«éå¯¾å¿œ' : 'ğŸš« éŸ³å£°éå¯¾å¿œ';
                    voiceButton.style.opacity = '0.5';
                    voiceButton.title = isMobile ? 
                        'ã“ã®ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã‚’ãŠè©¦ã—ãã ã•ã„ã€‚' : 
                        'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“';
                }
                return;
            }
            
            try {
                // éŸ³å£°èªè­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã®è¨­å®šèª¿æ•´
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
                if (isMobile) {
                    recognition.maxAlternatives = 1;
                    // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯éŸ³å£°èªè­˜ã®æ„Ÿåº¦ã‚’èª¿æ•´
                }
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                recognition.onstart = function() {
                    console.log('ğŸ¤ Speech recognition started');
                    isRecording = true;
                    updateVoiceButton();
                    
                    // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¼·åŒ–
                    if (isMobile) {
                        document.body.style.backgroundColor = '#f0f8ff';
                        setTimeout(() => {
                            document.body.style.backgroundColor = '';
                        }, 300);
                    }
                };
                
                recognition.onresult = function(event) {
                    console.log('ğŸ¤ Recognition result event:', event);
                    
                    if (event.results && event.results.length > 0) {
                        const transcript = event.results[0][0].transcript;
                        console.log('ğŸ¤ Speech recognized:', transcript);
                        
                        // çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«æŒ¿å…¥
                        const userInput = document.getElementById('userInput');
                        if (userInput) {
                            userInput.value = transcript;
                            userInput.focus();
                            
                            // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯æˆåŠŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                            if (isMobile) {
                                navigator.vibrate && navigator.vibrate(100);
                            }
                        }
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('ğŸ¤ Speech recognition error:', event.error);
                    console.error('ğŸ¤ Error details:', event);
                    isRecording = false;
                    updateVoiceButton();
                    
                    let errorMessage;
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = isMobile ? 
                                'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒã‚¤ã‚¯ã«è¿‘ã¥ã„ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚' :
                                'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                            break;
                        case 'audio-capture':
                            errorMessage = isMobile ?
                                'ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚è¨­å®šã§ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚' :
                                'ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case 'not-allowed':
                            errorMessage = isMobile ?
                                'ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚' :
                                'ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case 'network':
                            errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case 'service-not-allowed':
                            errorMessage = isMobile ?
                                'ã“ã®ã‚µã‚¤ãƒˆã§ã¯éŸ³å£°èªè­˜ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚HTTPSã‚µã‚¤ãƒˆã§ãŠè©¦ã—ãã ã•ã„ã€‚' :
                                'HTTPSãŒå¿…è¦ã§ã™ã€‚ã‚»ã‚­ãƒ¥ã‚¢ãªæ¥ç¶šã§ãŠè©¦ã—ãã ã•ã„ã€‚';
                            break;
                        case 'aborted':
                            errorMessage = 'éŸ³å£°èªè­˜ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚';
                            break;
                        default:
                            errorMessage = `éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${event.error}`;
                    }
                    
                    // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ã„ã‚¢ãƒ©ãƒ¼ãƒˆ
                    if (isMobile) {
                        setTimeout(() => {
                            alert('ğŸ¤ ' + errorMessage);
                        }, 100);
                    } else {
                        alert('ğŸ¤ ' + errorMessage);
                    }
                };
                
                recognition.onend = function() {
                    console.log('ğŸ¤ Speech recognition ended');
                    isRecording = false;
                    updateVoiceButton();
                };
                
                // éŸ³å£°èªè­˜ã®å¯ç”¨æ€§ã‚’ãƒ†ã‚¹ãƒˆ
                if (isMobile) {
                    console.log('ğŸ“± Mobile device detected - testing speech recognition...');
                    // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å®Ÿéš›ã«ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã‚‹
                    setTimeout(() => {
                        try {
                            recognition.start();
                            setTimeout(() => {
                                if (isRecording) {
                                    recognition.stop();
                                    console.log('âœ… Mobile speech recognition test successful');
                                }
                            }, 100);
                        } catch (testError) {
                            console.error('âŒ Mobile speech recognition test failed:', testError);
                            const voiceButton = document.getElementById('voiceButton');
                            if (voiceButton) {
                                voiceButton.disabled = true;
                                voiceButton.textContent = 'ğŸ“± ãƒ¢ãƒã‚¤ãƒ«éå¯¾å¿œ';
                                voiceButton.style.opacity = '0.5';
                            }
                        }
                    }, 2000);
                }
                
                console.log('âœ… Speech recognition initialized successfully');
                
            } catch (error) {
                console.error('âŒ Failed to initialize speech recognition:', error);
                const voiceButton = document.getElementById('voiceButton');
                if (voiceButton) {
                    voiceButton.disabled = true;
                    voiceButton.textContent = isMobile ? 'ğŸ“± åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼' : 'ğŸš« åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼';
                    voiceButton.style.opacity = '0.5';
                }
            }
        }
        
        // éŸ³å£°å…¥åŠ›ã®ãƒˆã‚°ãƒ«
        function toggleVoiceInput() {
            console.log('ğŸ¤ toggleVoiceInput called, isRecording:', isRecording);
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (!recognition) {
                alert('éŸ³å£°èªè­˜ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (isRecording) {
                console.log('ğŸ¤ Stopping speech recognition');
                try {
                    recognition.stop();
                } catch (error) {
                    console.error('ğŸ¤ Error stopping recognition:', error);
                    isRecording = false;
                    updateVoiceButton();
                }
            } else {
                console.log('ğŸ¤ Starting speech recognition');
                
                // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯è¿½åŠ ã®æº–å‚™å‡¦ç†
                if (isMobile) {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ˜ç¤ºçš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç›´æ¥é–‹å§‹ï¼ˆé‡è¦ï¼‰
                    try {
                        recognition.start();
                    } catch (error) {
                        console.error('ğŸ¤ Failed to start recognition on mobile:', error);
                        alert('éŸ³å£°èªè­˜ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒã‚¤ã‚¯ã®æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }
                } else {
                    // PCç‰ˆã§ã¯å¾“æ¥é€šã‚Šã®æ¨©é™ãƒã‚§ãƒƒã‚¯
                    try {
                        // ãƒã‚¤ã‚¯æ¨©é™ã®ç¢ºèª
                        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                            navigator.mediaDevices.getUserMedia({ audio: true })
                                .then(function(stream) {
                                    // æ¨©é™ãŒå–å¾—ã§ããŸå ´åˆ
                                    stream.getTracks().forEach(track => track.stop()); // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                                    recognition.start();
                                })
                                .catch(function(err) {
                                    console.error('ğŸ¤ Microphone access denied:', err);
                                    alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                                });
                        } else {
                            // getUserMediaãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ç›´æ¥é–‹å§‹ã‚’è©¦è¡Œ
                            recognition.start();
                        }
                    } catch (error) {
                        console.error('ğŸ¤ Failed to start recognition:', error);
                        alert('éŸ³å£°èªè­˜ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + error.message);
                    }
                }
            }
        }
        
        // éŸ³å£°ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
        function updateVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            if (!voiceButton) return;
            
            if (isRecording) {
                voiceButton.textContent = 'â¹ï¸ åœæ­¢';
                voiceButton.classList.add('voice-recording');
            } else {
                voiceButton.textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›';
                voiceButton.classList.remove('voice-recording');
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(e) {
            console.error('âŒ Page error:', e.error);
        });
        
        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹å‰ã®ç¢ºèª
        window.addEventListener('beforeunload', function(e) {
            if (messageCount > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        console.log('ğŸ“œ Conversation script loaded');
    </script>
</body>
</html>