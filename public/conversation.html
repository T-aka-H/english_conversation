<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªã‚³ã‚½ç·´ã‚¢ãƒ—ãƒª - è‹±ä¼šè©±ç·´ç¿’</title>
    <link rel="icon" href="data:,">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #4A90E2;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .session-details {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .session-item {
            text-align: center;
        }

        .session-item .label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .session-item .value {
            font-size: 16px;
            font-weight: 600;
            color: #4A90E2;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-right: auto;
        }

        .message .role {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message .content {
            font-size: 15px;
            line-height: 1.5;
        }

        .message .timestamp {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 8px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .user-input {
            width: 100%;
            min-height: 60px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .user-input:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.3);
        }

        .user-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .voice-button {
            padding: 15px;
            background: linear-gradient(135deg, #28a745, #20a042);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            width: 60px;
            height: 60px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        .voice-button.recording {
            background: linear-gradient(135deg, #dc3545, #c82333);
            animation: pulse 1.5s infinite;
        }

        .voice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .send-button:hover {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 144, 226, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .control-button {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .control-button.end-session {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
        }

        .control-button.end-session:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 20px;
            max-width: 80%;
        }

        .typing-indicator .dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: #4A90E2;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .input-guide {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .input-guide strong {
            color: #4A90E2;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }

        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 167, 69, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            display: none;
        }

        .status-message.error {
            background: rgba(220, 53, 69, 0.95);
        }

        .status-message.warning {
            background: rgba(255, 193, 7, 0.95);
            color: black;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; transform: scale(1); }
            30% { opacity: 1; transform: scale(1.2); }
        }

        /* iOS Safariå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @supports (-webkit-touch-callout: none) {
            .voice-button {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            .user-input {
                -webkit-appearance: none;
                border-radius: 12px;
                font-size: 16px; /* iOS Safari ã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
            }
            
            .voice-button:active {
                transform: scale(0.95);
            }
        }
        
        /* iPhoneç”¨ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
        @media only screen and (max-device-width: 812px) and (-webkit-device-pixel-ratio: 3) {
            .voice-button {
                width: 70px;
                height: 70px;
                font-size: 24px;
            }
            
            .status-message {
                font-size: 16px;
                padding: 12px 24px;
            }
        }
    </style>
</head>

<body>
    <div id="statusMessage" class="status-message"></div>
    
    <div class="container">
        <div class="header">
            <h1>è‹±èªã‚³ã‚½ç·´ã‚¢ãƒ—ãƒª</h1>
        </div>

        <div class="session-info">
            <div class="session-details">
                <div class="session-item">
                    <div class="label">ã‚·ãƒŠãƒªã‚ª</div>
                    <div class="value" id="scenarioName">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div class="session-item">
                    <div class="label">é›£æ˜“åº¦</div>
                    <div class="value" id="difficultyLevel">--</div>
                </div>
                <div class="session-item">
                    <div class="label">çµŒéæ™‚é–“</div>
                    <div class="value" id="sessionTimer">00:00</div>
                </div>
                <div class="session-item">
                    <div class="label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</div>
                    <div class="value" id="messageCount">0</div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai">
                <div class="role">AI Assistant</div>
                <div class="content" id="initialMessage">ä¼šè©±ã‚’åˆæœŸåŒ–ä¸­...</div>
                <div class="timestamp" id="initialTimestamp"></div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="role">AI Assistant</div>
                <div class="dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="userInput" 
                        class="user-input" 
                        placeholder="è‹±èªã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„... (éŸ³å£°å…¥åŠ›ã‚‚å¯èƒ½)"
                        rows="3"
                    ></textarea>
                </div>
                <div class="input-buttons">
                    <button id="voiceButton" class="voice-button" title="éŸ³å£°å…¥åŠ›">
                        ğŸ¤
                    </button>
                    <button id="sendButton" class="send-button">
                        é€ä¿¡
                    </button>
                </div>
            </div>
            
            <div class="input-guide">
                <p><strong>ğŸ’¡ ç·´ç¿’ã®ã‚³ãƒ„:</strong></p>
                <p>â€¢ è‡ªç„¶ãªè‹±èªè¡¨ç¾ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†</p>
                <p>â€¢ å…·ä½“çš„ãªå†…å®¹ã§ä¼šè©±ã‚’æ·±ã‚ã¾ã—ã‚‡ã†</p>
                <p>â€¢ ğŸ¤ãƒœã‚¿ãƒ³ã§éŸ³å£°å…¥åŠ›ã‚‚æ´»ç”¨ã§ãã¾ã™</p>
            </div>
        </div>

        <div class="control-buttons">
            <button class="control-button" onclick="pauseSession()">
                ä¸€æ™‚åœæ­¢
            </button>
            <button class="control-button" onclick="saveProgress()">
                é€²æ—ä¿å­˜
            </button>
            <button class="control-button end-session" onclick="endSession()">
                ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
            </button>
        </div>

        <div class="footer">
            <p>developed by T.H.</p>
        </div>
    </div>

    <script>
        console.log('ğŸ’¬ Conversation page loaded');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let conversationHistory = [];
        let sessionStartTime = Date.now();
        let sessionTimer = null;
        let messageCounter = 0;
        let currentScenario = 'ãƒ“ã‚¸ãƒã‚¹è‹±ä¼šè©±ç·´ç¿’';
        let currentDifficulty = 'normal';
        let recognition = null;
        let isRecording = false;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOM Content Loaded');
            
            try {
                // èªè¨¼ãƒã‚§ãƒƒã‚¯
                if (!checkAuthentication()) {
                    return;
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
                loadSessionInfo();
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã‚’é–‹å§‹
                startSessionTimer();
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupEventListeners();
                
                // åˆæœŸåŒ–å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                showStatus('ã‚¢ãƒ—ãƒªãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ', 'success');
                
                // éŸ³å£°èªè­˜ã‚’åˆæœŸåŒ–ï¼ˆé…å»¶å®Ÿè¡Œï¼‰
                setTimeout(initializeSpeechRecognition, 1000);
                
                console.log('âœ… Conversation session initialized');
                
            } catch (error) {
                console.error('âŒ Initialization error:', error);
                showStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        });

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        function checkAuthentication() {
            try {
                const isAuthenticated = sessionStorage.getItem('isAuthenticated');
                const authTime = sessionStorage.getItem('authTime');
                
                if (!isAuthenticated) {
                    console.log('âŒ No authentication found - redirecting to login');
                    alert('Please login first.');
                    window.location.replace('index.html');
                    return false;
                }
                
                // èªè¨¼ã®æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ24æ™‚é–“ï¼‰
                if (authTime) {
                    const currentTime = new Date().getTime();
                    const authTimeStamp = parseInt(authTime);
                    const hoursDiff = (currentTime - authTimeStamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        console.log('â° Authentication expired - clearing session');
                        sessionStorage.clear();
                        alert('Session expired. Please login again.');
                        window.location.replace('index.html');
                        return false;
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('âŒ Authentication check error:', error);
                alert('Authentication error. Please login again.');
                window.location.replace('index.html');
                return false;
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showStatus(message, type = 'success') {
            const statusElement = document.getElementById('statusMessage');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status-message ${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±èª­ã¿è¾¼ã¿
        function loadSessionInfo() {
            try {
                console.log('ğŸ“‹ Loading session info...');
                
                // sessionStorageã‹ã‚‰ã‚·ãƒŠãƒªã‚ªã¨é›£æ˜“åº¦ã‚’èª­ã¿è¾¼ã¿
                const storedScenario = sessionStorage.getItem('selectedScenario');
                const storedDifficulty = sessionStorage.getItem('selectedDifficulty');
                
                console.log('ğŸ“Š Stored scenario:', storedScenario);
                console.log('ğŸ“Š Stored difficulty:', storedDifficulty);
                
                // ã‚·ãƒŠãƒªã‚ªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚·ãƒŠãƒªã‚ªé¸æŠã«æˆ»ã‚‹
                if (!storedScenario) {
                    console.log('âŒ No scenario found - redirecting to scenario selection');
                    alert('ã‚·ãƒŠãƒªã‚ªãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚·ãƒŠãƒªã‚ªé¸æŠç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
                    window.location.href = 'scenario.html';
                    return;
                }
                
                // é›£æ˜“åº¦ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯é›£æ˜“åº¦é¸æŠã«æˆ»ã‚‹
                if (!storedDifficulty) {
                    console.log('âŒ No difficulty found - redirecting to difficulty selection');
                    alert('é›£æ˜“åº¦ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é›£æ˜“åº¦é¸æŠç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
                    window.location.href = 'difficulty.html';
                    return;
                }
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š
                currentScenario = storedScenario;
                currentDifficulty = storedDifficulty;
                
                console.log('âœ… Session info loaded:', {
                    scenario: currentScenario,
                    difficulty: currentDifficulty
                });
                
                // UIã«åæ˜ 
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = getDifficultyLabel(currentDifficulty);
                
                // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
                generateInitialMessage();
                
                console.log('âœ… Session info loaded successfully');
                
            } catch (error) {
                console.error('âŒ Error loading session info:', error);
                showStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚·ãƒŠãƒªã‚ªé¸æŠã«æˆ»ã‚‹
                setTimeout(() => {
                    window.location.href = 'scenario.html';
                }, 3000);
            }
        }

        // é›£æ˜“åº¦ãƒ©ãƒ™ãƒ«å–å¾—
        function getDifficultyLabel(difficulty) {
            const labels = {
                'easy': 'åˆç´š',
                'normal': 'ä¸­ç´š',
                'hard': 'ä¸Šç´š'
            };
            return labels[difficulty] || 'ä¸­ç´š';
        }

        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        function generateInitialMessage() {
            const scenarioLower = currentScenario.toLowerCase();
            let initialMessage = '';
            
            // ã‚·ãƒŠãƒªã‚ªã«å¿œã˜ãŸåˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (scenarioLower.includes('é›‘è«‡') || scenarioLower.includes('casual')) {
                initialMessage = "Hey there! Good to see you. How's your day going? I just grabbed a coffee - the weather's been pretty nice lately, hasn't it?";
            } else if (scenarioLower.includes('ä¼šé£Ÿ') || scenarioLower.includes('dinner')) {
                initialMessage = "Thank you for joining me for dinner today. This place has excellent reviews. How was your journey here? Have you tried this type of cuisine before?";
            } else if (scenarioLower.includes('ã‚¢ãƒ') || scenarioLower.includes('appointment') || scenarioLower.includes('é›»è©±')) {
                initialMessage = "Hello, thank you for calling. I understand you'd like to schedule a meeting with us. I'd be happy to help you find a suitable time. What works best for your schedule?";
            } else if (scenarioLower.includes('ã‚¿ã‚¹ã‚¯') || scenarioLower.includes('task') || scenarioLower.includes('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«')) {
                initialMessage = "Good morning! Let's review our project status. I've been looking at our timeline and I think we need to clarify a few things. What's the current status on your deliverables?";
            } else if (scenarioLower.includes('ãƒ—ãƒ¬ã‚¼ãƒ³') || scenarioLower.includes('presentation') || scenarioLower.includes('è³ªç–‘')) {
                initialMessage = "Thank you for that comprehensive presentation. I have several questions about your proposal. First, could you clarify the expected ROI and timeline for implementation?";
            } else if (scenarioLower.includes('m&a') || scenarioLower.includes('äº¤æ¸‰') || scenarioLower.includes('ä¾¡æ ¼')) {
                initialMessage = "Good afternoon. I appreciate you taking the time to meet with us today to discuss this acquisition opportunity. We've reviewed your proposal, and I'd like to discuss our valuation concerns.";
            } else if (scenarioLower.includes('ä¼šè­°') || scenarioLower.includes('meeting')) {
                initialMessage = "Good morning! Thanks for joining today's meeting. I'm excited to discuss our project progress with you. How has your week been going so far?";
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ˆã‚Šå…·ä½“çš„ãªæ¥­å‹™ã‚·ãƒŠãƒªã‚ªã«å¯¾å¿œï¼‰
                initialMessage = "Hello! I'm ready to engage in our business scenario. Let's make this conversation productive and realistic. How would you like to begin?";
            }
            
            // é›£æ˜“åº¦ã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª¿æ•´
            if (currentDifficulty === 'hard') {
                initialMessage += " I expect detailed responses and professional business language.";
            }
            
            // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            document.getElementById('initialMessage').textContent = initialMessage;
            document.getElementById('initialTimestamp').textContent = new Date().toLocaleTimeString('ja-JP');
            
            // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
            conversationHistory.push({
                role: 'ai',
                content: initialMessage,
                timestamp: new Date().toISOString()
            });
            
            console.log('ğŸ’¬ Initial message generated for scenario:', currentScenario);
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const voiceButton = document.getElementById('voiceButton');
            
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
            
            if (userInput) {
                userInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            if (voiceButton) {
                voiceButton.addEventListener('click', toggleVoiceInput);
            }
            
            console.log('ğŸ§ Event listeners set up');
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) {
                showStatus('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            console.log('ğŸ“¤ Sending message:', message);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            addMessage('user', message);
            
            // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            userInput.value = '';
            
            // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.disabled = true;
            }
            
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
            showTypingIndicator();
            
            // AIã®å¿œç­”ã‚’ç”Ÿæˆï¼ˆé…å»¶ä»˜ãï¼‰
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                hideTypingIndicator();
                addMessage('ai', aiResponse);
                
                if (sendButton) {
                    sendButton.disabled = false;
                }
                userInput.focus();
            }, 1500 + Math.random() * 1000);
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const roleSpan = document.createElement('div');
            roleSpan.className = 'role';
            roleSpan.textContent = role === 'user' ? 'You' : 'AI Assistant';
            
            const contentSpan = document.createElement('div');
            contentSpan.className = 'content';
            contentSpan.textContent = content;
            
            const timestampSpan = document.createElement('div');
            timestampSpan.className = 'timestamp';
            timestampSpan.textContent = new Date().toLocaleTimeString('ja-JP');
            
            messageDiv.appendChild(roleSpan);
            messageDiv.appendChild(contentSpan);
            messageDiv.appendChild(timestampSpan);
            
            // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆæœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆï¼‰
            if (messageCounter === 0) {
                const initialMessage = chatContainer.querySelector('.message.ai');
                if (initialMessage && initialMessage.querySelector('#initialMessage')) {
                    chatContainer.removeChild(initialMessage);
                }
            }
            
            chatContainer.appendChild(messageDiv);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ›´æ–°
            messageCounter++;
            document.getElementById('messageCount').textContent = messageCounter;
            
            // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
            conversationHistory.push({
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            });
            
            console.log(`âœ… Message added: ${role} - ${content.substring(0, 50)}...`);
        }

        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'block';
                
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼éè¡¨ç¤º
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        }

        // AIå¿œç­”ç”Ÿæˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›è§£æç‰ˆï¼‰
        function generateAIResponse(userMessage) {
            const scenarioLower = currentScenario.toLowerCase();
            const difficultyLevel = currentDifficulty;
            const messageLower = userMessage.toLowerCase();
            
            console.log('ğŸ¤– Generating AI response for scenario:', currentScenario);
            console.log('ğŸ¯ Difficulty level:', difficultyLevel);
            console.log('ğŸ’¬ User message:', userMessage);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€å†…å®¹ã‚’åˆ†æ
            const userIntent = analyzeUserMessage(messageLower);
            console.log('ğŸ” Analyzed user intent:', userIntent);
            
            let response = '';
            
            // ã‚·ãƒŠãƒªã‚ªåˆ¥ã®å¿œç­”ç”Ÿæˆ
            if (scenarioLower.includes('é›‘è«‡') || scenarioLower.includes('casual')) {
                response = generateCasualResponse(userMessage, userIntent);
            } else if (scenarioLower.includes('ä¼šé£Ÿ') || scenarioLower.includes('dinner')) {
                response = generateDinnerResponse(userMessage, userIntent);
            } else if (scenarioLower.includes('ã‚¢ãƒ') || scenarioLower.includes('appointment') || scenarioLower.includes('é›»è©±')) {
                response = generateAppointmentResponse(userMessage, userIntent);
            } else if (scenarioLower.includes('ã‚¿ã‚¹ã‚¯') || scenarioLower.includes('task') || scenarioLower.includes('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«')) {
                response = generateTaskResponse(userMessage, userIntent);
            } else if (scenarioLower.includes('ãƒ—ãƒ¬ã‚¼ãƒ³') || scenarioLower.includes('presentation') || scenarioLower.includes('è³ªç–‘')) {
                response = generatePresentationResponse(userMessage, userIntent);
            } else if (scenarioLower.includes('m&a') || scenarioLower.includes('äº¤æ¸‰') || scenarioLower.includes('ä¾¡æ ¼')) {
                response = generateNegotiationResponse(userMessage, userIntent);
            } else {
                response = generateBusinessResponse(userMessage, userIntent);
            }
            
            // é›£æ˜“åº¦ã«å¿œã˜ã¦å¿œç­”ã‚’èª¿æ•´
            if (difficultyLevel === 'hard') {
                response = enhanceResponseForHardMode(response, userIntent);
            }
            
            console.log('âœ… AI response generated:', response.substring(0, 50) + '...');
            return response;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ„å›³åˆ†æ
        function analyzeUserMessage(messageLower) {
            const intent = {
                type: 'statement',
                topics: [],
                sentiment: 'neutral',
                hasQuestion: false,
                timeReference: null,
                numbers: [],
                keywords: []
            };
            
            // è³ªå•ã®æ¤œå‡º
            if (messageLower.includes('?') || messageLower.startsWith('how') || messageLower.startsWith('what') || 
                messageLower.startsWith('when') || messageLower.startsWith('where') || messageLower.startsWith('why') ||
                messageLower.startsWith('do you') || messageLower.startsWith('can you') || messageLower.startsWith('would you')) {
                intent.type = 'question';
                intent.hasQuestion = true;
            }
            
            // æ„Ÿæƒ…ã®æ¤œå‡º
            if (messageLower.includes('good') || messageLower.includes('great') || messageLower.includes('excellent') || 
                messageLower.includes('happy') || messageLower.includes('pleased')) {
                intent.sentiment = 'positive';
            } else if (messageLower.includes('bad') || messageLower.includes('problem') || messageLower.includes('issue') || 
                       messageLower.includes('difficult') || messageLower.includes('concern')) {
                intent.sentiment = 'negative';
            }
            
            // ãƒˆãƒ”ãƒƒã‚¯ã®æ¤œå‡º
            const topicKeywords = {
                'time': ['time', 'schedule', 'deadline', 'meeting', 'appointment', 'clock', 'hour', 'minute', 'today', 'tomorrow', 'week', 'month'],
                'money': ['price', 'cost', 'budget', 'expensive', 'cheap', 'dollar', 'yen', 'revenue', 'profit', 'investment'],
                'family': ['family', 'wife', 'husband', 'children', 'kids', 'mother', 'father', 'parents', 'home'],
                'work': ['work', 'job', 'project', 'team', 'colleague', 'boss', 'client', 'customer', 'business'],
                'weather': ['weather', 'rain', 'sunny', 'cold', 'hot', 'temperature', 'storm', 'snow'],
                'food': ['food', 'restaurant', 'eat', 'lunch', 'dinner', 'coffee', 'drink', 'taste', 'delicious'],
                'travel': ['travel', 'trip', 'vacation', 'flight', 'hotel', 'country', 'city', 'visit'],
                'technology': ['technology', 'computer', 'software', 'app', 'digital', 'online', 'internet', 'system']
            };
            
            for (const [topic, keywords] of Object.entries(topicKeywords)) {
                if (keywords.some(keyword => messageLower.includes(keyword))) {
                    intent.topics.push(topic);
                }
            }
            
            // æ™‚é–“å‚ç…§ã®æ¤œå‡º
            if (messageLower.includes('yesterday') || messageLower.includes('last')) {
                intent.timeReference = 'past';
            } else if (messageLower.includes('tomorrow') || messageLower.includes('next') || messageLower.includes('will')) {
                intent.timeReference = 'future';
            } else if (messageLower.includes('today') || messageLower.includes('now') || messageLower.includes('currently')) {
                intent.timeReference = 'present';
            }
            
            // æ•°å­—ã®æ¤œå‡º
            const numberMatches = messageLower.match(/\d+/g);
            if (numberMatches) {
                intent.numbers = numberMatches;
            }
            
            return intent;
        }

        // é›‘è«‡ã‚·ãƒŠãƒªã‚ªã®å¿œç­”ç”Ÿæˆ
        function generateCasualResponse(userMessage, intent) {
            if (intent.hasQuestion) {
                if (intent.topics.includes('weather')) {
                    return "Yeah, the weather has been quite unpredictable lately! I actually had to change my weekend plans because of the rain. Do you have any outdoor activities planned?";
                } else if (intent.topics.includes('family')) {
                    return "That sounds wonderful! Family time is so important. I try to balance work and family life too. How do you usually spend time with them?";
                } else if (intent.topics.includes('work')) {
                    return "I know what you mean about work! It's been pretty busy here too. Are you working on any interesting projects lately?";
                } else {
                    return "That's a great question! I'd love to hear more about your thoughts on that. What's your experience been like?";
                }
            } else {
                if (intent.sentiment === 'positive') {
                    if (intent.topics.includes('food')) {
                        return "That sounds delicious! I'm always looking for new restaurant recommendations. What type of cuisine do they specialize in?";
                    } else if (intent.topics.includes('travel')) {
                        return "That sounds like an amazing trip! I love hearing about travel experiences. What was the highlight of your journey?";
                    } else {
                        return "That's fantastic to hear! It's always great when things go well. You seem to have a positive outlook on things.";
                    }
                } else if (intent.sentiment === 'negative') {
                    return "I'm sorry to hear that. These things can definitely be challenging sometimes. Is there anything that might help improve the situation?";
                } else {
                    return "That's interesting! I hadn't thought about it from that perspective. It's always good to get different viewpoints on things.";
                }
            }
        }

        // ä¼šé£Ÿã‚·ãƒŠãƒªã‚ªã®å¿œç­”ç”Ÿæˆ
        function generateDinnerResponse(userMessage, intent) {
            if (intent.topics.includes('food')) {
                return "I completely agree! The flavors here are exceptional. Have you tried their wine pairing recommendations? I find they really complement the dishes well.";
            } else if (intent.topics.includes('travel')) {
                return "That sounds like a fascinating cultural experience! Business travel can be exhausting, but it's wonderful when you get to experience local traditions. How do you find the work-life balance during international trips?";
            } else if (intent.topics.includes('family')) {
                return "Family traditions are so important for building relationships. In my family, we have similar gatherings during holidays. Do you find that business relationships benefit from these more personal interactions?";
            } else if (intent.hasQuestion) {
                return "That's an excellent question! In my experience, building trust through these informal settings really does translate to better business partnerships. What's been your observation?";
            } else {
                return "I appreciate you sharing that perspective! These dinner conversations often lead to the most valuable insights. It's amazing how much you can learn about someone over a good meal.";
            }
        }

        // ã‚¢ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ³ãƒˆã‚·ãƒŠãƒªã‚ªã®å¿œç­”ç”Ÿæˆ
        function generateAppointmentResponse(userMessage, intent) {
            if (intent.topics.includes('time')) {
                if (intent.numbers.length > 0) {
                    const time = intent.numbers[0];
                    return `${time} o'clock could work for me. Let me just double-check my calendar to make sure there are no conflicts. Would you prefer morning or afternoon for our discussion?`;
                } else if (intent.timeReference === 'future') {
                    return "I appreciate your flexibility with the timing. Let me check my availability for next week. Would Tuesday or Wednesday work better for your schedule?";
                } else {
                    return "I understand you're looking at different time options. My calendar is quite busy this week, but I can make some adjustments. What's the urgency level for this meeting?";
                }
            } else if (intent.topics.includes('work')) {
                return "That sounds like an important project discussion. To prepare properly for our meeting, could you give me a brief overview of the main topics you'd like to cover?";
            } else if (intent.hasQuestion) {
                return "Good question! For this type of discussion, I'd suggest we block out at least an hour to ensure we can cover everything thoroughly. Does that timeframe work for you?";
            } else {
                return "I understand your requirements for the meeting. Let me send you a calendar invitation with the proposed agenda. Should I include anyone else from my team in this discussion?";
            }
        }

        // ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ãƒŠãƒªã‚ªã®å¿œç­”ç”Ÿæˆ
        function generateTaskResponse(userMessage, intent) {
            if (intent.topics.includes('time')) {
                if (intent.timeReference === 'past') {
                    return "I see there were some delays in the previous phase. Can you help me understand what caused the bottleneck? We need to make sure we don't face similar issues moving forward.";
                } else if (intent.timeReference === 'future') {
                    return "Good forward planning! What dependencies do we need to consider for the upcoming milestones? I want to make sure we have all resources allocated properly.";
                } else {
                    return "Let's review the current timeline status. Are we still on track to meet our deliverable deadlines, or do we need to adjust expectations with stakeholders?";
                }
            } else if (intent.sentiment === 'negative') {
                return "I understand there are some challenges. Let's identify what support you need to get back on track. Should we escalate any blockers to senior management?";
            } else if (intent.sentiment === 'positive') {
                return "Excellent progress! That's exactly the kind of momentum we need. What factors contributed to this success that we can replicate in other areas?";
            } else if (intent.hasQuestion) {
                return "That's a valid concern to raise. Let me check with the stakeholders on their priorities. In the meantime, what alternative approaches are you considering?";
            } else {
                return "Thanks for the update. Based on what you've shared, I think we should schedule a checkpoint with the entire team. Can you prepare a brief status summary for tomorrow's standup?";
            }
        }

        // ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è³ªç–‘ã®å¿œç­”ç”Ÿæˆ
        function generatePresentationResponse(userMessage, intent) {
            if (intent.topics.includes('money')) {
                return "The financial projections are certainly ambitious. Can you walk me through the assumptions behind your revenue growth model? I'm particularly interested in your customer acquisition cost calculations.";
            } else if (intent.topics.includes('time')) {
                return "The timeline you've outlined is aggressive but achievable. What's your contingency plan if we encounter unexpected delays in the implementation phase? How would that impact your milestones?";
            } else if (intent.topics.includes('technology')) {
                return "The technology stack looks robust. However, I'm concerned about scalability. Have you stress-tested the system under peak load conditions? What's your disaster recovery plan?";
            } else if (intent.sentiment === 'positive') {
                return "I appreciate the thorough research you've presented. However, I need to challenge some of your market assumptions. How did you validate these with actual customer feedback?";
            } else if (intent.hasQuestion) {
                return "That's a crucial question that addresses one of my main concerns. The risk mitigation strategies need to be more detailed. Can you elaborate on your Plan B scenarios?";
            } else {
                return "Interesting approach, but I'm not entirely convinced about the competitive analysis. How do you plan to differentiate from the three major players already dominating this space?";
            }
        }

        // M&Aäº¤æ¸‰ã‚·ãƒŠãƒªã‚ªã®å¿œç­”ç”Ÿæˆ
        function generateNegotiationResponse(userMessage, intent) {
            if (intent.topics.includes('money')) {
                if (intent.numbers.length > 0) {
                    return `The ${intent.numbers[0]} million valuation is significantly higher than our internal assessment. Our due diligence suggests a fair value closer to industry benchmarks. Can you justify this premium based on synergies?`;
                } else {
                    return "I understand your position on the financial terms, but we need to bridge a significant gap. What specific value drivers justify your valuation methodology?";
                }
            } else if (intent.sentiment === 'negative') {
                return "I hear your concerns, and we want to address them constructively. However, we need to be realistic about market conditions. What concessions would make this deal viable for both parties?";
            } else if (intent.sentiment === 'positive') {
                return "I'm glad we're finding common ground on some aspects. Now let's tackle the more challenging terms. The indemnification clauses still need significant work from our legal team's perspective.";
            } else if (intent.hasQuestion) {
                return "That's a fair question that gets to the heart of the strategic rationale. Our board needs to see clear synergies that justify any premium. Can you quantify the expected cost savings?";
            } else {
                return "I appreciate your flexibility on this point. However, we still have concerns about the working capital adjustments and the earnout structure. Can we revisit those terms?";
            }
        }

        // ä¸€èˆ¬ãƒ“ã‚¸ãƒã‚¹å¿œç­”ç”Ÿæˆ
        function generateBusinessResponse(userMessage, intent) {
            if (intent.hasQuestion) {
                return "That's an excellent question that really gets to the core of what we're trying to achieve. Let me share my perspective and I'd love to hear your thoughts on potential solutions.";
            } else if (intent.sentiment === 'positive') {
                return "I'm glad you see the potential there! Your enthusiasm is contagious. How do you envision us moving forward with implementation?";
            } else if (intent.sentiment === 'negative') {
                return "I understand your concerns and they're completely valid. Let's work together to find a solution that addresses these challenges while still achieving our objectives.";
            } else {
                return "That's a valuable insight you've shared. It aligns well with what I've been observing in the market. What do you think the implications are for our strategy?";
            }
        }

        // ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ç”¨ã®å¿œç­”å¼·åŒ–
        function enhanceResponseForHardMode(response, intent) {
            const hardAdditions = [
                " Additionally, I'd like to understand the long-term strategic implications and potential risks we haven't discussed.",
                " From a governance perspective, how does this align with our compliance requirements and regulatory framework?",
                " I'm also interested in the stakeholder impact analysis and change management considerations.",
                " What are the key performance indicators we should be tracking, and how will we measure success?",
                " Have you considered the competitive response and how this positions us in the market landscape?"
            ];
            
            const randomAddition = hardAdditions[Math.floor(Math.random() * hardAdditions.length)];
            return response + randomAddition;
        }

        // éŸ³å£°èªè­˜åˆæœŸåŒ–
        function initializeSpeechRecognition() {
            console.log('ğŸ¤ Initializing speech recognition...');
            
            try {
                // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    throw new Error('éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // éŸ³å£°èªè­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // iOS/ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®è¨­å®š
                recognition.continuous = false;  // iOSã§ã¯ false ãŒæ¨å¥¨
                recognition.interimResults = false;  // iOSã§ã¯ false ãŒæ¨å¥¨
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                // iOS Safariç‰¹æœ‰ã®è¨­å®š
                if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                    console.log('ğŸ“± iOS device detected - applying iOS-specific settings');
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 3;  // iOSã§ã¯è¤‡æ•°å€™è£œã‚’å–å¾—
                }
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                recognition.onstart = function() {
                    console.log('ğŸ¤ Speech recognition started');
                    isRecording = true;
                    updateVoiceButton();
                    showStatus('ğŸ¤ éŸ³å£°èªè­˜é–‹å§‹ - è‹±èªã§è©±ã—ã¦ãã ã•ã„', 'success');
                    
                    // iOSç”¨ï¼šéŒ²éŸ³é–‹å§‹ã®ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    if (navigator.vibrate) {
                        navigator.vibrate(100);
                    }
                };
                
                recognition.onresult = function(event) {
                    console.log('ğŸ¤ Speech recognition result received');
                    console.log('ğŸ“Š Recognition event:', event);
                    
                    if (event.results && event.results.length > 0) {
                        // iOSå¯¾å¿œï¼šè¤‡æ•°ã®å€™è£œã‹ã‚‰æœ€é©ãªã‚‚ã®ã‚’é¸æŠ
                        let bestTranscript = '';
                        let highestConfidence = 0;
                        
                        for (let i = 0; i < event.results.length; i++) {
                            const result = event.results[i];
                            if (result.isFinal) {
                                for (let j = 0; j < result.length; j++) {
                                    const alternative = result[j];
                                    if (alternative.confidence > highestConfidence) {
                                        highestConfidence = alternative.confidence;
                                        bestTranscript = alternative.transcript;
                                    }
                                }
                            }
                        }
                        
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæœ€åˆã®çµæœã‚’ä½¿ç”¨
                        if (!bestTranscript && event.results[0] && event.results[0][0]) {
                            bestTranscript = event.results[0][0].transcript;
                        }
                        
                        console.log('ğŸ¤ Best transcript:', bestTranscript);
                        console.log('ğŸ¯ Confidence:', highestConfidence);
                        
                        if (bestTranscript && bestTranscript.trim().length > 0) {
                            const transcript = bestTranscript.trim();
                            const userInput = document.getElementById('userInput');
                            if (userInput) {
                                const currentText = userInput.value.trim();
                                userInput.value = currentText ? currentText + ' ' + transcript : transcript;
                                userInput.focus();
                                
                                // iOSç”¨ï¼šæˆåŠŸã®ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                                if (navigator.vibrate) {
                                    navigator.vibrate([50, 100, 50]);
                                }
                                
                                showStatus('âœ… éŸ³å£°èªè­˜æˆåŠŸ: ' + transcript, 'success');
                            }
                        } else {
                            console.log('âš ï¸ Empty transcript received');
                            showStatus('âš ï¸ éŸ³å£°ãŒèªè­˜ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„', 'warning');
                        }
                    } else {
                        console.log('âŒ No results in recognition event');
                        showStatus('âŒ éŸ³å£°èªè­˜çµæœãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('ğŸ¤ Speech recognition error:', event.error);
                    console.error('ğŸ” Error details:', event);
                    isRecording = false;
                    updateVoiceButton();
                    
                    let errorMessage = 'éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = 'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„';
                            break;
                        case 'audio-capture':
                            errorMessage = 'ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                            break;
                        case 'not-allowed':
                            errorMessage = 'ãƒã‚¤ã‚¯ã®ä½¿ç”¨è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                            break;
                        case 'network':
                            errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                            break;
                        case 'aborted':
                            errorMessage = 'éŸ³å£°èªè­˜ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸ';
                            break;
                        case 'bad-grammar':
                            errorMessage = 'éŸ³å£°èªè­˜ã®è¨­å®šã‚¨ãƒ©ãƒ¼ã§ã™';
                            break;
                        default:
                            errorMessage = `éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`;
                    }
                    
                    showStatus(errorMessage, 'error');
                    
                    // iOSç”¨ï¼šã‚¨ãƒ©ãƒ¼ã®ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    if (navigator.vibrate) {
                        navigator.vibrate([200, 100, 200]);
                    }
                };
                
                recognition.onend = function() {
                    console.log('ğŸ¤ Speech recognition ended');
                    isRecording = false;
                    updateVoiceButton();
                    
                    // iOSç”¨ï¼šçŸ­ã„ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                };
                
                // iOS Safariç”¨ã®è¿½åŠ è¨­å®š
                recognition.onnomatch = function() {
                    console.log('ğŸ¤ No match found');
                    showStatus('âš ï¸ éŸ³å£°ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„', 'warning');
                };
                
                recognition.onsoundstart = function() {
                    console.log('ğŸ¤ Sound detected');
                };
                
                recognition.onsoundend = function() {
                    console.log('ğŸ¤ Sound ended');
                };
                
                recognition.onspeechstart = function() {
                    console.log('ğŸ¤ Speech detected');
                };
                
                recognition.onspeechend = function() {
                    console.log('ğŸ¤ Speech ended');
                };
                
                console.log('âœ… Speech recognition initialized successfully');
                showStatus('ğŸ¤ éŸ³å£°èªè­˜ãŒåˆ©ç”¨å¯èƒ½ã§ã™ï¼ˆè‹±èªãƒ¢ãƒ¼ãƒ‰ï¼‰', 'success');
                
                // iOSç”¨ã®åˆæœŸåŒ–å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                    setTimeout(() => {
                        showStatus('ğŸ“± iOSç”¨éŸ³å£°èªè­˜ï¼šãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã¦ãã ã•ã„', 'success');
                    }, 2000);
                }
                
            } catch (error) {
                console.error('âŒ Failed to initialize speech recognition:', error);
                
                const voiceButton = document.getElementById('voiceButton');
                if (voiceButton) {
                    voiceButton.disabled = true;
                    voiceButton.textContent = 'ğŸš«';
                    voiceButton.title = 'éŸ³å£°èªè­˜åˆ©ç”¨ä¸å¯';
                }
                
                showStatus('éŸ³å£°èªè­˜ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
            }
        }

        // éŸ³å£°å…¥åŠ›ãƒˆã‚°ãƒ«ï¼ˆiOSå¯¾å¿œç‰ˆï¼‰
        function toggleVoiceInput() {
            console.log('ğŸ¤ Toggle voice input, isRecording:', isRecording);
            
            if (!recognition) {
                showStatus('éŸ³å£°èªè­˜ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãŒå¿…è¦ãªãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ
            const userInput = document.getElementById('userInput');
            if (userInput) {
                userInput.focus(); // iOS Safariç”¨
            }
            
            if (isRecording) {
                try {
                    recognition.stop();
                    isRecording = false;
                    updateVoiceButton();
                    showStatus('ğŸ›‘ éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'success');
                } catch (error) {
                    console.error('ğŸ¤ Error stopping recognition:', error);
                    isRecording = false;
                    updateVoiceButton();
                }
            } else {
                try {
                    // iOSç”¨ï¼šæ˜ç¤ºçš„ã«ãƒã‚¤ã‚¯è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        navigator.mediaDevices.getUserMedia({ audio: true })
                            .then(function(stream) {
                                console.log('ğŸ¤ Microphone access granted');
                                stream.getTracks().forEach(track => track.stop()); // ã™ãã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                                
                                // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰éŸ³å£°èªè­˜ã‚’é–‹å§‹
                                setTimeout(() => {
                                    try {
                                        recognition.start();
                                    } catch (startError) {
                                        console.error('ğŸ¤ Error starting recognition after permission:', startError);
                                        showStatus('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                                    }
                                }, 100);
                            })
                            .catch(function(error) {
                                console.error('ğŸ¤ Microphone access denied:', error);
                                showStatus('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
                            });
                    } else {
                        // getUserMediaãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ç›´æ¥é–‹å§‹
                        recognition.start();
                    }
                } catch (error) {
                    console.error('ğŸ¤ Error starting recognition:', error);
                    showStatus('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            }
        }

        // éŸ³å£°ãƒœã‚¿ãƒ³æ›´æ–°
        function updateVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            if (!voiceButton) return;
            
            if (isRecording) {
                voiceButton.classList.add('recording');
                voiceButton.textContent = 'ğŸ”´';
                voiceButton.title = 'éŒ²éŸ³ä¸­ - ã‚¯ãƒªãƒƒã‚¯ã§åœæ­¢';
            } else {
                voiceButton.classList.remove('recording');
                voiceButton.textContent = 'ğŸ¤';
                voiceButton.title = 'ã‚¯ãƒªãƒƒã‚¯ã§éŸ³å£°å…¥åŠ›é–‹å§‹';
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€æ™‚åœæ­¢
        function pauseSession() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
                showStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ', 'success');
                
                // å†é–‹ãƒœã‚¿ãƒ³ã«å¤‰æ›´
                const pauseButton = event.target;
                pauseButton.textContent = 'å†é–‹';
                pauseButton.onclick = resumeSession;
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹
        function resumeSession() {
            startSessionTimer();
            showStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å†é–‹ã—ã¾ã—ãŸ', 'success');
            
            // ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ã«æˆ»ã™
            const resumeButton = event.target;
            resumeButton.textContent = 'ä¸€æ™‚åœæ­¢';
            resumeButton.onclick = pauseSession;
        }

        // é€²æ—ä¿å­˜
        function saveProgress() {
            try {
                const progressData = {
                    conversationHistory: conversationHistory,
                    messageCount: messageCounter,
                    sessionTime: Date.now() - sessionStartTime,
                    scenario: currentScenario,
                    difficulty: currentDifficulty,
                    timestamp: new Date().toISOString()
                };
                
                // ãƒ¡ãƒ¢ãƒªå†…ä¿å­˜ï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ localStorage ã‚„ ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼‰
                console.log('ğŸ’¾ Progress saved:', progressData);
                showStatus('é€²æ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('âŒ Error saving progress:', error);
                showStatus('é€²æ—ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
        function endSession() {
            if (confirm('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nçµ‚äº†å¾Œã«Final ReportãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚')) {
                // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                    sessionTimer = null;
                }
                
                // éŸ³å£°èªè­˜åœæ­¢
                if (recognition && isRecording) {
                    try {
                        recognition.stop();
                        isRecording = false;
                        updateVoiceButton();
                    } catch (error) {
                        console.error('Error stopping recognition:', error);
                    }
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                const sessionEndTime = Date.now();
                const totalSessionTime = sessionEndTime - sessionStartTime;
                const sessionMinutes = Math.floor(totalSessionTime / 60000);
                const sessionSeconds = Math.floor((totalSessionTime % 60000) / 1000);
                
                // final-report.htmlç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
                sessionStorage.setItem('messageCount', messageCounter.toString());
                sessionStorage.setItem('sessionDuration', `${sessionMinutes}åˆ†${sessionSeconds}ç§’`);
                sessionStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
                sessionStorage.setItem('sessionStartTime', sessionStartTime.toString());
                sessionStorage.setItem('sessionEndTime', sessionEndTime.toString());
                
                // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                const userMessages = conversationHistory.filter(msg => msg.role === 'user');
                const totalWords = userMessages.reduce((total, msg) => {
                    return total + msg.content.split(' ').filter(word => word.length > 0).length;
                }, 0);
                const avgWordsPerMessage = userMessages.length > 0 ? Math.round(totalWords / userMessages.length) : 0;
                
                const overallScore = Math.min(100, Math.max(60, 
                    (messageCounter * 5) + (avgWordsPerMessage * 2) + 40));
                const fluencyScore = Math.min(100, Math.max(50, overallScore + Math.random() * 20 - 10));
                const accuracyScore = Math.min(100, Math.max(50, overallScore + Math.random() * 20 - 10));
                
                sessionStorage.setItem('overallScore', overallScore.toString());
                sessionStorage.setItem('fluencyScore', fluencyScore.toString());
                sessionStorage.setItem('accuracyScore', accuracyScore.toString());
                sessionStorage.setItem('averageMessageLength', avgWordsPerMessage.toString());
                sessionStorage.setItem('voiceUsageCount', '0'); // éŸ³å£°ä½¿ç”¨å›æ•°ï¼ˆå®Ÿè£…å¿…è¦ï¼‰
                
                showStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚Final Reportãƒšãƒ¼ã‚¸ã«ç§»å‹•ä¸­...', 'success');
                
                // Final Reportãƒšãƒ¼ã‚¸ã«é·ç§»
                setTimeout(() => {
                    window.location.href = 'final-report.html';
                }, 2000);
            }
        }

        // Final Reportç”Ÿæˆ
        function generateFinalReport() {
            const sessionEndTime = Date.now();
            const totalSessionTime = sessionEndTime - sessionStartTime;
            const sessionMinutes = Math.floor(totalSessionTime / 60000);
            const sessionSeconds = Math.floor((totalSessionTime % 60000) / 1000);
            
            // ä¼šè©±åˆ†æ
            const userMessages = conversationHistory.filter(msg => msg.role === 'user');
            const aiMessages = conversationHistory.filter(msg => msg.role === 'ai');
            
            // å˜èªæ•°è¨ˆç®—
            const totalUserWords = userMessages.reduce((total, msg) => {
                return total + msg.content.split(' ').filter(word => word.length > 0).length;
            }, 0);
            
            // å¹³å‡å¿œç­”æ™‚é–“ï¼ˆæ¨å®šï¼‰
            const avgResponseTime = userMessages.length > 0 ? Math.round(totalSessionTime / userMessages.length / 1000) : 0;
            
            // å­¦ç¿’ãƒ¬ãƒ™ãƒ«è©•ä¾¡
            const vocabularyLevel = evaluateVocabularyLevel(userMessages);
            const fluencyScore = evaluateFluency(userMessages, totalSessionTime);
            const engagementScore = evaluateEngagement(userMessages, aiMessages);
            
            // Final Reportãƒ‡ãƒ¼ã‚¿
            const finalReport = {
                sessionInfo: {
                    scenario: currentScenario,
                    difficulty: currentDifficulty,
                    startTime: new Date(sessionStartTime).toLocaleString('ja-JP'),
                    endTime: new Date(sessionEndTime).toLocaleString('ja-JP'),
                    duration: `${sessionMinutes}åˆ†${sessionSeconds}ç§’`
                },
                statistics: {
                    totalMessages: messageCounter,
                    userMessages: userMessages.length,
                    aiMessages: aiMessages.length,
                    totalWords: totalUserWords,
                    averageWordsPerMessage: userMessages.length > 0 ? Math.round(totalUserWords / userMessages.length) : 0,
                    averageResponseTime: `${avgResponseTime}ç§’`
                },
                performance: {
                    vocabularyLevel: vocabularyLevel,
                    fluencyScore: fluencyScore,
                    engagementScore: engagementScore,
                    overallScore: Math.round((vocabularyLevel + fluencyScore + engagementScore) / 3)
                },
                recommendations: generateRecommendations(vocabularyLevel, fluencyScore, engagementScore),
                conversationSample: getConversationSample(userMessages)
            };
            
            // ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
            displayFinalReport(finalReport);
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªå½¢å¼ã§ä¿å­˜
            saveFinalReportAsFile(finalReport);
            
            console.log('ğŸ“Š Final Report generated:', finalReport);
            return finalReport;
        }
        
        // èªå½™ãƒ¬ãƒ™ãƒ«è©•ä¾¡
        function evaluateVocabularyLevel(userMessages) {
            if (userMessages.length === 0) return 0;
            
            const allWords = userMessages.join(' ').toLowerCase().split(/\s+/);
            const uniqueWords = new Set(allWords.filter(word => word.length > 3));
            const vocabularyDiversity = uniqueWords.size / allWords.length;
            
            // è¤‡é›‘ãªå˜èªã®ä½¿ç”¨é »åº¦ã‚’ãƒã‚§ãƒƒã‚¯
            const complexWords = allWords.filter(word => word.length > 6).length;
            const complexityRatio = complexWords / allWords.length;
            
            const score = Math.min(100, Math.round((vocabularyDiversity * 50) + (complexityRatio * 50)));
            return Math.max(10, score); // æœ€ä½10ç‚¹
        }
        
        // æµæš¢æ€§è©•ä¾¡
        function evaluateFluency(userMessages, totalTime) {
            if (userMessages.length === 0) return 0;
            
            const totalWords = userMessages.reduce((total, msg) => {
                return total + msg.content.split(' ').length;
            }, 0);
            
            const wordsPerMinute = (totalWords / (totalTime / 60000));
            const messageFrequency = userMessages.length / (totalTime / 60000);
            
            // é©åº¦ãªãƒšãƒ¼ã‚¹ã‚’è©•ä¾¡ï¼ˆæ—©ã™ããšé…ã™ããšï¼‰
            const paceScore = Math.min(100, Math.max(0, (wordsPerMinute / 50) * 100));
            const frequencyScore = Math.min(100, messageFrequency * 20);
            
            return Math.round((paceScore + frequencyScore) / 2);
        }
        
        // ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆè©•ä¾¡
        function evaluateEngagement(userMessages, aiMessages) {
            if (userMessages.length === 0) return 0;
            
            // è³ªå•ã®ä½¿ç”¨é »åº¦
            const questionsCount = userMessages.filter(msg => msg.content.includes('?')).length;
            const questionRatio = questionsCount / userMessages.length;
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é•·ã•ã®å¤šæ§˜æ€§
            const messageLengths = userMessages.map(msg => msg.content.length);
            const avgLength = messageLengths.reduce((a, b) => a + b, 0) / messageLengths.length;
            const lengthVariance = messageLengths.reduce((acc, len) => acc + Math.pow(len - avgLength, 2), 0) / messageLengths.length;
            
            const engagementScore = Math.min(100, (questionRatio * 40) + (Math.sqrt(lengthVariance) / 10) + 20);
            return Math.round(engagementScore);
        }
        
        // æ¨å¥¨äº‹é …ç”Ÿæˆ
        function generateRecommendations(vocab, fluency, engagement) {
            const recommendations = [];
            
            if (vocab < 50) {
                recommendations.push("ğŸ“š èªå½™åŠ›å‘ä¸Š: ã‚ˆã‚Šå¤šæ§˜ãªå˜èªã‚’ä½¿ã£ã¦è¡¨ç¾ã—ã¦ã¿ã¾ã—ã‚‡ã†");
            }
            if (fluency < 50) {
                recommendations.push("âš¡ æµæš¢æ€§å‘ä¸Š: ã‚‚ã†å°‘ã—æ—©ã„ãƒšãƒ¼ã‚¹ã§ä¼šè©±ã—ã¦ã¿ã¾ã—ã‚‡ã†");
            }
            if (engagement < 50) {
                recommendations.push("ğŸ¤ ç©æ¥µæ€§å‘ä¸Š: ã‚ˆã‚Šå¤šãã®è³ªå•ã‚’ã—ã¦ä¼šè©±ã‚’æ·±ã‚ã¾ã—ã‚‡ã†");
            }
            
            // ãƒã‚¸ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚‚è¿½åŠ 
            if (vocab >= 70) {
                recommendations.push("âœ¨ ç´ æ™´ã‚‰ã—ã„èªå½™åŠ›ã§ã™ï¼ã“ã®èª¿å­ã§ç¶šã‘ã¾ã—ã‚‡ã†");
            }
            if (fluency >= 70) {
                recommendations.push("ğŸ¯ æµæš¢ãªä¼šè©±ãŒã§ãã¦ã„ã¾ã™ï¼");
            }
            if (engagement >= 70) {
                recommendations.push("ğŸŒŸ ç©æ¥µçš„ãªå‚åŠ ã€ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼");
            }
            
            return recommendations;
        }
        
        // ä¼šè©±ã‚µãƒ³ãƒ—ãƒ«å–å¾—
        function getConversationSample(userMessages) {
            if (userMessages.length === 0) return "No conversation recorded.";
            
            // æœ€ã‚‚é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
            const longestMessage = userMessages.reduce((longest, current) => {
                return current.content.length > longest.content.length ? current : longest;
            });
            
            return longestMessage.content;
        }
        
        // Final Reportè¡¨ç¤º
        function displayFinalReport(report) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const reportDiv = document.createElement('div');
            reportDiv.className = 'message ai final-report';
            reportDiv.style.maxWidth = '95%';
            reportDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            
            reportDiv.innerHTML = `
                <div class="role">ğŸ“Š FINAL REPORT</div>
                <div class="content">
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">ğŸ¯ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¦‚è¦</h3>
                        <p><strong>ã‚·ãƒŠãƒªã‚ª:</strong> ${report.sessionInfo.scenario}</p>
                        <p><strong>é›£æ˜“åº¦:</strong> ${getDifficultyLabel(report.sessionInfo.difficulty)}</p>
                        <p><strong>å®Ÿæ–½æ™‚é–“:</strong> ${report.sessionInfo.duration}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">ğŸ“ˆ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿</h3>
                        <p><strong>ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:</strong> ${report.statistics.totalMessages}</p>
                        <p><strong>ã‚ãªãŸã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${report.statistics.userMessages}</p>
                        <p><strong>ç·å˜èªæ•°:</strong> ${report.statistics.totalWords}</p>
                        <p><strong>1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¹³å‡å˜èªæ•°:</strong> ${report.statistics.averageWordsPerMessage}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">â­ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡</h3>
                        <p><strong>èªå½™åŠ›ã‚¹ã‚³ã‚¢:</strong> ${report.performance.vocabularyLevel}/100</p>
                        <p><strong>æµæš¢æ€§ã‚¹ã‚³ã‚¢:</strong> ${report.performance.fluencyScore}/100</p>
                        <p><strong>ç©æ¥µæ€§ã‚¹ã‚³ã‚¢:</strong> ${report.performance.engagementScore}/100</p>
                        <p style="font-size: 18px; color: #ffeb3b;"><strong>ç·åˆã‚¹ã‚³ã‚¢: ${report.performance.overallScore}/100</strong></p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">ğŸ’¡ æ”¹å–„ææ¡ˆ</h3>
                        ${report.recommendations.map(rec => `<p>â€¢ ${rec}</p>`).join('')}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">ğŸ“ ãƒ™ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
                        <p style="font-style: italic; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
                            "${report.conversationSample}"
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="downloadReport()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                    </div>
                </div>
                <div class="timestamp">${new Date().toLocaleTimeString('ja-JP')}</div>
            `;
            
            chatContainer.appendChild(reportDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
        function saveFinalReportAsFile(report) {
            window.finalReportData = report; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã«
            
            const reportText = `
ENGLISH CONVERSATION PRACTICE - FINAL REPORT
=============================================

Session Information:
- Scenario: ${report.sessionInfo.scenario}
- Difficulty: ${getDifficultyLabel(report.sessionInfo.difficulty)}
- Start Time: ${report.sessionInfo.startTime}
- End Time: ${report.sessionInfo.endTime}
- Duration: ${report.sessionInfo.duration}

Statistics:
- Total Messages: ${report.statistics.totalMessages}
- Your Messages: ${report.statistics.userMessages}
- Total Words: ${report.statistics.totalWords}
- Average Words per Message: ${report.statistics.averageWordsPerMessage}
- Average Response Time: ${report.statistics.averageResponseTime}

Performance Evaluation:
- Vocabulary Level: ${report.performance.vocabularyLevel}/100
- Fluency Score: ${report.performance.fluencyScore}/100
- Engagement Score: ${report.performance.engagementScore}/100
- Overall Score: ${report.performance.overallScore}/100

Recommendations:
${report.recommendations.map(rec => `- ${rec}`).join('\n')}

Best Message Sample:
"${report.conversationSample}"

Generated on: ${new Date().toLocaleString('ja-JP')}
            `;
            
            console.log('ğŸ“„ Final report prepared for download');
            window.finalReportText = reportText;
        }
        
        // ãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function downloadReport() {
            if (!window.finalReportText) {
                showStatus('ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            const blob = new Blob([window.finalReportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `English_Practice_Report_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦ç™»éŒ²
        window.downloadReport = downloadReport;

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(event) {
            console.error('âŒ Global error:', event.error);
            showStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + event.error.message, 'error');
        });

        // æœªå‡¦ç†ã® Promise ã‚¨ãƒ©ãƒ¼
        window.addEventListener('unhandledrejection', function(event) {
            console.error('âŒ Unhandled promise rejection:', event.reason);
            showStatus('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        });

        // ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã‚‹å‰ã®ç¢ºèª
        window.addEventListener('beforeunload', function(event) {
            if (messageCounter > 0) {
                event.preventDefault();
                event.returnValue = 'ä¼šè©±ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ã€‚æœ¬å½“ã«çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ';
                return event.returnValue;
            }
        });

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
        function showDebugInfo() {
            console.log('ğŸ” Debug Info:', {
                messageCounter,
                conversationHistory: conversationHistory.length,
                isRecording,
                currentScenario,
                currentDifficulty,
                speechRecognitionAvailable: !!recognition,
                userAgent: navigator.userAgent
            });
        }

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«
        window.showDebugInfo = showDebugInfo;
        
        console.log('âœ… Application fully loaded and ready');
        console.log('ğŸ’¡ Type showDebugInfo() in console for debug information');
    </script>
</body>
</html>