<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語コソ練アプリ - 英会話練習</title>
    <link rel="icon" href="data:,">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #4A90E2;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .session-details {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .session-item {
            text-align: center;
        }

        .session-item .label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .session-item .value {
            font-size: 16px;
            font-weight: 600;
            color: #4A90E2;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-right: auto;
        }

        .message .role {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message .content {
            font-size: 15px;
            line-height: 1.5;
        }

        .message .timestamp {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 8px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .user-input {
            width: 100%;
            min-height: 60px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .user-input:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.3);
        }

        .user-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .voice-button {
            padding: 15px;
            background: linear-gradient(135deg, #28a745, #20a042);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            width: 60px;
            height: 60px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        .voice-button.recording {
            background: linear-gradient(135deg, #dc3545, #c82333);
            animation: pulse 1.5s infinite;
        }

        .voice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .send-button:hover {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 144, 226, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .control-button {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .control-button.end-session {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
        }

        .control-button.end-session:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 20px;
            max-width: 80%;
        }

        .typing-indicator .dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: #4A90E2;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .input-guide {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .input-guide strong {
            color: #4A90E2;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }

        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 167, 69, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            display: none;
        }

        .status-message.error {
            background: rgba(220, 53, 69, 0.95);
        }

        .status-message.warning {
            background: rgba(255, 193, 7, 0.95);
            color: black;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; transform: scale(1); }
            30% { opacity: 1; transform: scale(1.2); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .session-details {
                flex-direction: column;
                gap: 15px;
            }
            
            .input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-buttons {
                flex-direction: row;
                justify-content: center;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .control-button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div id="statusMessage" class="status-message"></div>
    
    <div class="container">
        <div class="header">
            <h1>英語コソ練アプリ</h1>
        </div>

        <div class="session-info">
            <div class="session-details">
                <div class="session-item">
                    <div class="label">シナリオ</div>
                    <div class="value" id="scenarioName">読み込み中...</div>
                </div>
                <div class="session-item">
                    <div class="label">難易度</div>
                    <div class="value" id="difficultyLevel">--</div>
                </div>
                <div class="session-item">
                    <div class="label">経過時間</div>
                    <div class="value" id="sessionTimer">00:00</div>
                </div>
                <div class="session-item">
                    <div class="label">メッセージ数</div>
                    <div class="value" id="messageCount">0</div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai">
                <div class="role">AI Assistant</div>
                <div class="content" id="initialMessage">会話を初期化中...</div>
                <div class="timestamp" id="initialTimestamp"></div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="role">AI Assistant</div>
                <div class="dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="userInput" 
                        class="user-input" 
                        placeholder="英語でメッセージを入力してください... (音声入力も可能)"
                        rows="3"
                    ></textarea>
                </div>
                <div class="input-buttons">
                    <button id="voiceButton" class="voice-button" title="音声入力">
                        🎤
                    </button>
                    <button id="sendButton" class="send-button">
                        送信
                    </button>
                </div>
            </div>
            
            <div class="input-guide">
                <p><strong>💡 練習のコツ:</strong></p>
                <p>• 自然な英語表現を心がけましょう</p>
                <p>• 具体的な内容で会話を深めましょう</p>
                <p>• 🎤ボタンで音声入力も活用できます</p>
            </div>
        </div>

        <div class="control-buttons">
            <button class="control-button" onclick="pauseSession()">
                一時停止
            </button>
            <button class="control-button" onclick="saveProgress()">
                進捗保存
            </button>
            <button class="control-button end-session" onclick="endSession()">
                セッション終了
            </button>
        </div>

        <div class="footer">
            <p>developed by T.H.</p>
        </div>
    </div>

    <script>
        console.log('💬 Conversation page loaded');

        // グローバル変数
        let conversationHistory = [];
        let sessionStartTime = Date.now();
        let sessionTimer = null;
        let messageCounter = 0;
        let currentScenario = 'ビジネス英会話練習';
        let currentDifficulty = 'normal';
        let recognition = null;
        let isRecording = false;

        // ページ読み込み完了時の処理
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM Content Loaded');
            
            try {
                // 認証チェック
                if (!checkAuthentication()) {
                    return;
                }
                
                // セッション情報を読み込み
                loadSessionInfo();
                
                // セッション時間を開始
                startSessionTimer();
                
                // イベントリスナーを設定
                setupEventListeners();
                
                // 初期化完了メッセージ
                showStatus('アプリが正常に初期化されました', 'success');
                
                // 音声認識を初期化（遅延実行）
                setTimeout(initializeSpeechRecognition, 1000);
                
                console.log('✅ Conversation session initialized');
                
            } catch (error) {
                console.error('❌ Initialization error:', error);
                showStatus('初期化エラー: ' + error.message, 'error');
            }
        });

        // 認証チェック
        function checkAuthentication() {
            try {
                const isAuthenticated = sessionStorage.getItem('isAuthenticated');
                const authTime = sessionStorage.getItem('authTime');
                
                if (!isAuthenticated) {
                    console.log('❌ No authentication found - redirecting to login');
                    alert('Please login first.');
                    window.location.replace('index.html');
                    return false;
                }
                
                // 認証の有効期限をチェック（24時間）
                if (authTime) {
                    const currentTime = new Date().getTime();
                    const authTimeStamp = parseInt(authTime);
                    const hoursDiff = (currentTime - authTimeStamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        console.log('⏰ Authentication expired - clearing session');
                        sessionStorage.clear();
                        alert('Session expired. Please login again.');
                        window.location.replace('index.html');
                        return false;
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Authentication check error:', error);
                alert('Authentication error. Please login again.');
                window.location.replace('index.html');
                return false;
            }
        }

        // ステータスメッセージ表示
        function showStatus(message, type = 'success') {
            const statusElement = document.getElementById('statusMessage');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status-message ${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // セッション情報読み込み
        function loadSessionInfo() {
            try {
                console.log('📋 Loading session info...');
                
                // sessionStorageからシナリオと難易度を読み込み
                const storedScenario = sessionStorage.getItem('selectedScenario');
                const storedDifficulty = sessionStorage.getItem('selectedDifficulty');
                
                console.log('📊 Stored scenario:', storedScenario);
                console.log('📊 Stored difficulty:', storedDifficulty);
                
                // シナリオが存在しない場合はシナリオ選択に戻る
                if (!storedScenario) {
                    console.log('❌ No scenario found - redirecting to scenario selection');
                    alert('シナリオが選択されていません。シナリオ選択画面に戻ります。');
                    window.location.href = 'scenario.html';
                    return;
                }
                
                // 難易度が存在しない場合は難易度選択に戻る
                if (!storedDifficulty) {
                    console.log('❌ No difficulty found - redirecting to difficulty selection');
                    alert('難易度が選択されていません。難易度選択画面に戻ります。');
                    window.location.href = 'difficulty.html';
                    return;
                }
                
                // グローバル変数に設定
                currentScenario = storedScenario;
                currentDifficulty = storedDifficulty;
                
                console.log('✅ Session info loaded:', {
                    scenario: currentScenario,
                    difficulty: currentDifficulty
                });
                
                // UIに反映
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = getDifficultyLabel(currentDifficulty);
                
                // 初期メッセージを生成
                generateInitialMessage();
                
                console.log('✅ Session info loaded successfully');
                
            } catch (error) {
                console.error('❌ Error loading session info:', error);
                showStatus('セッション情報の読み込みに失敗しました', 'error');
                
                // エラー時はシナリオ選択に戻る
                setTimeout(() => {
                    window.location.href = 'scenario.html';
                }, 3000);
            }
        }

        // 難易度ラベル取得
        function getDifficultyLabel(difficulty) {
            const labels = {
                'easy': '初級',
                'normal': '中級',
                'hard': '上級'
            };
            return labels[difficulty] || '中級';
        }

        // 初期メッセージ生成
        function generateInitialMessage() {
            const scenarioLower = currentScenario.toLowerCase();
            let initialMessage = '';
            
            // シナリオに応じた初期メッセージ
            if (scenarioLower.includes('雑談') || scenarioLower.includes('casual')) {
                initialMessage = "Hey there! Good to see you. How's your day going? I just grabbed a coffee - the weather's been pretty nice lately, hasn't it?";
            } else if (scenarioLower.includes('会食') || scenarioLower.includes('dinner')) {
                initialMessage = "Thank you for joining me for dinner today. This place has excellent reviews. How was your journey here? Have you tried this type of cuisine before?";
            } else if (scenarioLower.includes('アポ') || scenarioLower.includes('appointment') || scenarioLower.includes('電話')) {
                initialMessage = "Hello, thank you for calling. I understand you'd like to schedule a meeting with us. I'd be happy to help you find a suitable time. What works best for your schedule?";
            } else if (scenarioLower.includes('タスク') || scenarioLower.includes('task') || scenarioLower.includes('スケジュール')) {
                initialMessage = "Good morning! Let's review our project status. I've been looking at our timeline and I think we need to clarify a few things. What's the current status on your deliverables?";
            } else if (scenarioLower.includes('プレゼン') || scenarioLower.includes('presentation') || scenarioLower.includes('質疑')) {
                initialMessage = "Thank you for that comprehensive presentation. I have several questions about your proposal. First, could you clarify the expected ROI and timeline for implementation?";
            } else if (scenarioLower.includes('m&a') || scenarioLower.includes('交渉') || scenarioLower.includes('価格')) {
                initialMessage = "Good afternoon. I appreciate you taking the time to meet with us today to discuss this acquisition opportunity. We've reviewed your proposal, and I'd like to discuss our valuation concerns.";
            } else if (scenarioLower.includes('会議') || scenarioLower.includes('meeting')) {
                initialMessage = "Good morning! Thanks for joining today's meeting. I'm excited to discuss our project progress with you. How has your week been going so far?";
            } else {
                // デフォルトメッセージ（より具体的な業務シナリオに対応）
                initialMessage = "Hello! I'm ready to engage in our business scenario. Let's make this conversation productive and realistic. How would you like to begin?";
            }
            
            // 難易度に応じてメッセージを調整
            if (currentDifficulty === 'hard') {
                initialMessage += " I expect detailed responses and professional business language.";
            }
            
            // 初期メッセージを表示
            document.getElementById('initialMessage').textContent = initialMessage;
            document.getElementById('initialTimestamp').textContent = new Date().toLocaleTimeString('ja-JP');
            
            // 会話履歴に追加
            conversationHistory.push({
                role: 'ai',
                content: initialMessage,
                timestamp: new Date().toISOString()
            });
            
            console.log('💬 Initial message generated for scenario:', currentScenario);
        }

        // セッションタイマー開始
        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // イベントリスナー設定
        function setupEventListeners() {
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const voiceButton = document.getElementById('voiceButton');
            
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
            
            if (userInput) {
                userInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            if (voiceButton) {
                voiceButton.addEventListener('click', toggleVoiceInput);
            }
            
            console.log('🎧 Event listeners set up');
        }

        // メッセージ送信
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) {
                showStatus('メッセージを入力してください', 'warning');
                return;
            }
            
            console.log('📤 Sending message:', message);
            
            // ユーザーメッセージを追加
            addMessage('user', message);
            
            // 入力をクリア
            userInput.value = '';
            
            // 送信ボタンを無効化
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.disabled = true;
            }
            
            // タイピングインジケーターを表示
            showTypingIndicator();
            
            // AIの応答を生成（遅延付き）
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                hideTypingIndicator();
                addMessage('ai', aiResponse);
                
                if (sendButton) {
                    sendButton.disabled = false;
                }
                userInput.focus();
            }, 1500 + Math.random() * 1000);
        }

        // メッセージ追加
        function addMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const roleSpan = document.createElement('div');
            roleSpan.className = 'role';
            roleSpan.textContent = role === 'user' ? 'You' : 'AI Assistant';
            
            const contentSpan = document.createElement('div');
            contentSpan.className = 'content';
            contentSpan.textContent = content;
            
            const timestampSpan = document.createElement('div');
            timestampSpan.className = 'timestamp';
            timestampSpan.textContent = new Date().toLocaleTimeString('ja-JP');
            
            messageDiv.appendChild(roleSpan);
            messageDiv.appendChild(contentSpan);
            messageDiv.appendChild(timestampSpan);
            
            // 初期メッセージを削除（最初のメッセージの場合）
            if (messageCounter === 0) {
                const initialMessage = chatContainer.querySelector('.message.ai');
                if (initialMessage && initialMessage.querySelector('#initialMessage')) {
                    chatContainer.removeChild(initialMessage);
                }
            }
            
            chatContainer.appendChild(messageDiv);
            
            // スクロールを最下部に
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // メッセージカウンターを更新
            messageCounter++;
            document.getElementById('messageCount').textContent = messageCounter;
            
            // 会話履歴に追加
            conversationHistory.push({
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            });
            
            console.log(`✅ Message added: ${role} - ${content.substring(0, 50)}...`);
        }

        // タイピングインジケーター表示
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'block';
                
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // タイピングインジケーター非表示
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        }

        // AI応答生成（シナリオ対応版）
        function generateAIResponse(userMessage) {
            const scenarioLower = currentScenario.toLowerCase();
            const difficultyLevel = currentDifficulty;
            const message = userMessage.toLowerCase();
            
            console.log('🤖 Generating AI response for scenario:', currentScenario);
            console.log('🎯 Difficulty level:', difficultyLevel);
            console.log('💬 User message:', userMessage);
            
            let responses = [];
            
            // シナリオ別の応答生成
            if (scenarioLower.includes('雑談') || scenarioLower.includes('casual')) {
                responses = [
                    "That sounds really interesting! I had a pretty good weekend too. Did you catch the news about the new project announcement?",
                    "Oh, I know what you mean! Speaking of which, have you tried that new restaurant downtown?",
                    "That's great to hear! By the way, how's your family doing? You mentioned your kids were starting school.",
                    "I completely agree! You know, it reminds me of something similar that happened last month.",
                    "That's a good point! Have you been following the latest industry trends? There's been some interesting developments."
                ];
            } else if (scenarioLower.includes('会食') || scenarioLower.includes('dinner')) {
                responses = [
                    "That's fascinating! I've always been curious about that culture. How did you first get interested in it?",
                    "The food here really is exceptional. I particularly recommend their signature dish. Have you had a chance to travel much for business?",
                    "That's an interesting perspective! In my experience, building relationships over meals really does make a difference in business.",
                    "I appreciate you sharing that! Speaking of traditions, how do you usually celebrate holidays in your family?",
                    "That sounds like a great approach! Food really does bring people together, doesn't it?"
                ];
            } else if (scenarioLower.includes('アポ') || scenarioLower.includes('appointment') || scenarioLower.includes('電話')) {
                responses = [
                    "Let me check my calendar. I have some availability next week. Would Tuesday or Wednesday afternoon work for you?",
                    "That sounds good. How about we schedule it for 2 PM? That should give us enough time to cover all the topics you mentioned.",
                    "I understand you're quite busy. Would a shorter 30-minute meeting be more manageable for your schedule?",
                    "Perfect! I'll send you a calendar invitation shortly. Should I include anyone else from our team in this meeting?",
                    "That works for me. Just to confirm, we'll be discussing the quarterly review and budget planning, correct?"
                ];
            } else if (scenarioLower.includes('タスク') || scenarioLower.includes('task') || scenarioLower.includes('スケジュール')) {
                responses = [
                    "Good update! Where do we stand on the deliverables for the client presentation? Are we still on track for Friday?",
                    "I see. That's a bit concerning about the timeline. What resources do you think we need to get back on schedule?",
                    "Excellent progress! Should we schedule a checkpoint meeting with the stakeholders to update them on our status?",
                    "That makes sense. Who else needs to be looped in on this decision? I think we should involve the product team.",
                    "I agree with that approach. Can you send me the updated timeline by end of day so I can review it?"
                ];
            } else if (scenarioLower.includes('プレゼン') || scenarioLower.includes('presentation') || scenarioLower.includes('質疑')) {
                responses = [
                    "Thank you for that explanation. Could you elaborate on the risk mitigation strategies you've outlined?",
                    "That's a solid proposal. What's your contingency plan if the market conditions change during implementation?",
                    "I'm impressed with the research depth. How did you validate these assumptions with our target customers?",
                    "The numbers look promising. What would be the resource requirements from our end to support this initiative?",
                    "Interesting approach! How does this compare to what our competitors are doing in the same space?"
                ];
            } else if (scenarioLower.includes('m&a') || scenarioLower.includes('交渉') || scenarioLower.includes('価格')) {
                responses = [
                    "I understand your position, but our analysis shows a different valuation range. Can we discuss the EBITDA multiples you're using?",
                    "That's a significant gap from our initial offer. What specific assets or synergies justify this premium in your view?",
                    "We appreciate the comprehensive due diligence materials. However, we need to address the working capital adjustments.",
                    "From our perspective, the market conditions have changed since we started this process. How do you see that affecting the valuation?",
                    "We're willing to consider that proposal, but we'd need some additional warranties and indemnifications to move forward."
                ];
            } else {
                // 一般的なビジネス応答
                responses = [
                    "That's a great point! I think we should definitely consider that approach. What do you think the timeline would look like for implementation?",
                    "I appreciate you bringing that up. How do you think this aligns with our current objectives?",
                    "Excellent! That could really help us move forward. Should we assign someone to look into this further?",
                    "That's interesting. Could you elaborate on how you see this working in practice?",
                    "I agree with your assessment. What would be the next steps to make this happen?"
                ];
            }
            
            // 難易度に応じて応答を調整
            if (difficultyLevel === 'hard') {
                // ハードモードでは、より詳細で挑戦的な応答を追加
                const hardResponses = responses.map(response => {
                    return response + " I'd also like to understand the long-term implications and potential challenges we might face.";
                });
                responses = responses.concat(hardResponses);
            }
            
            const selectedResponse = responses[Math.floor(Math.random() * responses.length)];
            console.log('✅ AI response generated:', selectedResponse.substring(0, 50) + '...');
            
            return selectedResponse;
        }

        // 音声認識初期化
        function initializeSpeechRecognition() {
            console.log('🎤 Initializing speech recognition...');
            
            try {
                // ブラウザサポート確認
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    throw new Error('音声認識がサポートされていません');
                }
                
                // 音声認識オブジェクト作成
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // 設定
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                // イベントリスナー
                recognition.onstart = function() {
                    console.log('🎤 Speech recognition started');
                    isRecording = true;
                    updateVoiceButton();
                    showStatus('音声認識開始 - 話してください', 'success');
                };
                
                recognition.onresult = function(event) {
                    console.log('🎤 Speech recognition result received');
                    
                    if (event.results && event.results.length > 0) {
                        const transcript = event.results[0][0].transcript.trim();
                        console.log('🎤 Transcript:', transcript);
                        
                        if (transcript) {
                            const userInput = document.getElementById('userInput');
                            if (userInput) {
                                const currentText = userInput.value.trim();
                                userInput.value = currentText ? currentText + ' ' + transcript : transcript;
                                userInput.focus();
                                showStatus('音声認識成功: ' + transcript, 'success');
                            }
                        }
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('🎤 Speech recognition error:', event.error);
                    isRecording = false;
                    updateVoiceButton();
                    
                    let errorMessage = '音声認識エラー';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = '音声が検出されませんでした';
                            break;
                        case 'audio-capture':
                            errorMessage = 'マイクにアクセスできません';
                            break;
                        case 'not-allowed':
                            errorMessage = 'マイクの使用が許可されていません';
                            break;
                        case 'network':
                            errorMessage = 'ネットワークエラーが発生しました';
                            break;
                        default:
                            errorMessage = `音声認識エラー: ${event.error}`;
                    }
                    
                    showStatus(errorMessage, 'error');
                };
                
                recognition.onend = function() {
                    console.log('🎤 Speech recognition ended');
                    isRecording = false;
                    updateVoiceButton();
                };
                
                console.log('✅ Speech recognition initialized successfully');
                showStatus('音声認識が利用可能です', 'success');
                
            } catch (error) {
                console.error('❌ Failed to initialize speech recognition:', error);
                
                const voiceButton = document.getElementById('voiceButton');
                if (voiceButton) {
                    voiceButton.disabled = true;
                    voiceButton.textContent = '🚫';
                    voiceButton.title = '音声認識利用不可';
                }
                
                showStatus('音声認識を初期化できませんでした', 'error');
            }
        }

        // 音声入力トグル
        function toggleVoiceInput() {
            console.log('🎤 Toggle voice input, isRecording:', isRecording);
            
            if (!recognition) {
                showStatus('音声認識が初期化されていません', 'error');
                return;
            }
            
            if (isRecording) {
                try {
                    recognition.stop();
                    isRecording = false;
                    updateVoiceButton();
                    showStatus('音声認識を停止しました', 'success');
                } catch (error) {
                    console.error('🎤 Error stopping recognition:', error);
                    isRecording = false;
                    updateVoiceButton();
                }
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('🎤 Error starting recognition:', error);
                    showStatus('音声認識の開始に失敗しました', 'error');
                }
            }
        }

        // 音声ボタン更新
        function updateVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            if (!voiceButton) return;
            
            if (isRecording) {
                voiceButton.classList.add('recording');
                voiceButton.textContent = '🔴';
                voiceButton.title = '録音中 - クリックで停止';
            } else {
                voiceButton.classList.remove('recording');
                voiceButton.textContent = '🎤';
                voiceButton.title = 'クリックで音声入力開始';
            }
        }

        // セッション一時停止
        function pauseSession() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
                showStatus('セッションを一時停止しました', 'success');
                
                // 再開ボタンに変更
                const pauseButton = event.target;
                pauseButton.textContent = '再開';
                pauseButton.onclick = resumeSession;
            }
        }

        // セッション再開
        function resumeSession() {
            startSessionTimer();
            showStatus('セッションを再開しました', 'success');
            
            // 一時停止ボタンに戻す
            const resumeButton = event.target;
            resumeButton.textContent = '一時停止';
            resumeButton.onclick = pauseSession;
        }

        // 進捗保存
        function saveProgress() {
            try {
                const progressData = {
                    conversationHistory: conversationHistory,
                    messageCount: messageCounter,
                    sessionTime: Date.now() - sessionStartTime,
                    scenario: currentScenario,
                    difficulty: currentDifficulty,
                    timestamp: new Date().toISOString()
                };
                
                // メモリ内保存（実際のアプリでは localStorage や サーバーに保存）
                console.log('💾 Progress saved:', progressData);
                showStatus('進捗を保存しました', 'success');
                
            } catch (error) {
                console.error('❌ Error saving progress:', error);
                showStatus('進捗の保存に失敗しました', 'error');
            }
        }

        // セッション終了
        function endSession() {
            if (confirm('セッションを終了しますか？\n終了後にFinal Reportが生成されます。')) {
                // タイマー停止
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                    sessionTimer = null;
                }
                
                // 音声認識停止
                if (recognition && isRecording) {
                    try {
                        recognition.stop();
                        isRecording = false;
                        updateVoiceButton();
                    } catch (error) {
                        console.error('Error stopping recognition:', error);
                    }
                }
                
                // セッションデータを保存
                const sessionEndTime = Date.now();
                const totalSessionTime = sessionEndTime - sessionStartTime;
                const sessionMinutes = Math.floor(totalSessionTime / 60000);
                const sessionSeconds = Math.floor((totalSessionTime % 60000) / 1000);
                
                // final-report.html用のデータを準備
                sessionStorage.setItem('messageCount', messageCounter.toString());
                sessionStorage.setItem('sessionDuration', `${sessionMinutes}分${sessionSeconds}秒`);
                sessionStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
                sessionStorage.setItem('sessionStartTime', sessionStartTime.toString());
                sessionStorage.setItem('sessionEndTime', sessionEndTime.toString());
                
                // スコア計算（簡易版）
                const userMessages = conversationHistory.filter(msg => msg.role === 'user');
                const totalWords = userMessages.reduce((total, msg) => {
                    return total + msg.content.split(' ').filter(word => word.length > 0).length;
                }, 0);
                const avgWordsPerMessage = userMessages.length > 0 ? Math.round(totalWords / userMessages.length) : 0;
                
                const overallScore = Math.min(100, Math.max(60, 
                    (messageCounter * 5) + (avgWordsPerMessage * 2) + 40));
                const fluencyScore = Math.min(100, Math.max(50, overallScore + Math.random() * 20 - 10));
                const accuracyScore = Math.min(100, Math.max(50, overallScore + Math.random() * 20 - 10));
                
                sessionStorage.setItem('overallScore', overallScore.toString());
                sessionStorage.setItem('fluencyScore', fluencyScore.toString());
                sessionStorage.setItem('accuracyScore', accuracyScore.toString());
                sessionStorage.setItem('averageMessageLength', avgWordsPerMessage.toString());
                sessionStorage.setItem('voiceUsageCount', '0'); // 音声使用回数（実装必要）
                
                showStatus('セッションを終了しました。Final Reportページに移動中...', 'success');
                
                // Final Reportページに遷移
                setTimeout(() => {
                    window.location.href = 'final-report.html';
                }, 2000);
            }
        }

        // Final Report生成
        function generateFinalReport() {
            const sessionEndTime = Date.now();
            const totalSessionTime = sessionEndTime - sessionStartTime;
            const sessionMinutes = Math.floor(totalSessionTime / 60000);
            const sessionSeconds = Math.floor((totalSessionTime % 60000) / 1000);
            
            // 会話分析
            const userMessages = conversationHistory.filter(msg => msg.role === 'user');
            const aiMessages = conversationHistory.filter(msg => msg.role === 'ai');
            
            // 単語数計算
            const totalUserWords = userMessages.reduce((total, msg) => {
                return total + msg.content.split(' ').filter(word => word.length > 0).length;
            }, 0);
            
            // 平均応答時間（推定）
            const avgResponseTime = userMessages.length > 0 ? Math.round(totalSessionTime / userMessages.length / 1000) : 0;
            
            // 学習レベル評価
            const vocabularyLevel = evaluateVocabularyLevel(userMessages);
            const fluencyScore = evaluateFluency(userMessages, totalSessionTime);
            const engagementScore = evaluateEngagement(userMessages, aiMessages);
            
            // Final Reportデータ
            const finalReport = {
                sessionInfo: {
                    scenario: currentScenario,
                    difficulty: currentDifficulty,
                    startTime: new Date(sessionStartTime).toLocaleString('ja-JP'),
                    endTime: new Date(sessionEndTime).toLocaleString('ja-JP'),
                    duration: `${sessionMinutes}分${sessionSeconds}秒`
                },
                statistics: {
                    totalMessages: messageCounter,
                    userMessages: userMessages.length,
                    aiMessages: aiMessages.length,
                    totalWords: totalUserWords,
                    averageWordsPerMessage: userMessages.length > 0 ? Math.round(totalUserWords / userMessages.length) : 0,
                    averageResponseTime: `${avgResponseTime}秒`
                },
                performance: {
                    vocabularyLevel: vocabularyLevel,
                    fluencyScore: fluencyScore,
                    engagementScore: engagementScore,
                    overallScore: Math.round((vocabularyLevel + fluencyScore + engagementScore) / 3)
                },
                recommendations: generateRecommendations(vocabularyLevel, fluencyScore, engagementScore),
                conversationSample: getConversationSample(userMessages)
            };
            
            // レポートを表示
            displayFinalReport(finalReport);
            
            // ダウンロード可能な形式で保存
            saveFinalReportAsFile(finalReport);
            
            console.log('📊 Final Report generated:', finalReport);
            return finalReport;
        }
        
        // 語彙レベル評価
        function evaluateVocabularyLevel(userMessages) {
            if (userMessages.length === 0) return 0;
            
            const allWords = userMessages.join(' ').toLowerCase().split(/\s+/);
            const uniqueWords = new Set(allWords.filter(word => word.length > 3));
            const vocabularyDiversity = uniqueWords.size / allWords.length;
            
            // 複雑な単語の使用頻度をチェック
            const complexWords = allWords.filter(word => word.length > 6).length;
            const complexityRatio = complexWords / allWords.length;
            
            const score = Math.min(100, Math.round((vocabularyDiversity * 50) + (complexityRatio * 50)));
            return Math.max(10, score); // 最低10点
        }
        
        // 流暢性評価
        function evaluateFluency(userMessages, totalTime) {
            if (userMessages.length === 0) return 0;
            
            const totalWords = userMessages.reduce((total, msg) => {
                return total + msg.content.split(' ').length;
            }, 0);
            
            const wordsPerMinute = (totalWords / (totalTime / 60000));
            const messageFrequency = userMessages.length / (totalTime / 60000);
            
            // 適度なペースを評価（早すぎず遅すぎず）
            const paceScore = Math.min(100, Math.max(0, (wordsPerMinute / 50) * 100));
            const frequencyScore = Math.min(100, messageFrequency * 20);
            
            return Math.round((paceScore + frequencyScore) / 2);
        }
        
        // エンゲージメント評価
        function evaluateEngagement(userMessages, aiMessages) {
            if (userMessages.length === 0) return 0;
            
            // 質問の使用頻度
            const questionsCount = userMessages.filter(msg => msg.content.includes('?')).length;
            const questionRatio = questionsCount / userMessages.length;
            
            // メッセージの長さの多様性
            const messageLengths = userMessages.map(msg => msg.content.length);
            const avgLength = messageLengths.reduce((a, b) => a + b, 0) / messageLengths.length;
            const lengthVariance = messageLengths.reduce((acc, len) => acc + Math.pow(len - avgLength, 2), 0) / messageLengths.length;
            
            const engagementScore = Math.min(100, (questionRatio * 40) + (Math.sqrt(lengthVariance) / 10) + 20);
            return Math.round(engagementScore);
        }
        
        // 推奨事項生成
        function generateRecommendations(vocab, fluency, engagement) {
            const recommendations = [];
            
            if (vocab < 50) {
                recommendations.push("📚 語彙力向上: より多様な単語を使って表現してみましょう");
            }
            if (fluency < 50) {
                recommendations.push("⚡ 流暢性向上: もう少し早いペースで会話してみましょう");
            }
            if (engagement < 50) {
                recommendations.push("🤝 積極性向上: より多くの質問をして会話を深めましょう");
            }
            
            // ポジティブなフィードバックも追加
            if (vocab >= 70) {
                recommendations.push("✨ 素晴らしい語彙力です！この調子で続けましょう");
            }
            if (fluency >= 70) {
                recommendations.push("🎯 流暢な会話ができています！");
            }
            if (engagement >= 70) {
                recommendations.push("🌟 積極的な参加、素晴らしいです！");
            }
            
            return recommendations;
        }
        
        // 会話サンプル取得
        function getConversationSample(userMessages) {
            if (userMessages.length === 0) return "No conversation recorded.";
            
            // 最も長いメッセージを取得
            const longestMessage = userMessages.reduce((longest, current) => {
                return current.content.length > longest.content.length ? current : longest;
            });
            
            return longestMessage.content;
        }
        
        // Final Report表示
        function displayFinalReport(report) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const reportDiv = document.createElement('div');
            reportDiv.className = 'message ai final-report';
            reportDiv.style.maxWidth = '95%';
            reportDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            
            reportDiv.innerHTML = `
                <div class="role">📊 FINAL REPORT</div>
                <div class="content">
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">🎯 セッション概要</h3>
                        <p><strong>シナリオ:</strong> ${report.sessionInfo.scenario}</p>
                        <p><strong>難易度:</strong> ${getDifficultyLabel(report.sessionInfo.difficulty)}</p>
                        <p><strong>実施時間:</strong> ${report.sessionInfo.duration}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">📈 統計データ</h3>
                        <p><strong>総メッセージ数:</strong> ${report.statistics.totalMessages}</p>
                        <p><strong>あなたのメッセージ:</strong> ${report.statistics.userMessages}</p>
                        <p><strong>総単語数:</strong> ${report.statistics.totalWords}</p>
                        <p><strong>1メッセージ平均単語数:</strong> ${report.statistics.averageWordsPerMessage}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">⭐ パフォーマンス評価</h3>
                        <p><strong>語彙力スコア:</strong> ${report.performance.vocabularyLevel}/100</p>
                        <p><strong>流暢性スコア:</strong> ${report.performance.fluencyScore}/100</p>
                        <p><strong>積極性スコア:</strong> ${report.performance.engagementScore}/100</p>
                        <p style="font-size: 18px; color: #ffeb3b;"><strong>総合スコア: ${report.performance.overallScore}/100</strong></p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">💡 改善提案</h3>
                        ${report.recommendations.map(rec => `<p>• ${rec}</p>`).join('')}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">📝 ベストメッセージ</h3>
                        <p style="font-style: italic; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
                            "${report.conversationSample}"
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="downloadReport()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            📄 レポートをダウンロード
                        </button>
                    </div>
                </div>
                <div class="timestamp">${new Date().toLocaleTimeString('ja-JP')}</div>
            `;
            
            chatContainer.appendChild(reportDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // レポートファイル保存
        function saveFinalReportAsFile(report) {
            window.finalReportData = report; // グローバルに保存してダウンロード用に
            
            const reportText = `
ENGLISH CONVERSATION PRACTICE - FINAL REPORT
=============================================

Session Information:
- Scenario: ${report.sessionInfo.scenario}
- Difficulty: ${getDifficultyLabel(report.sessionInfo.difficulty)}
- Start Time: ${report.sessionInfo.startTime}
- End Time: ${report.sessionInfo.endTime}
- Duration: ${report.sessionInfo.duration}

Statistics:
- Total Messages: ${report.statistics.totalMessages}
- Your Messages: ${report.statistics.userMessages}
- Total Words: ${report.statistics.totalWords}
- Average Words per Message: ${report.statistics.averageWordsPerMessage}
- Average Response Time: ${report.statistics.averageResponseTime}

Performance Evaluation:
- Vocabulary Level: ${report.performance.vocabularyLevel}/100
- Fluency Score: ${report.performance.fluencyScore}/100
- Engagement Score: ${report.performance.engagementScore}/100
- Overall Score: ${report.performance.overallScore}/100

Recommendations:
${report.recommendations.map(rec => `- ${rec}`).join('\n')}

Best Message Sample:
"${report.conversationSample}"

Generated on: ${new Date().toLocaleString('ja-JP')}
            `;
            
            console.log('📄 Final report prepared for download');
            window.finalReportText = reportText;
        }
        
        // レポートダウンロード機能
        function downloadReport() {
            if (!window.finalReportText) {
                showStatus('レポートデータが見つかりません', 'error');
                return;
            }
            
            const blob = new Blob([window.finalReportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `English_Practice_Report_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('レポートをダウンロードしました', 'success');
        }
        
        // グローバル関数として登録
        window.downloadReport = downloadReport;

        // エラーハンドリング
        window.addEventListener('error', function(event) {
            console.error('❌ Global error:', event.error);
            showStatus('エラーが発生しました: ' + event.error.message, 'error');
        });

        // 未処理の Promise エラー
        window.addEventListener('unhandledrejection', function(event) {
            console.error('❌ Unhandled promise rejection:', event.reason);
            showStatus('システムエラーが発生しました', 'error');
        });

        // ページが閉じられる前の確認
        window.addEventListener('beforeunload', function(event) {
            if (messageCounter > 0) {
                event.preventDefault();
                event.returnValue = '会話データが失われます。本当に終了しますか？';
                return event.returnValue;
            }
        });

        // デバッグ情報表示（開発時のみ）
        function showDebugInfo() {
            console.log('🔍 Debug Info:', {
                messageCounter,
                conversationHistory: conversationHistory.length,
                isRecording,
                currentScenario,
                currentDifficulty,
                speechRecognitionAvailable: !!recognition,
                userAgent: navigator.userAgent
            });
        }

        // コンソールでデバッグ情報を確認できるように
        window.showDebugInfo = showDebugInfo;
        
        console.log('✅ Application fully loaded and ready');
        console.log('💡 Type showDebugInfo() in console for debug information');
    </script>
</body>
</html>