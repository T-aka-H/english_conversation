<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëã±Ë™û„Ç≥„ÇΩÁ∑¥„Ç¢„Éó„É™ - Ëã±‰ºöË©±Á∑¥Áøí</title>
    <link rel="icon" href="data:,">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #4A90E2;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .session-details {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .session-item {
            text-align: center;
        }

        .session-item .label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .session-item .value {
            font-size: 16px;
            font-weight: 600;
            color: #4A90E2;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-right: auto;
        }

        .message .role {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message .content {
            font-size: 15px;
            line-height: 1.5;
        }

        .message .timestamp {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 8px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .user-input {
            width: 100%;
            min-height: 60px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .user-input:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.3);
        }

        .user-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .voice-button {
            padding: 15px;
            background: linear-gradient(135deg, #28a745, #20a042);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            width: 60px;
            height: 60px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        .voice-button.recording {
            background: linear-gradient(135deg, #dc3545, #c82333);
            animation: pulse 1.5s infinite;
        }

        .voice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .send-button:hover {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 144, 226, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .control-button {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .control-button.end-session {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
        }

        .control-button.end-session:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 20px;
            max-width: 80%;
        }

        .typing-indicator .dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: #4A90E2;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .input-guide {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .input-guide strong {
            color: #4A90E2;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }

        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 167, 69, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            display: none;
        }

        .status-message.error {
            background: rgba(220, 53, 69, 0.95);
        }

        .status-message.warning {
            background: rgba(255, 193, 7, 0.95);
            color: black;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; transform: scale(1); }
            30% { opacity: 1; transform: scale(1.2); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .session-details {
                flex-direction: column;
                gap: 15px;
            }
            
            .input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-buttons {
                flex-direction: row;
                justify-content: center;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .control-button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div id="statusMessage" class="status-message"></div>
    
    <div class="container">
        <div class="header">
            <h1>Ëã±Ë™û„Ç≥„ÇΩÁ∑¥„Ç¢„Éó„É™</h1>
        </div>

        <div class="session-info">
            <div class="session-details">
                <div class="session-item">
                    <div class="label">„Ç∑„Éä„É™„Ç™</div>
                    <div class="value" id="scenarioName">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
                <div class="session-item">
                    <div class="label">Èõ£ÊòìÂ∫¶</div>
                    <div class="value" id="difficultyLevel">--</div>
                </div>
                <div class="session-item">
                    <div class="label">ÁµåÈÅéÊôÇÈñì</div>
                    <div class="value" id="sessionTimer">00:00</div>
                </div>
                <div class="session-item">
                    <div class="label">„É°„ÉÉ„Çª„Éº„Ç∏Êï∞</div>
                    <div class="value" id="messageCount">0</div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai">
                <div class="role">AI Assistant</div>
                <div class="content" id="initialMessage">‰ºöË©±„ÇíÂàùÊúüÂåñ‰∏≠...</div>
                <div class="timestamp" id="initialTimestamp"></div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="role">AI Assistant</div>
                <div class="dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="userInput" 
                        class="user-input" 
                        placeholder="Ëã±Ë™û„Åß„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ... (Èü≥Â£∞ÂÖ•Âäõ„ÇÇÂèØËÉΩ)"
                        rows="3"
                    ></textarea>
                </div>
                <div class="input-buttons">
                    <button id="voiceButton" class="voice-button" title="Èü≥Â£∞ÂÖ•Âäõ">
                        üé§
                    </button>
                    <button id="sendButton" class="send-button">
                        ÈÄÅ‰ø°
                    </button>
                </div>
            </div>
            
            <div class="input-guide">
                <p><strong>üí° Á∑¥Áøí„ÅÆ„Ç≥„ÉÑ:</strong></p>
                <p>‚Ä¢ Ëá™ÁÑ∂„Å™Ëã±Ë™ûË°®Áèæ„ÇíÂøÉ„Åå„Åë„Åæ„Åó„Çá„ÅÜ</p>
                <p>‚Ä¢ ÂÖ∑‰ΩìÁöÑ„Å™ÂÜÖÂÆπ„Åß‰ºöË©±„ÇíÊ∑±„ÇÅ„Åæ„Åó„Çá„ÅÜ</p>
                <p>‚Ä¢ üé§„Éú„Çø„É≥„ÅßÈü≥Â£∞ÂÖ•Âäõ„ÇÇÊ¥ªÁî®„Åß„Åç„Åæ„Åô</p>
            </div>
        </div>

        <div class="control-buttons">
            <button class="control-button" onclick="pauseSession()">
                ‰∏ÄÊôÇÂÅúÊ≠¢
            </button>
            <button class="control-button" onclick="saveProgress()">
                ÈÄ≤Êçó‰øùÂ≠ò
            </button>
            <button class="control-button end-session" onclick="endSession()">
                „Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü
            </button>
        </div>

        <div class="footer">
            <p>developed by T.H.</p>
        </div>
    </div>

    <script>
        console.log('üí¨ Conversation page loaded');

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let conversationHistory = [];
        let sessionStartTime = Date.now();
        let sessionTimer = null;
        let messageCounter = 0;
        let currentScenario = '„Éì„Ç∏„Éç„ÇπËã±‰ºöË©±Á∑¥Áøí';
        let currentDifficulty = 'normal';
        let recognition = null;
        let isRecording = false;

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ„ÅÆÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM Content Loaded');
            
            try {
                // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
                if (!checkAuthentication()) {
                    return;
                }
                
                // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
                loadSessionInfo();
                
                // „Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñì„ÇíÈñãÂßã
                startSessionTimer();
                
                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
                setupEventListeners();
                
                // ÂàùÊúüÂåñÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏
                showStatus('„Ç¢„Éó„É™„ÅåÊ≠£Â∏∏„Å´ÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü', 'success');
                
                // Èü≥Â£∞Ë™çË≠ò„ÇíÂàùÊúüÂåñÔºàÈÅÖÂª∂ÂÆüË°åÔºâ
                setTimeout(initializeSpeechRecognition, 1000);
                
                console.log('‚úÖ Conversation session initialized');
                
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                showStatus('ÂàùÊúüÂåñ„Ç®„É©„Éº: ' + error.message, 'error');
            }
        });

        // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
        function checkAuthentication() {
            try {
                const isAuthenticated = sessionStorage.getItem('isAuthenticated');
                const authTime = sessionStorage.getItem('authTime');
                
                if (!isAuthenticated) {
                    console.log('‚ùå No authentication found - redirecting to login');
                    alert('Please login first.');
                    window.location.replace('index.html');
                    return false;
                }
                
                // Ë™çË®º„ÅÆÊúâÂäπÊúüÈôê„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà24ÊôÇÈñìÔºâ
                if (authTime) {
                    const currentTime = new Date().getTime();
                    const authTimeStamp = parseInt(authTime);
                    const hoursDiff = (currentTime - authTimeStamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        console.log('‚è∞ Authentication expired - clearing session');
                        sessionStorage.clear();
                        alert('Session expired. Please login again.');
                        window.location.replace('index.html');
                        return false;
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Authentication check error:', error);
                alert('Authentication error. Please login again.');
                window.location.replace('index.html');
                return false;
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showStatus(message, type = 'success') {
            const statusElement = document.getElementById('statusMessage');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status-message ${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±Ë™≠„ÅøËæº„Åø
        function loadSessionInfo() {
            try {
                console.log('üìã Loading session info...');
                
                // sessionStorage„Åã„Çâ„Ç∑„Éä„É™„Ç™„Å®Èõ£ÊòìÂ∫¶„ÇíË™≠„ÅøËæº„Åø
                const storedScenario = sessionStorage.getItem('selectedScenario');
                const storedDifficulty = sessionStorage.getItem('selectedDifficulty');
                
                console.log('üìä Stored scenario:', storedScenario);
                console.log('üìä Stored difficulty:', storedDifficulty);
                
                // „Ç∑„Éä„É™„Ç™„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç∑„Éä„É™„Ç™ÈÅ∏Êäû„Å´Êàª„Çã
                if (!storedScenario) {
                    console.log('‚ùå No scenario found - redirecting to scenario selection');
                    alert('„Ç∑„Éä„É™„Ç™„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Ç∑„Éä„É™„Ç™ÈÅ∏ÊäûÁîªÈù¢„Å´Êàª„Çä„Åæ„Åô„ÄÇ');
                    window.location.href = 'scenario.html';
                    return;
                }
                
                // Èõ£ÊòìÂ∫¶„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÈõ£ÊòìÂ∫¶ÈÅ∏Êäû„Å´Êàª„Çã
                if (!storedDifficulty) {
                    console.log('‚ùå No difficulty found - redirecting to difficulty selection');
                    alert('Èõ£ÊòìÂ∫¶„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÈõ£ÊòìÂ∫¶ÈÅ∏ÊäûÁîªÈù¢„Å´Êàª„Çä„Åæ„Åô„ÄÇ');
                    window.location.href = 'difficulty.html';
                    return;
                }
                
                // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´Ë®≠ÂÆö
                currentScenario = storedScenario;
                currentDifficulty = storedDifficulty;
                
                console.log('‚úÖ Session info loaded:', {
                    scenario: currentScenario,
                    difficulty: currentDifficulty
                });
                
                // UI„Å´ÂèçÊò†
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = getDifficultyLabel(currentDifficulty);
                
                // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîüÊàê
                generateInitialMessage();
                
                console.log('‚úÖ Session info loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading session info:', error);
                showStatus('„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                
                // „Ç®„É©„ÉºÊôÇ„ÅØ„Ç∑„Éä„É™„Ç™ÈÅ∏Êäû„Å´Êàª„Çã
                setTimeout(() => {
                    window.location.href = 'scenario.html';
                }, 3000);
            }
        }

        // Èõ£ÊòìÂ∫¶„É©„Éô„É´ÂèñÂæó
        function getDifficultyLabel(difficulty) {
            const labels = {
                'easy': 'ÂàùÁ¥ö',
                'normal': '‰∏≠Á¥ö',
                'hard': '‰∏äÁ¥ö'
            };
            return labels[difficulty] || '‰∏≠Á¥ö';
        }

        // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàê
        function generateInitialMessage() {
            const scenarioLower = currentScenario.toLowerCase();
            let initialMessage = '';
            
            // „Ç∑„Éä„É™„Ç™„Å´Âøú„Åò„ÅüÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏
            if (scenarioLower.includes('ÈõëË´á') || scenarioLower.includes('casual')) {
                initialMessage = "Hey there! Good to see you. How's your day going? I just grabbed a coffee - the weather's been pretty nice lately, hasn't it?";
            } else if (scenarioLower.includes('‰ºöÈ£ü') || scenarioLower.includes('dinner')) {
                initialMessage = "Thank you for joining me for dinner today. This place has excellent reviews. How was your journey here? Have you tried this type of cuisine before?";
            } else if (scenarioLower.includes('„Ç¢„Éù') || scenarioLower.includes('appointment') || scenarioLower.includes('ÈõªË©±')) {
                initialMessage = "Hello, thank you for calling. I understand you'd like to schedule a meeting with us. I'd be happy to help you find a suitable time. What works best for your schedule?";
            } else if (scenarioLower.includes('„Çø„Çπ„ÇØ') || scenarioLower.includes('task') || scenarioLower.includes('„Çπ„Ç±„Ç∏„É•„Éº„É´')) {
                initialMessage = "Good morning! Let's review our project status. I've been looking at our timeline and I think we need to clarify a few things. What's the current status on your deliverables?";
            } else if (scenarioLower.includes('„Éó„É¨„Çº„É≥') || scenarioLower.includes('presentation') || scenarioLower.includes('Ë≥™Áñë')) {
                initialMessage = "Thank you for that comprehensive presentation. I have several questions about your proposal. First, could you clarify the expected ROI and timeline for implementation?";
            } else if (scenarioLower.includes('m&a') || scenarioLower.includes('‰∫§Ê∏â') || scenarioLower.includes('‰æ°Ê†º')) {
                initialMessage = "Good afternoon. I appreciate you taking the time to meet with us today to discuss this acquisition opportunity. We've reviewed your proposal, and I'd like to discuss our valuation concerns.";
            } else if (scenarioLower.includes('‰ºöË≠∞') || scenarioLower.includes('meeting')) {
                initialMessage = "Good morning! Thanks for joining today's meeting. I'm excited to discuss our project progress with you. How has your week been going so far?";
            } else {
                // „Éá„Éï„Ç©„É´„Éà„É°„ÉÉ„Çª„Éº„Ç∏Ôºà„Çà„ÇäÂÖ∑‰ΩìÁöÑ„Å™Ê•≠Âãô„Ç∑„Éä„É™„Ç™„Å´ÂØæÂøúÔºâ
                initialMessage = "Hello! I'm ready to engage in our business scenario. Let's make this conversation productive and realistic. How would you like to begin?";
            }
            
            // Èõ£ÊòìÂ∫¶„Å´Âøú„Åò„Å¶„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË™øÊï¥
            if (currentDifficulty === 'hard') {
                initialMessage += " I expect detailed responses and professional business language.";
            }
            
            // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            document.getElementById('initialMessage').textContent = initialMessage;
            document.getElementById('initialTimestamp').textContent = new Date().toLocaleTimeString('ja-JP');
            
            // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
            conversationHistory.push({
                role: 'ai',
                content: initialMessage,
                timestamp: new Date().toISOString()
            });
            
            console.log('üí¨ Initial message generated for scenario:', currentScenario);
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥„Çø„Ç§„Éû„ÉºÈñãÂßã
        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupEventListeners() {
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const voiceButton = document.getElementById('voiceButton');
            
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
            
            if (userInput) {
                userInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            if (voiceButton) {
                voiceButton.addEventListener('click', toggleVoiceInput);
            }
            
            console.log('üéß Event listeners set up');
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) {
                showStatus('„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
                return;
            }
            
            console.log('üì§ Sending message:', message);
            
            // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
            addMessage('user', message);
            
            // ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
            userInput.value = '';
            
            // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.disabled = true;
            }
            
            // „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíË°®Á§∫
            showTypingIndicator();
            
            // AI„ÅÆÂøúÁ≠î„ÇíÁîüÊàêÔºàÈÅÖÂª∂‰ªò„ÅçÔºâ
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                hideTypingIndicator();
                addMessage('ai', aiResponse);
                
                if (sendButton) {
                    sendButton.disabled = false;
                }
                userInput.focus();
            }, 1500 + Math.random() * 1000);
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
        function addMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const roleSpan = document.createElement('div');
            roleSpan.className = 'role';
            roleSpan.textContent = role === 'user' ? 'You' : 'AI Assistant';
            
            const contentSpan = document.createElement('div');
            contentSpan.className = 'content';
            contentSpan.textContent = content;
            
            const timestampSpan = document.createElement('div');
            timestampSpan.className = 'timestamp';
            timestampSpan.textContent = new Date().toLocaleTimeString('ja-JP');
            
            messageDiv.appendChild(roleSpan);
            messageDiv.appendChild(contentSpan);
            messageDiv.appendChild(timestampSpan);
            
            // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§ÔºàÊúÄÂàù„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥ÂêàÔºâ
            if (messageCounter === 0) {
                const initialMessage = chatContainer.querySelector('.message.ai');
                if (initialMessage && initialMessage.querySelector('#initialMessage')) {
                    chatContainer.removeChild(initialMessage);
                }
            }
            
            chatContainer.appendChild(messageDiv);
            
            // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏ãÈÉ®„Å´
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // „É°„ÉÉ„Çª„Éº„Ç∏„Ç´„Ç¶„É≥„Çø„Éº„ÇíÊõ¥Êñ∞
            messageCounter++;
            document.getElementById('messageCount').textContent = messageCounter;
            
            // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
            conversationHistory.push({
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            });
            
            console.log(`‚úÖ Message added: ${role} - ${content.substring(0, 50)}...`);
        }

        // „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'block';
                
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÈùûË°®Á§∫
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        }

        // AIÂøúÁ≠îÁîüÊàêÔºà„Ç∑„Éä„É™„Ç™ÂØæÂøúÁâàÔºâ
        function generateAIResponse(userMessage) {
            const scenarioLower = currentScenario.toLowerCase();
            const difficultyLevel = currentDifficulty;
            const message = userMessage.toLowerCase();
            
            console.log('ü§ñ Generating AI response for scenario:', currentScenario);
            console.log('üéØ Difficulty level:', difficultyLevel);
            console.log('üí¨ User message:', userMessage);
            
            let responses = [];
            
            // „Ç∑„Éä„É™„Ç™Âà•„ÅÆÂøúÁ≠îÁîüÊàê
            if (scenarioLower.includes('ÈõëË´á') || scenarioLower.includes('casual')) {
                responses = [
                    "That sounds really interesting! I had a pretty good weekend too. Did you catch the news about the new project announcement?",
                    "Oh, I know what you mean! Speaking of which, have you tried that new restaurant downtown?",
                    "That's great to hear! By the way, how's your family doing? You mentioned your kids were starting school.",
                    "I completely agree! You know, it reminds me of something similar that happened last month.",
                    "That's a good point! Have you been following the latest industry trends? There's been some interesting developments."
                ];
            } else if (scenarioLower.includes('‰ºöÈ£ü') || scenarioLower.includes('dinner')) {
                responses = [
                    "That's fascinating! I've always been curious about that culture. How did you first get interested in it?",
                    "The food here really is exceptional. I particularly recommend their signature dish. Have you had a chance to travel much for business?",
                    "That's an interesting perspective! In my experience, building relationships over meals really does make a difference in business.",
                    "I appreciate you sharing that! Speaking of traditions, how do you usually celebrate holidays in your family?",
                    "That sounds like a great approach! Food really does bring people together, doesn't it?"
                ];
            } else if (scenarioLower.includes('„Ç¢„Éù') || scenarioLower.includes('appointment') || scenarioLower.includes('ÈõªË©±')) {
                responses = [
                    "Let me check my calendar. I have some availability next week. Would Tuesday or Wednesday afternoon work for you?",
                    "That sounds good. How about we schedule it for 2 PM? That should give us enough time to cover all the topics you mentioned.",
                    "I understand you're quite busy. Would a shorter 30-minute meeting be more manageable for your schedule?",
                    "Perfect! I'll send you a calendar invitation shortly. Should I include anyone else from our team in this meeting?",
                    "That works for me. Just to confirm, we'll be discussing the quarterly review and budget planning, correct?"
                ];
            } else if (scenarioLower.includes('„Çø„Çπ„ÇØ') || scenarioLower.includes('task') || scenarioLower.includes('„Çπ„Ç±„Ç∏„É•„Éº„É´')) {
                responses = [
                    "Good update! Where do we stand on the deliverables for the client presentation? Are we still on track for Friday?",
                    "I see. That's a bit concerning about the timeline. What resources do you think we need to get back on schedule?",
                    "Excellent progress! Should we schedule a checkpoint meeting with the stakeholders to update them on our status?",
                    "That makes sense. Who else needs to be looped in on this decision? I think we should involve the product team.",
                    "I agree with that approach. Can you send me the updated timeline by end of day so I can review it?"
                ];
            } else if (scenarioLower.includes('„Éó„É¨„Çº„É≥') || scenarioLower.includes('presentation') || scenarioLower.includes('Ë≥™Áñë')) {
                responses = [
                    "Thank you for that explanation. Could you elaborate on the risk mitigation strategies you've outlined?",
                    "That's a solid proposal. What's your contingency plan if the market conditions change during implementation?",
                    "I'm impressed with the research depth. How did you validate these assumptions with our target customers?",
                    "The numbers look promising. What would be the resource requirements from our end to support this initiative?",
                    "Interesting approach! How does this compare to what our competitors are doing in the same space?"
                ];
            } else if (scenarioLower.includes('m&a') || scenarioLower.includes('‰∫§Ê∏â') || scenarioLower.includes('‰æ°Ê†º')) {
                responses = [
                    "I understand your position, but our analysis shows a different valuation range. Can we discuss the EBITDA multiples you're using?",
                    "That's a significant gap from our initial offer. What specific assets or synergies justify this premium in your view?",
                    "We appreciate the comprehensive due diligence materials. However, we need to address the working capital adjustments.",
                    "From our perspective, the market conditions have changed since we started this process. How do you see that affecting the valuation?",
                    "We're willing to consider that proposal, but we'd need some additional warranties and indemnifications to move forward."
                ];
            } else {
                // ‰∏ÄËà¨ÁöÑ„Å™„Éì„Ç∏„Éç„ÇπÂøúÁ≠î
                responses = [
                    "That's a great point! I think we should definitely consider that approach. What do you think the timeline would look like for implementation?",
                    "I appreciate you bringing that up. How do you think this aligns with our current objectives?",
                    "Excellent! That could really help us move forward. Should we assign someone to look into this further?",
                    "That's interesting. Could you elaborate on how you see this working in practice?",
                    "I agree with your assessment. What would be the next steps to make this happen?"
                ];
            }
            
            // Èõ£ÊòìÂ∫¶„Å´Âøú„Åò„Å¶ÂøúÁ≠î„ÇíË™øÊï¥
            if (difficultyLevel === 'hard') {
                // „Éè„Éº„Éâ„É¢„Éº„Éâ„Åß„ÅØ„ÄÅ„Çà„ÇäË©≥Á¥∞„ÅßÊåëÊà¶ÁöÑ„Å™ÂøúÁ≠î„ÇíËøΩÂä†
                const hardResponses = responses.map(response => {
                    return response + " I'd also like to understand the long-term implications and potential challenges we might face.";
                });
                responses = responses.concat(hardResponses);
            }
            
            const selectedResponse = responses[Math.floor(Math.random() * responses.length)];
            console.log('‚úÖ AI response generated:', selectedResponse.substring(0, 50) + '...');
            
            return selectedResponse;
        }

        // Èü≥Â£∞Ë™çË≠òÂàùÊúüÂåñ
        function initializeSpeechRecognition() {
            console.log('üé§ Initializing speech recognition...');
            
            try {
                // „Éñ„É©„Ç¶„Ç∂„Çµ„Éù„Éº„ÉàÁ¢∫Ë™ç
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    throw new Error('Èü≥Â£∞Ë™çË≠ò„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
                
                // Èü≥Â£∞Ë™çË≠ò„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // Ë®≠ÂÆö
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
                recognition.onstart = function() {
                    console.log('üé§ Speech recognition started');
                    isRecording = true;
                    updateVoiceButton();
                    showStatus('Èü≥Â£∞Ë™çË≠òÈñãÂßã - Ë©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'success');
                };
                
                recognition.onresult = function(event) {
                    console.log('üé§ Speech recognition result received');
                    
                    if (event.results && event.results.length > 0) {
                        const transcript = event.results[0][0].transcript.trim();
                        console.log('üé§ Transcript:', transcript);
                        
                        if (transcript) {
                            const userInput = document.getElementById('userInput');
                            if (userInput) {
                                const currentText = userInput.value.trim();
                                userInput.value = currentText ? currentText + ' ' + transcript : transcript;
                                userInput.focus();
                                showStatus('Èü≥Â£∞Ë™çË≠òÊàêÂäü: ' + transcript, 'success');
                            }
                        }
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('üé§ Speech recognition error:', event.error);
                    isRecording = false;
                    updateVoiceButton();
                    
                    let errorMessage = 'Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = 'Èü≥Â£∞„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü';
                            break;
                        case 'audio-capture':
                            errorMessage = '„Éû„Ç§„ÇØ„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì';
                            break;
                        case 'not-allowed':
                            errorMessage = '„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
                            break;
                        case 'network':
                            errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                            break;
                        default:
                            errorMessage = `Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº: ${event.error}`;
                    }
                    
                    showStatus(errorMessage, 'error');
                };
                
                recognition.onend = function() {
                    console.log('üé§ Speech recognition ended');
                    isRecording = false;
                    updateVoiceButton();
                };
                
                console.log('‚úÖ Speech recognition initialized successfully');
                showStatus('Èü≥Â£∞Ë™çË≠ò„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô', 'success');
                
            } catch (error) {
                console.error('‚ùå Failed to initialize speech recognition:', error);
                
                const voiceButton = document.getElementById('voiceButton');
                if (voiceButton) {
                    voiceButton.disabled = true;
                    voiceButton.textContent = 'üö´';
                    voiceButton.title = 'Èü≥Â£∞Ë™çË≠òÂà©Áî®‰∏çÂèØ';
                }
                
                showStatus('Èü≥Â£∞Ë™çË≠ò„ÇíÂàùÊúüÂåñ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü', 'error');
            }
        }

        // Èü≥Â£∞ÂÖ•Âäõ„Éà„Ç∞„É´
        function toggleVoiceInput() {
            console.log('üé§ Toggle voice input, isRecording:', isRecording);
            
            if (!recognition) {
                showStatus('Èü≥Â£∞Ë™çË≠ò„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            if (isRecording) {
                try {
                    recognition.stop();
                    isRecording = false;
                    updateVoiceButton();
                    showStatus('Èü≥Â£∞Ë™çË≠ò„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü', 'success');
                } catch (error) {
                    console.error('üé§ Error stopping recognition:', error);
                    isRecording = false;
                    updateVoiceButton();
                }
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('üé§ Error starting recognition:', error);
                    showStatus('Èü≥Â£∞Ë™çË≠ò„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            }
        }

        // Èü≥Â£∞„Éú„Çø„É≥Êõ¥Êñ∞
        function updateVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            if (!voiceButton) return;
            
            if (isRecording) {
                voiceButton.classList.add('recording');
                voiceButton.textContent = 'üî¥';
                voiceButton.title = 'Èå≤Èü≥‰∏≠ - „ÇØ„É™„ÉÉ„ÇØ„ÅßÂÅúÊ≠¢';
            } else {
                voiceButton.classList.remove('recording');
                voiceButton.textContent = 'üé§';
                voiceButton.title = '„ÇØ„É™„ÉÉ„ÇØ„ÅßÈü≥Â£∞ÂÖ•ÂäõÈñãÂßã';
            }
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄÊôÇÂÅúÊ≠¢
        function pauseSession() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
                showStatus('„Çª„ÉÉ„Ç∑„Éß„É≥„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü', 'success');
                
                // ÂÜçÈñã„Éú„Çø„É≥„Å´Â§âÊõ¥
                const pauseButton = event.target;
                pauseButton.textContent = 'ÂÜçÈñã';
                pauseButton.onclick = resumeSession;
            }
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ÂÜçÈñã
        function resumeSession() {
            startSessionTimer();
            showStatus('„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂÜçÈñã„Åó„Åæ„Åó„Åü', 'success');
            
            // ‰∏ÄÊôÇÂÅúÊ≠¢„Éú„Çø„É≥„Å´Êàª„Åô
            const resumeButton = event.target;
            resumeButton.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';
            resumeButton.onclick = pauseSession;
        }

        // ÈÄ≤Êçó‰øùÂ≠ò
        function saveProgress() {
            try {
                const progressData = {
                    conversationHistory: conversationHistory,
                    messageCount: messageCounter,
                    sessionTime: Date.now() - sessionStartTime,
                    scenario: currentScenario,
                    difficulty: currentDifficulty,
                    timestamp: new Date().toISOString()
                };
                
                // „É°„É¢„É™ÂÜÖ‰øùÂ≠òÔºàÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Åß„ÅØ localStorage „ÇÑ „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠òÔºâ
                console.log('üíæ Progress saved:', progressData);
                showStatus('ÈÄ≤Êçó„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
                
            } catch (error) {
                console.error('‚ùå Error saving progress:', error);
                showStatus('ÈÄ≤Êçó„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü
        function endSession() {
            if (confirm('„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü\nÁµÇ‰∫ÜÂæå„Å´Final Report„ÅåÁîüÊàê„Åï„Çå„Åæ„Åô„ÄÇ')) {
                // „Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                    sessionTimer = null;
                }
                
                // Èü≥Â£∞Ë™çË≠òÂÅúÊ≠¢
                if (recognition && isRecording) {
                    try {
                        recognition.stop();
                        isRecording = false;
                        updateVoiceButton();
                    } catch (error) {
                        console.error('Error stopping recognition:', error);
                    }
                }
                
                // „Çª„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„Çø„Çí‰øùÂ≠ò
                const sessionEndTime = Date.now();
                const totalSessionTime = sessionEndTime - sessionStartTime;
                const sessionMinutes = Math.floor(totalSessionTime / 60000);
                const sessionSeconds = Math.floor((totalSessionTime % 60000) / 1000);
                
                // final-report.htmlÁî®„ÅÆ„Éá„Éº„Çø„ÇíÊ∫ñÂÇô
                sessionStorage.setItem('messageCount', messageCounter.toString());
                sessionStorage.setItem('sessionDuration', `${sessionMinutes}ÂàÜ${sessionSeconds}Áßí`);
                sessionStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
                sessionStorage.setItem('sessionStartTime', sessionStartTime.toString());
                sessionStorage.setItem('sessionEndTime', sessionEndTime.toString());
                
                // „Çπ„Ç≥„Ç¢Ë®àÁÆóÔºàÁ∞°ÊòìÁâàÔºâ
                const userMessages = conversationHistory.filter(msg => msg.role === 'user');
                const totalWords = userMessages.reduce((total, msg) => {
                    return total + msg.content.split(' ').filter(word => word.length > 0).length;
                }, 0);
                const avgWordsPerMessage = userMessages.length > 0 ? Math.round(totalWords / userMessages.length) : 0;
                
                const overallScore = Math.min(100, Math.max(60, 
                    (messageCounter * 5) + (avgWordsPerMessage * 2) + 40));
                const fluencyScore = Math.min(100, Math.max(50, overallScore + Math.random() * 20 - 10));
                const accuracyScore = Math.min(100, Math.max(50, overallScore + Math.random() * 20 - 10));
                
                sessionStorage.setItem('overallScore', overallScore.toString());
                sessionStorage.setItem('fluencyScore', fluencyScore.toString());
                sessionStorage.setItem('accuracyScore', accuracyScore.toString());
                sessionStorage.setItem('averageMessageLength', avgWordsPerMessage.toString());
                sessionStorage.setItem('voiceUsageCount', '0'); // Èü≥Â£∞‰ΩøÁî®ÂõûÊï∞ÔºàÂÆüË£ÖÂøÖË¶ÅÔºâ
                
                showStatus('„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇFinal Report„Éö„Éº„Ç∏„Å´ÁßªÂãï‰∏≠...', 'success');
                
                // Final Report„Éö„Éº„Ç∏„Å´ÈÅ∑Áßª
                setTimeout(() => {
                    window.location.href = 'final-report.html';
                }, 2000);
            }
        }

        // Final ReportÁîüÊàê
        function generateFinalReport() {
            const sessionEndTime = Date.now();
            const totalSessionTime = sessionEndTime - sessionStartTime;
            const sessionMinutes = Math.floor(totalSessionTime / 60000);
            const sessionSeconds = Math.floor((totalSessionTime % 60000) / 1000);
            
            // ‰ºöË©±ÂàÜÊûê
            const userMessages = conversationHistory.filter(msg => msg.role === 'user');
            const aiMessages = conversationHistory.filter(msg => msg.role === 'ai');
            
            // ÂçòË™ûÊï∞Ë®àÁÆó
            const totalUserWords = userMessages.reduce((total, msg) => {
                return total + msg.content.split(' ').filter(word => word.length > 0).length;
            }, 0);
            
            // Âπ≥ÂùáÂøúÁ≠îÊôÇÈñìÔºàÊé®ÂÆöÔºâ
            const avgResponseTime = userMessages.length > 0 ? Math.round(totalSessionTime / userMessages.length / 1000) : 0;
            
            // Â≠¶Áøí„É¨„Éô„É´Ë©ï‰æ°
            const vocabularyLevel = evaluateVocabularyLevel(userMessages);
            const fluencyScore = evaluateFluency(userMessages, totalSessionTime);
            const engagementScore = evaluateEngagement(userMessages, aiMessages);
            
            // Final Report„Éá„Éº„Çø
            const finalReport = {
                sessionInfo: {
                    scenario: currentScenario,
                    difficulty: currentDifficulty,
                    startTime: new Date(sessionStartTime).toLocaleString('ja-JP'),
                    endTime: new Date(sessionEndTime).toLocaleString('ja-JP'),
                    duration: `${sessionMinutes}ÂàÜ${sessionSeconds}Áßí`
                },
                statistics: {
                    totalMessages: messageCounter,
                    userMessages: userMessages.length,
                    aiMessages: aiMessages.length,
                    totalWords: totalUserWords,
                    averageWordsPerMessage: userMessages.length > 0 ? Math.round(totalUserWords / userMessages.length) : 0,
                    averageResponseTime: `${avgResponseTime}Áßí`
                },
                performance: {
                    vocabularyLevel: vocabularyLevel,
                    fluencyScore: fluencyScore,
                    engagementScore: engagementScore,
                    overallScore: Math.round((vocabularyLevel + fluencyScore + engagementScore) / 3)
                },
                recommendations: generateRecommendations(vocabularyLevel, fluencyScore, engagementScore),
                conversationSample: getConversationSample(userMessages)
            };
            
            // „É¨„Éù„Éº„Éà„ÇíË°®Á§∫
            displayFinalReport(finalReport);
            
            // „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂèØËÉΩ„Å™ÂΩ¢Âºè„Åß‰øùÂ≠ò
            saveFinalReportAsFile(finalReport);
            
            console.log('üìä Final Report generated:', finalReport);
            return finalReport;
        }
        
        // Ë™ûÂΩô„É¨„Éô„É´Ë©ï‰æ°
        function evaluateVocabularyLevel(userMessages) {
            if (userMessages.length === 0) return 0;
            
            const allWords = userMessages.join(' ').toLowerCase().split(/\s+/);
            const uniqueWords = new Set(allWords.filter(word => word.length > 3));
            const vocabularyDiversity = uniqueWords.size / allWords.length;
            
            // Ë§áÈõë„Å™ÂçòË™û„ÅÆ‰ΩøÁî®È†ªÂ∫¶„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const complexWords = allWords.filter(word => word.length > 6).length;
            const complexityRatio = complexWords / allWords.length;
            
            const score = Math.min(100, Math.round((vocabularyDiversity * 50) + (complexityRatio * 50)));
            return Math.max(10, score); // ÊúÄ‰Ωé10ÁÇπ
        }
        
        // ÊµÅÊö¢ÊÄßË©ï‰æ°
        function evaluateFluency(userMessages, totalTime) {
            if (userMessages.length === 0) return 0;
            
            const totalWords = userMessages.reduce((total, msg) => {
                return total + msg.content.split(' ').length;
            }, 0);
            
            const wordsPerMinute = (totalWords / (totalTime / 60000));
            const messageFrequency = userMessages.length / (totalTime / 60000);
            
            // ÈÅ©Â∫¶„Å™„Éö„Éº„Çπ„ÇíË©ï‰æ°ÔºàÊó©„Åô„Åé„ÅöÈÅÖ„Åô„Åé„ÅöÔºâ
            const paceScore = Math.min(100, Math.max(0, (wordsPerMinute / 50) * 100));
            const frequencyScore = Math.min(100, messageFrequency * 20);
            
            return Math.round((paceScore + frequencyScore) / 2);
        }
        
        // „Ç®„É≥„Ç≤„Éº„Ç∏„É°„É≥„ÉàË©ï‰æ°
        function evaluateEngagement(userMessages, aiMessages) {
            if (userMessages.length === 0) return 0;
            
            // Ë≥™Âïè„ÅÆ‰ΩøÁî®È†ªÂ∫¶
            const questionsCount = userMessages.filter(msg => msg.content.includes('?')).length;
            const questionRatio = questionsCount / userMessages.length;
            
            // „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÈï∑„Åï„ÅÆÂ§öÊßòÊÄß
            const messageLengths = userMessages.map(msg => msg.content.length);
            const avgLength = messageLengths.reduce((a, b) => a + b, 0) / messageLengths.length;
            const lengthVariance = messageLengths.reduce((acc, len) => acc + Math.pow(len - avgLength, 2), 0) / messageLengths.length;
            
            const engagementScore = Math.min(100, (questionRatio * 40) + (Math.sqrt(lengthVariance) / 10) + 20);
            return Math.round(engagementScore);
        }
        
        // Êé®Â•®‰∫ãÈ†ÖÁîüÊàê
        function generateRecommendations(vocab, fluency, engagement) {
            const recommendations = [];
            
            if (vocab < 50) {
                recommendations.push("üìö Ë™ûÂΩôÂäõÂêë‰∏ä: „Çà„ÇäÂ§öÊßò„Å™ÂçòË™û„Çí‰Ωø„Å£„Å¶Ë°®Áèæ„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ");
            }
            if (fluency < 50) {
                recommendations.push("‚ö° ÊµÅÊö¢ÊÄßÂêë‰∏ä: „ÇÇ„ÅÜÂ∞ë„ÅóÊó©„ÅÑ„Éö„Éº„Çπ„Åß‰ºöË©±„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ");
            }
            if (engagement < 50) {
                recommendations.push("ü§ù Á©çÊ•µÊÄßÂêë‰∏ä: „Çà„ÇäÂ§ö„Åè„ÅÆË≥™Âïè„Çí„Åó„Å¶‰ºöË©±„ÇíÊ∑±„ÇÅ„Åæ„Åó„Çá„ÅÜ");
            }
            
            // „Éù„Ç∏„ÉÜ„Ç£„Éñ„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇÇËøΩÂä†
            if (vocab >= 70) {
                recommendations.push("‚ú® Á¥†Êô¥„Çâ„Åó„ÅÑË™ûÂΩôÂäõ„Åß„ÅôÔºÅ„Åì„ÅÆË™øÂ≠ê„ÅßÁ∂ö„Åë„Åæ„Åó„Çá„ÅÜ");
            }
            if (fluency >= 70) {
                recommendations.push("üéØ ÊµÅÊö¢„Å™‰ºöË©±„Åå„Åß„Åç„Å¶„ÅÑ„Åæ„ÅôÔºÅ");
            }
            if (engagement >= 70) {
                recommendations.push("üåü Á©çÊ•µÁöÑ„Å™ÂèÇÂä†„ÄÅÁ¥†Êô¥„Çâ„Åó„ÅÑ„Åß„ÅôÔºÅ");
            }
            
            return recommendations;
        }
        
        // ‰ºöË©±„Çµ„É≥„Éó„É´ÂèñÂæó
        function getConversationSample(userMessages) {
            if (userMessages.length === 0) return "No conversation recorded.";
            
            // ÊúÄ„ÇÇÈï∑„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæó
            const longestMessage = userMessages.reduce((longest, current) => {
                return current.content.length > longest.content.length ? current : longest;
            });
            
            return longestMessage.content;
        }
        
        // Final ReportË°®Á§∫
        function displayFinalReport(report) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const reportDiv = document.createElement('div');
            reportDiv.className = 'message ai final-report';
            reportDiv.style.maxWidth = '95%';
            reportDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            
            reportDiv.innerHTML = `
                <div class="role">üìä FINAL REPORT</div>
                <div class="content">
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">üéØ „Çª„ÉÉ„Ç∑„Éß„É≥Ê¶ÇË¶Å</h3>
                        <p><strong>„Ç∑„Éä„É™„Ç™:</strong> ${report.sessionInfo.scenario}</p>
                        <p><strong>Èõ£ÊòìÂ∫¶:</strong> ${getDifficultyLabel(report.sessionInfo.difficulty)}</p>
                        <p><strong>ÂÆüÊñΩÊôÇÈñì:</strong> ${report.sessionInfo.duration}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">üìà Áµ±Ë®à„Éá„Éº„Çø</h3>
                        <p><strong>Á∑è„É°„ÉÉ„Çª„Éº„Ç∏Êï∞:</strong> ${report.statistics.totalMessages}</p>
                        <p><strong>„ÅÇ„Å™„Åü„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏:</strong> ${report.statistics.userMessages}</p>
                        <p><strong>Á∑èÂçòË™ûÊï∞:</strong> ${report.statistics.totalWords}</p>
                        <p><strong>1„É°„ÉÉ„Çª„Éº„Ç∏Âπ≥ÂùáÂçòË™ûÊï∞:</strong> ${report.statistics.averageWordsPerMessage}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">‚≠ê „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπË©ï‰æ°</h3>
                        <p><strong>Ë™ûÂΩôÂäõ„Çπ„Ç≥„Ç¢:</strong> ${report.performance.vocabularyLevel}/100</p>
                        <p><strong>ÊµÅÊö¢ÊÄß„Çπ„Ç≥„Ç¢:</strong> ${report.performance.fluencyScore}/100</p>
                        <p><strong>Á©çÊ•µÊÄß„Çπ„Ç≥„Ç¢:</strong> ${report.performance.engagementScore}/100</p>
                        <p style="font-size: 18px; color: #ffeb3b;"><strong>Á∑èÂêà„Çπ„Ç≥„Ç¢: ${report.performance.overallScore}/100</strong></p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">üí° ÊîπÂñÑÊèêÊ°à</h3>
                        ${report.recommendations.map(rec => `<p>‚Ä¢ ${rec}</p>`).join('')}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 10px;">üìù „Éô„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏</h3>
                        <p style="font-style: italic; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
                            "${report.conversationSample}"
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="downloadReport()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            üìÑ „É¨„Éù„Éº„Éà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                        </button>
                    </div>
                </div>
                <div class="timestamp">${new Date().toLocaleTimeString('ja-JP')}</div>
            `;
            
            chatContainer.appendChild(reportDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // „É¨„Éù„Éº„Éà„Éï„Ç°„Ç§„É´‰øùÂ≠ò
        function saveFinalReportAsFile(report) {
            window.finalReportData = report; // „Ç∞„É≠„Éº„Éê„É´„Å´‰øùÂ≠ò„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁî®„Å´
            
            const reportText = `
ENGLISH CONVERSATION PRACTICE - FINAL REPORT
=============================================

Session Information:
- Scenario: ${report.sessionInfo.scenario}
- Difficulty: ${getDifficultyLabel(report.sessionInfo.difficulty)}
- Start Time: ${report.sessionInfo.startTime}
- End Time: ${report.sessionInfo.endTime}
- Duration: ${report.sessionInfo.duration}

Statistics:
- Total Messages: ${report.statistics.totalMessages}
- Your Messages: ${report.statistics.userMessages}
- Total Words: ${report.statistics.totalWords}
- Average Words per Message: ${report.statistics.averageWordsPerMessage}
- Average Response Time: ${report.statistics.averageResponseTime}

Performance Evaluation:
- Vocabulary Level: ${report.performance.vocabularyLevel}/100
- Fluency Score: ${report.performance.fluencyScore}/100
- Engagement Score: ${report.performance.engagementScore}/100
- Overall Score: ${report.performance.overallScore}/100

Recommendations:
${report.recommendations.map(rec => `- ${rec}`).join('\n')}

Best Message Sample:
"${report.conversationSample}"

Generated on: ${new Date().toLocaleString('ja-JP')}
            `;
            
            console.log('üìÑ Final report prepared for download');
            window.finalReportText = reportText;
        }
        
        // „É¨„Éù„Éº„Éà„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊ©üËÉΩ
        function downloadReport() {
            if (!window.finalReportText) {
                showStatus('„É¨„Éù„Éº„Éà„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            const blob = new Blob([window.finalReportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `English_Practice_Report_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('„É¨„Éù„Éº„Éà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÁôªÈå≤
        window.downloadReport = downloadReport;

        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', function(event) {
            console.error('‚ùå Global error:', event.error);
            showStatus('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + event.error.message, 'error');
        });

        // Êú™Âá¶ÁêÜ„ÅÆ Promise „Ç®„É©„Éº
        window.addEventListener('unhandledrejection', function(event) {
            console.error('‚ùå Unhandled promise rejection:', event.reason);
            showStatus('„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
        });

        // „Éö„Éº„Ç∏„ÅåÈñâ„Åò„Çâ„Çå„ÇãÂâç„ÅÆÁ¢∫Ë™ç
        window.addEventListener('beforeunload', function(event) {
            if (messageCounter > 0) {
                event.preventDefault();
                event.returnValue = '‰ºöË©±„Éá„Éº„Çø„ÅåÂ§±„Çè„Çå„Åæ„Åô„ÄÇÊú¨ÂΩì„Å´ÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü';
                return event.returnValue;
            }
        });

        // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ë°®Á§∫ÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ
        function showDebugInfo() {
            console.log('üîç Debug Info:', {
                messageCounter,
                conversationHistory: conversationHistory.length,
                isRecording,
                currentScenario,
                currentDifficulty,
                speechRecognitionAvailable: !!recognition,
                userAgent: navigator.userAgent
            });
        }

        // „Ç≥„É≥„ÇΩ„Éº„É´„Åß„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÁ¢∫Ë™ç„Åß„Åç„Çã„Çà„ÅÜ„Å´
        window.showDebugInfo = showDebugInfo;
        
        console.log('‚úÖ Application fully loaded and ready');
        console.log('üí° Type showDebugInfo() in console for debug information');
    </script>
</body>
</html>