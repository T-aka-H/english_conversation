<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªã‚³ã‚½ç·´ã‚¢ãƒ—ãƒª - è‹±ä¼šè©±ç·´ç¿’</title>
    <link rel="icon" href="data:,">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #4A90E2;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .session-details {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .session-item {
            text-align: center;
        }

        .session-item .label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .session-item .value {
            font-size: 16px;
            font-weight: 600;
            color: #4A90E2;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-right: auto;
        }

        .message .role {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message .content {
            font-size: 15px;
            line-height: 1.5;
        }

        .message .timestamp {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 8px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .user-input {
            width: 100%;
            min-height: 60px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .user-input:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.3);
        }

        .user-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .voice-button {
            padding: 15px;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            width: 60px;
            height: 60px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(220, 53, 69, 0.4);
        }

        .voice-button.recording {
            background: linear-gradient(135deg, #28a745, #20a042);
            animation: pulse 1.5s infinite;
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .send-button:hover {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 144, 226, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .control-button {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .control-button.end-session {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
        }

        .control-button.end-session:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 20px;
            max-width: 80%;
        }

        .typing-indicator .dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: #4A90E2;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .input-guide {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .input-guide strong {
            color: #4A90E2;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; transform: scale(1); }
            30% { opacity: 1; transform: scale(1.2); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .session-details {
                flex-direction: column;
                gap: 15px;
            }
            
            .input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-buttons {
                flex-direction: row;
                justify-content: center;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .control-button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>è‹±èªã‚³ã‚½ç·´ã‚¢ãƒ—ãƒª</h1>
        </div>

        <div class="session-info">
            <div class="session-details">
                <div class="session-item">
                    <div class="label">ã‚·ãƒŠãƒªã‚ª</div>
                    <div class="value" id="scenarioName">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div class="session-item">
                    <div class="label">é›£æ˜“åº¦</div>
                    <div class="value" id="difficultyLevel">--</div>
                </div>
                <div class="session-item">
                    <div class="label">çµŒéæ™‚é–“</div>
                    <div class="value" id="sessionTimer">00:00</div>
                </div>
                <div class="session-item">
                    <div class="label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</div>
                    <div class="value" id="messageCount">0</div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai">
                <div class="role">AI Assistant</div>
                <div class="content" id="initialMessage">ä¼šè©±ã‚’åˆæœŸåŒ–ä¸­...</div>
                <div class="timestamp" id="initialTimestamp"></div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="role">AI Assistant</div>
                <div class="dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="userInput" 
                        class="user-input" 
                        placeholder="è‹±èªã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„... (éŸ³å£°å…¥åŠ›ã‚‚å¯èƒ½)"
                        rows="3"
                    ></textarea>
                </div>
                <div class="input-buttons">
                    <button id="voiceButton" class="voice-button" title="éŸ³å£°å…¥åŠ›">
                        ğŸ¤
                    </button>
                    <button id="sendButton" class="send-button">
                        é€ä¿¡
                    </button>
                </div>
            </div>
            
            <div class="input-guide">
                <p><strong>ğŸ’¡ ç·´ç¿’ã®ã‚³ãƒ„:</strong></p>
                <p>â€¢ è‡ªç„¶ãªè‹±èªè¡¨ç¾ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†</p>
                <p>â€¢ å…·ä½“çš„ãªå†…å®¹ã§ä¼šè©±ã‚’æ·±ã‚ã¾ã—ã‚‡ã†</p>
                <p>â€¢ ğŸ¤ãƒœã‚¿ãƒ³ã§éŸ³å£°å…¥åŠ›ã‚‚æ´»ç”¨ã§ãã¾ã™</p>
            </div>
        </div>

        <div class="control-buttons">
            <button class="control-button" onclick="pauseSession()">
                ä¸€æ™‚åœæ­¢
            </button>
            <button class="control-button" onclick="saveProgress()">
                é€²æ—ä¿å­˜
            </button>
            <button class="control-button end-session" onclick="endSession()">
                ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
            </button>
        </div>

        <div class="footer">
            <p>developed by T.H.</p>
        </div>
    </div>

    <script>
        console.log('ğŸ’¬ Conversation page loaded');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let conversationHistory = [];
        let sessionStartTime = Date.now();
        let sessionTimer = null;
        let messageCounter = 0;
        let currentScenario = '';
        let currentDifficulty = '';
        let recognition = null;
        let isRecording = false;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOM Content Loaded');
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
            loadSessionInfo();
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã‚’é–‹å§‹
            startSessionTimer();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupEventListeners();
            
            // éŸ³å£°èªè­˜ã‚’åˆæœŸåŒ–ï¼ˆiOS Safariå‘ã‘ã«é…å»¶ï¼‰
            setTimeout(() => {
                initializeSpeechRecognition();
                
                // iOS Safariå‘ã‘ã®è¿½åŠ ãƒã‚§ãƒƒã‚¯
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome|CriOS|FxiOS/.test(navigator.userAgent);
                
                if (isIOS && isSafari) {
                    checkIOSMicrophonePermission();
                }
            }, 1500); // iOS Safariå‘ã‘ã«é•·ã‚ã®é…å»¶
            
            console.log('âœ… Conversation session initialized');
        });
        
        // iOS Safariå‘ã‘ãƒã‚¤ã‚¯æ¨©é™ãƒã‚§ãƒƒã‚¯
        async function checkIOSMicrophonePermission() {
            console.log('ğŸ” Checking iOS Safari microphone permission...');
            
            try {
                // iOS Safariã§ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
                if (navigator.permissions && navigator.permissions.query) {
                    const permission = await navigator.permissions.query({ name: 'microphone' });
                    console.log('ğŸ¤ Microphone permission status:', permission.state);
                    
                    const voiceButton = document.getElementById('voiceButton');
                    if (!voiceButton) return;
                    
                    switch (permission.state) {
                        case 'granted':
                            console.log('âœ… Microphone permission granted');
                            voiceButton.style.backgroundColor = '#28a745';
                            voiceButton.title = 'ãƒã‚¤ã‚¯æ¨©é™OK - ã‚¿ãƒƒãƒ—ã—ã¦éŸ³å£°å…¥åŠ›é–‹å§‹';
                            break;
                        case 'denied':
                            console.log('âŒ Microphone permission denied');
                            voiceButton.style.backgroundColor = '#dc3545';
                            voiceButton.title = 'ãƒã‚¤ã‚¯æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ - è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„';
                            break;
                        case 'prompt':
                            console.log('â“ Microphone permission will be prompted');
                            voiceButton.style.backgroundColor = '#ffc107';
                            voiceButton.title = 'ã‚¿ãƒƒãƒ—ã—ã¦ãƒã‚¤ã‚¯æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„';
                            break;
                    }
                    
                    // æ¨©é™çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
                    permission.addEventListener('change', function() {
                        console.log('ğŸ”„ Microphone permission changed to:', permission.state);
                        checkIOSMicrophonePermission(); // å†ãƒã‚§ãƒƒã‚¯
                    });
                }
            } catch (error) {
                console.log('â„¹ï¸ Permission API not available on this iOS version:', error.message);
                
                // Permission API ãŒä½¿ãˆãªã„å ´åˆã¯ getUserMedia ã§é–“æ¥çš„ã«ãƒã‚§ãƒƒã‚¯
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    console.log('âœ… Microphone access appears to be available');
                    
                    const voiceButton = document.getElementById('voiceButton');
                    if (voiceButton) {
                        voiceButton.style.backgroundColor = '#28a745';
                        voiceButton.title = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹OK - ã‚¿ãƒƒãƒ—ã—ã¦éŸ³å£°å…¥åŠ›é–‹å§‹';
                    }
                } catch (permError) {
                    console.log('âŒ Microphone access denied or unavailable:', permError.message);
                    
                    const voiceButton = document.getElementById('voiceButton');
                    if (voiceButton) {
                        voiceButton.style.backgroundColor = '#dc3545';
                        voiceButton.title = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ - è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„';
                    }
                }
            }
        }

        function loadSessionInfo() {
            try {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
                currentScenario = 'ãƒ“ã‚¸ãƒã‚¹è‹±ä¼šè©±ç·´ç¿’';
                currentDifficulty = 'normal';
                
                console.log('ğŸ“‹ Session info loaded:', {
                    scenario: currentScenario,
                    difficulty: currentDifficulty
                });
                
                // UIã«åæ˜ 
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = getDifficultyLabel(currentDifficulty);
                
                // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
                generateInitialMessage();
                
            } catch (error) {
                console.error('âŒ Error loading session info:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                currentScenario = 'ãƒ“ã‚¸ãƒã‚¹è‹±ä¼šè©±ç·´ç¿’';
                currentDifficulty = 'normal';
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = 'æ¨™æº–';
                
                generateInitialMessage();
            }
        }

        function getDifficultyLabel(difficulty) {
            const labels = {
                'easy': 'åˆç´š',
                'normal': 'ä¸­ç´š',
                'hard': 'ä¸Šç´š'
            };
            return labels[difficulty] || 'ä¸­ç´š';
        }

        function generateInitialMessage() {
            const scenarioLower = currentScenario.toLowerCase();
            let initialMessage = '';
            
            // ã‚·ãƒŠãƒªã‚ªã«å¿œã˜ãŸåˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (scenarioLower.includes('ä¼šè­°') || scenarioLower.includes('meeting')) {
                initialMessage = "Good morning! Thanks for joining today's meeting. I'm excited to discuss our project progress with you. How has your week been going so far?";
            } else if (scenarioLower.includes('ãƒ—ãƒ¬ã‚¼ãƒ³') || scenarioLower.includes('presentation')) {
                initialMessage = "Thank you for taking the time to see our presentation today. I'm looking forward to sharing our proposal with you. Shall we get started, or do you have any questions before we begin?";
            } else if (scenarioLower.includes('é›»è©±') || scenarioLower.includes('phone') || scenarioLower.includes('ã‚¢ãƒ')) {
                initialMessage = "Hello, thank you for calling. I understand you'd like to schedule a meeting with us. I'd be happy to help you find a suitable time. What works best for your schedule?";
            } else if (scenarioLower.includes('é›‘è«‡') || scenarioLower.includes('casual')) {
                initialMessage = "Hey there! Good to see you. How's your day going? I just grabbed a coffee - the weather's been pretty nice lately, hasn't it?";
            } else if (scenarioLower.includes('é¡§å®¢') || scenarioLower.includes('customer') || scenarioLower.includes('client')) {
                initialMessage = "Good afternoon! Thank you for contacting our support team. I'm here to help you with any questions or concerns you might have. How can I assist you today?";
            } else if (scenarioLower.includes('äº¤æ¸‰') || scenarioLower.includes('negotiation')) {
                initialMessage = "Good afternoon. I appreciate you taking the time to meet with us today to discuss our proposal. I believe we can find a mutually beneficial arrangement. What are your main priorities for this partnership?";
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                initialMessage = "Hello! I'm excited to practice English conversation with you today. Let's have a great discussion about our business scenario. How would you like to begin?";
            }
            
            // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            document.getElementById('initialMessage').textContent = initialMessage;
            document.getElementById('initialTimestamp').textContent = new Date().toLocaleTimeString('ja-JP');
            
            // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
            conversationHistory.push({
                role: 'ai',
                content: initialMessage,
                timestamp: new Date().toISOString()
            });
            
            console.log('ğŸ’¬ Initial message generated:', initialMessage.substring(0, 50) + '...');
        }

        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function setupEventListeners() {
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const voiceButton = document.getElementById('voiceButton');
            
            // é€ä¿¡ãƒœã‚¿ãƒ³
            sendButton.addEventListener('click', sendMessage);
            
            // Enterã‚­ãƒ¼ã§é€ä¿¡ (Shift+Enterã§æ”¹è¡Œ)
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³
            voiceButton.addEventListener('click', toggleVoiceInput);
            
            console.log('ğŸ§ Event listeners set up');
        }

        // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–ï¼ˆå®‰å®šæ€§é‡è¦–ç‰ˆï¼‰
        function initializeSpeechRecognition() {
            console.log('ğŸ¤ Initializing speech recognition...');
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome|CriOS|FxiOS/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent);
            const isMobile = isIOS || isAndroid;
            
            console.log('ğŸ“± Device Detection:', {
                isIOS,
                isSafari,
                isAndroid,
                isChrome,
                isMobile
            });
            
            // ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒã®å³å¯†ãƒã‚§ãƒƒã‚¯
            if (isMobile) {
                if (isIOS && !isSafari) {
                    showVoiceError('iOSã§ã¯Safariãƒ–ãƒ©ã‚¦ã‚¶ãŒå¿…è¦ã§ã™', 'safari-required');
                    return;
                }
                if (isAndroid && !isChrome) {
                    showVoiceError('Androidã§ã¯Chromeãƒ–ãƒ©ã‚¦ã‚¶ãŒå¿…è¦ã§ã™', 'chrome-required');
                    return;
                }
            }
            
            // HTTPSå¿…é ˆãƒã‚§ãƒƒã‚¯
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            console.log('ğŸ”’ Is Secure:', isSecure);
            
            if (!isSecure) {
                showVoiceError('éŸ³å£°èªè­˜ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™', 'https-required');
                return;
            }
            
            // ãƒ–ãƒ©ã‚¦ã‚¶APIå¯¾å¿œãƒã‚§ãƒƒã‚¯
            const hasWebKitSpeech = 'webkitSpeechRecognition' in window;
            const hasSpeech = 'SpeechRecognition' in window;
            
            console.log('ğŸ¤ Speech API Support:', {
                webkitSpeechRecognition: hasWebKitSpeech,
                SpeechRecognition: hasSpeech
            });
            
            if (!hasWebKitSpeech && !hasSpeech) {
                showVoiceError('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“', 'not-supported');
                return;
            }
            
            try {
                // éŸ³å£°èªè­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                console.log('ğŸ¤ Creating speech recognition instance...');
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // è¨­å®š
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                console.log('âœ… Speech recognition initialized successfully');
                
            } catch (error) {
                console.error('âŒ Failed to initialize speech recognition:', error);
                showVoiceError('éŸ³å£°èªè­˜ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'init-failed');
            }
        }
        
        // éŸ³å£°ãƒœã‚¿ãƒ³ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showVoiceError(message, type) {
            const voiceButton = document.getElementById('voiceButton');
            if (voiceButton) {
                voiceButton.disabled = true;
                voiceButton.style.opacity = '0.5';
                
                switch(type) {
                    case 'safari-required':
                        voiceButton.textContent = 'ğŸ“±S';
                        voiceButton.title = 'iOSã§ã¯SafariãŒå¿…è¦';
                        break;
                    case 'chrome-required':
                        voiceButton.textContent = 'ğŸ“±C';
                        voiceButton.title = 'Androidã§ã¯ChromeãŒå¿…è¦';
                        break;
                    case 'https-required':
                        voiceButton.textContent = 'ğŸ”’';
                        voiceButton.title = 'HTTPSæ¥ç¶šãŒå¿…è¦';
                        break;
                    case 'not-supported':
                        voiceButton.textContent = 'ğŸš«';
                        voiceButton.title = 'éŸ³å£°èªè­˜éå¯¾å¿œ';
                        break;
                    default:
                        voiceButton.textContent = 'âŒ';
                        voiceButton.title = message;
                }
            }
        }

        // éŸ³å£°å…¥åŠ›ã®ãƒˆã‚°ãƒ«
        function toggleVoiceInput() {
            console.log('ğŸ¤ toggleVoiceInput called, isRecording:', isRecording);
            
            if (!recognition) {
                console.error('âŒ Recognition not initialized');
                alert('éŸ³å£°èªè­˜ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (isRecording) {
                console.log('ğŸ¤ Stopping speech recognition');
                try {
                    recognition.stop();
                    isRecording = false;
                    updateVoiceButton();
                } catch (error) {
                    console.error('ğŸ¤ Error stopping recognition:', error);
                    isRecording = false;
                    updateVoiceButton();
                }
            } else {
                console.log('ğŸ¤ Starting speech recognition');
                try {
                    recognition.start();
                    isRecording = true;
                    updateVoiceButton();
                } catch (error) {
                    console.error('ğŸ¤ Error starting recognition:', error);
                    isRecording = false;
                    updateVoiceButton();
                    alert('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
        }

        // éŸ³å£°ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
        function updateVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            if (!voiceButton) return;
            
            if (isRecording) {
                voiceButton.classList.add('recording');
                voiceButton.textContent = 'ğŸ”´';
                voiceButton.title = 'éŒ²éŸ³ä¸­ - ã‚¯ãƒª