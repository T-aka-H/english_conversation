<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語コソ練アプリ - 英会話練習</title>
    <link rel="icon" href="data:,">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #4A90E2;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .session-details {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .session-item {
            text-align: center;
        }

        .session-item .label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .session-item .value {
            font-size: 16px;
            font-weight: 600;
            color: #4A90E2;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-right: auto;
        }

        .message .role {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message .content {
            font-size: 15px;
            line-height: 1.5;
        }

        .message .timestamp {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 8px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .user-input {
            width: 100%;
            min-height: 60px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .user-input:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.3);
        }

        .user-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .voice-button {
            padding: 15px;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            width: 60px;
            height: 60px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(220, 53, 69, 0.4);
        }

        .voice-button.recording {
            background: linear-gradient(135deg, #28a745, #20a042);
            animation: pulse 1.5s infinite;
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .send-button:hover {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 144, 226, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .control-button {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .control-button.end-session {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
        }

        .control-button.end-session:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 20px;
            max-width: 80%;
        }

        .typing-indicator .dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: #4A90E2;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .input-guide {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .input-guide strong {
            color: #4A90E2;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; transform: scale(1); }
            30% { opacity: 1; transform: scale(1.2); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .session-details {
                flex-direction: column;
                gap: 15px;
            }
            
            .input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-buttons {
                flex-direction: row;
                justify-content: center;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .control-button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>英語コソ練アプリ</h1>
        </div>

        <div class="session-info">
            <div class="session-details">
                <div class="session-item">
                    <div class="label">シナリオ</div>
                    <div class="value" id="scenarioName">読み込み中...</div>
                </div>
                <div class="session-item">
                    <div class="label">難易度</div>
                    <div class="value" id="difficultyLevel">--</div>
                </div>
                <div class="session-item">
                    <div class="label">経過時間</div>
                    <div class="value" id="sessionTimer">00:00</div>
                </div>
                <div class="session-item">
                    <div class="label">メッセージ数</div>
                    <div class="value" id="messageCount">0</div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai">
                <div class="role">AI Assistant</div>
                <div class="content" id="initialMessage">会話を初期化中...</div>
                <div class="timestamp" id="initialTimestamp"></div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="role">AI Assistant</div>
                <div class="dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="userInput" 
                        class="user-input" 
                        placeholder="英語でメッセージを入力してください... (音声入力も可能)"
                        rows="3"
                    ></textarea>
                </div>
                <div class="input-buttons">
                    <button id="voiceButton" class="voice-button" title="音声入力">
                        🎤
                    </button>
                    <button id="sendButton" class="send-button">
                        送信
                    </button>
                </div>
            </div>
            
            <div class="input-guide">
                <p><strong>💡 練習のコツ:</strong></p>
                <p>• 自然な英語表現を心がけましょう</p>
                <p>• 具体的な内容で会話を深めましょう</p>
                <p>• 🎤ボタンで音声入力も活用できます</p>
            </div>
        </div>

        <div class="control-buttons">
            <button class="control-button" onclick="pauseSession()">
                一時停止
            </button>
            <button class="control-button" onclick="saveProgress()">
                進捗保存
            </button>
            <button class="control-button end-session" onclick="endSession()">
                セッション終了
            </button>
        </div>

        <div class="footer">
            <p>developed by T.H.</p>
        </div>
    </div>

    <script>
        console.log('💬 Conversation page loaded');

        // グローバル変数
        let conversationHistory = [];
        let sessionStartTime = Date.now();
        let sessionTimer = null;
        let messageCounter = 0;
        let currentScenario = '';
        let currentDifficulty = '';
        let recognition = null;
        let isRecording = false;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM Content Loaded');
            
            // セッション情報を読み込み
            loadSessionInfo();
            
            // セッション時間を開始
            startSessionTimer();
            
            // イベントリスナーを設定
            setupEventListeners();
            
            // 音声認識を初期化（iOS Safari向けに遅延）
            setTimeout(() => {
                initializeSpeechRecognition();
                
                // iOS Safari向けの追加チェック
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome|CriOS|FxiOS/.test(navigator.userAgent);
                
                if (isIOS && isSafari) {
                    checkIOSMicrophonePermission();
                }
            }, 1500); // iOS Safari向けに長めの遅延
            
            console.log('✅ Conversation session initialized');
        });
        
        // iOS Safari向けマイク権限チェック
        async function checkIOSMicrophonePermission() {
            console.log('🔍 Checking iOS Safari microphone permission...');
            
            try {
                // iOS Safariでの権限チェック
                if (navigator.permissions && navigator.permissions.query) {
                    const permission = await navigator.permissions.query({ name: 'microphone' });
                    console.log('🎤 Microphone permission status:', permission.state);
                    
                    const voiceButton = document.getElementById('voiceButton');
                    if (!voiceButton) return;
                    
                    switch (permission.state) {
                        case 'granted':
                            console.log('✅ Microphone permission granted');
                            voiceButton.style.backgroundColor = '#28a745';
                            voiceButton.title = 'マイク権限OK - タップして音声入力開始';
                            break;
                        case 'denied':
                            console.log('❌ Microphone permission denied');
                            voiceButton.style.backgroundColor = '#dc3545';
                            voiceButton.title = 'マイク権限が拒否されています - 設定で許可してください';
                            break;
                        case 'prompt':
                            console.log('❓ Microphone permission will be prompted');
                            voiceButton.style.backgroundColor = '#ffc107';
                            voiceButton.title = 'タップしてマイク権限を許可してください';
                            break;
                    }
                    
                    // 権限状態の変更を監視
                    permission.addEventListener('change', function() {
                        console.log('🔄 Microphone permission changed to:', permission.state);
                        checkIOSMicrophonePermission(); // 再チェック
                    });
                }
            } catch (error) {
                console.log('ℹ️ Permission API not available on this iOS version:', error.message);
                
                // Permission API が使えない場合は getUserMedia で間接的にチェック
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    console.log('✅ Microphone access appears to be available');
                    
                    const voiceButton = document.getElementById('voiceButton');
                    if (voiceButton) {
                        voiceButton.style.backgroundColor = '#28a745';
                        voiceButton.title = 'マイクアクセスOK - タップして音声入力開始';
                    }
                } catch (permError) {
                    console.log('❌ Microphone access denied or unavailable:', permError.message);
                    
                    const voiceButton = document.getElementById('voiceButton');
                    if (voiceButton) {
                        voiceButton.style.backgroundColor = '#dc3545';
                        voiceButton.title = 'マイクアクセスが必要です - 設定で許可してください';
                    }
                }
            }
        }

        function loadSessionInfo() {
            try {
                // セッション情報を読み込み
                currentScenario = 'ビジネス英会話練習';
                currentDifficulty = 'normal';
                
                console.log('📋 Session info loaded:', {
                    scenario: currentScenario,
                    difficulty: currentDifficulty
                });
                
                // UIに反映
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = getDifficultyLabel(currentDifficulty);
                
                // 初期メッセージを生成
                generateInitialMessage();
                
            } catch (error) {
                console.error('❌ Error loading session info:', error);
                
                // フォールバック
                currentScenario = 'ビジネス英会話練習';
                currentDifficulty = 'normal';
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = '標準';
                
                generateInitialMessage();
            }
        }

        function getDifficultyLabel(difficulty) {
            const labels = {
                'easy': '初級',
                'normal': '中級',
                'hard': '上級'
            };
            return labels[difficulty] || '中級';
        }

        function generateInitialMessage() {
            const scenarioLower = currentScenario.toLowerCase();
            let initialMessage = '';
            
            // シナリオに応じた初期メッセージ
            if (scenarioLower.includes('会議') || scenarioLower.includes('meeting')) {
                initialMessage = "Good morning! Thanks for joining today's meeting. I'm excited to discuss our project progress with you. How has your week been going so far?";
            } else if (scenarioLower.includes('プレゼン') || scenarioLower.includes('presentation')) {
                initialMessage = "Thank you for taking the time to see our presentation today. I'm looking forward to sharing our proposal with you. Shall we get started, or do you have any questions before we begin?";
            } else if (scenarioLower.includes('電話') || scenarioLower.includes('phone') || scenarioLower.includes('アポ')) {
                initialMessage = "Hello, thank you for calling. I understand you'd like to schedule a meeting with us. I'd be happy to help you find a suitable time. What works best for your schedule?";
            } else if (scenarioLower.includes('雑談') || scenarioLower.includes('casual')) {
                initialMessage = "Hey there! Good to see you. How's your day going? I just grabbed a coffee - the weather's been pretty nice lately, hasn't it?";
            } else if (scenarioLower.includes('顧客') || scenarioLower.includes('customer') || scenarioLower.includes('client')) {
                initialMessage = "Good afternoon! Thank you for contacting our support team. I'm here to help you with any questions or concerns you might have. How can I assist you today?";
            } else if (scenarioLower.includes('交渉') || scenarioLower.includes('negotiation')) {
                initialMessage = "Good afternoon. I appreciate you taking the time to meet with us today to discuss our proposal. I believe we can find a mutually beneficial arrangement. What are your main priorities for this partnership?";
            } else {
                // デフォルトメッセージ
                initialMessage = "Hello! I'm excited to practice English conversation with you today. Let's have a great discussion about our business scenario. How would you like to begin?";
            }
            
            // 初期メッセージを表示
            document.getElementById('initialMessage').textContent = initialMessage;
            document.getElementById('initialTimestamp').textContent = new Date().toLocaleTimeString('ja-JP');
            
            // 会話履歴に追加
            conversationHistory.push({
                role: 'ai',
                content: initialMessage,
                timestamp: new Date().toISOString()
            });
            
            console.log('💬 Initial message generated:', initialMessage.substring(0, 50) + '...');
        }

        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function setupEventListeners() {
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const voiceButton = document.getElementById('voiceButton');
            
            // 送信ボタン
            sendButton.addEventListener('click', sendMessage);
            
            // Enterキーで送信 (Shift+Enterで改行)
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // 音声入力ボタン
            voiceButton.addEventListener('click', toggleVoiceInput);
            
            console.log('🎧 Event listeners set up');
        }

        // 音声認識の初期化（安定性重視版）
        function initializeSpeechRecognition() {
            console.log('🎤 Initializing speech recognition...');
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome|CriOS|FxiOS/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent);
            const isMobile = isIOS || isAndroid;
            
            console.log('📱 Device Detection:', {
                isIOS,
                isSafari,
                isAndroid,
                isChrome,
                isMobile
            });
            
            // モバイル環境の厳密チェック
            if (isMobile) {
                if (isIOS && !isSafari) {
                    showVoiceError('iOSではSafariブラウザが必要です', 'safari-required');
                    return;
                }
                if (isAndroid && !isChrome) {
                    showVoiceError('AndroidではChromeブラウザが必要です', 'chrome-required');
                    return;
                }
            }
            
            // HTTPS必須チェック
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            console.log('🔒 Is Secure:', isSecure);
            
            if (!isSecure) {
                showVoiceError('音声認識にはHTTPS接続が必要です', 'https-required');
                return;
            }
            
            // ブラウザAPI対応チェック
            const hasWebKitSpeech = 'webkitSpeechRecognition' in window;
            const hasSpeech = 'SpeechRecognition' in window;
            
            console.log('🎤 Speech API Support:', {
                webkitSpeechRecognition: hasWebKitSpeech,
                SpeechRecognition: hasSpeech
            });
            
            if (!hasWebKitSpeech && !hasSpeech) {
                showVoiceError('このブラウザは音声認識をサポートしていません', 'not-supported');
                return;
            }
            
            try {
                // 音声認識オブジェクトを作成
                console.log('🎤 Creating speech recognition instance...');
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // 設定
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                console.log('✅ Speech recognition initialized successfully');
                
            } catch (error) {
                console.error('❌ Failed to initialize speech recognition:', error);
                showVoiceError('音声認識の初期化に失敗しました: ' + error.message, 'init-failed');
            }
        }
        
        // 音声ボタンエラー表示
        function showVoiceError(message, type) {
            const voiceButton = document.getElementById('voiceButton');
            if (voiceButton) {
                voiceButton.disabled = true;
                voiceButton.style.opacity = '0.5';
                
                switch(type) {
                    case 'safari-required':
                        voiceButton.textContent = '📱S';
                        voiceButton.title = 'iOSではSafariが必要';
                        break;
                    case 'chrome-required':
                        voiceButton.textContent = '📱C';
                        voiceButton.title = 'AndroidではChromeが必要';
                        break;
                    case 'https-required':
                        voiceButton.textContent = '🔒';
                        voiceButton.title = 'HTTPS接続が必要';
                        break;
                    case 'not-supported':
                        voiceButton.textContent = '🚫';
                        voiceButton.title = '音声認識非対応';
                        break;
                    default:
                        voiceButton.textContent = '❌';
                        voiceButton.title = message;
                }
            }
        }

        // 音声入力のトグル
        function toggleVoiceInput() {
            console.log('🎤 toggleVoiceInput called, isRecording:', isRecording);
            
            if (!recognition) {
                console.error('❌ Recognition not initialized');
                alert('音声認識が初期化されていません。ページを再読み込みしてください。');
                return;
            }
            
            if (isRecording) {
                console.log('🎤 Stopping speech recognition');
                try {
                    recognition.stop();
                    isRecording = false;
                    updateVoiceButton();
                } catch (error) {
                    console.error('🎤 Error stopping recognition:', error);
                    isRecording = false;
                    updateVoiceButton();
                }
            } else {
                console.log('🎤 Starting speech recognition');
                try {
                    recognition.start();
                    isRecording = true;
                    updateVoiceButton();
                } catch (error) {
                    console.error('🎤 Error starting recognition:', error);
                    isRecording = false;
                    updateVoiceButton();
                    alert('音声認識の開始に失敗しました: ' + error.message);
                }
            }
        }

        // 音声ボタンの表示更新
        function updateVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            if (!voiceButton) return;
            
            if (isRecording) {
                voiceButton.classList.add('recording');
                voiceButton.textContent = '🔴';
                voiceButton.title = '録音中 - クリ