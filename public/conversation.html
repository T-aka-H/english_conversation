<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªã‚³ã‚½ç·´ã‚¢ãƒ—ãƒª - è‹±ä¼šè©±ç·´ç¿’</title>
    <link rel="icon" href="data:,">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #4A90E2;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .session-details {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .session-item {
            text-align: center;
        }

        .session-item .label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .session-item .value {
            font-size: 16px;
            font-weight: 600;
            color: #4A90E2;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-right: auto;
        }

        .message .role {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message .content {
            font-size: 15px;
            line-height: 1.5;
        }

        .message .timestamp {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 8px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .user-input {
            width: 100%;
            min-height: 60px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .user-input:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.3);
        }

        .user-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .voice-button {
            padding: 15px;
            background: linear-gradient(135deg, #28a745, #20a042);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            width: 60px;
            height: 60px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        .voice-button.recording {
            background: linear-gradient(135deg, #dc3545, #c82333);
            animation: pulse 1.5s infinite;
        }

        .voice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .send-button:hover {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 144, 226, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .control-button {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .control-button.end-session {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
        }

        .control-button.end-session:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 20px;
            max-width: 80%;
        }

        .typing-indicator .dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: #4A90E2;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .input-guide {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .input-guide strong {
            color: #4A90E2;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }

        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 167, 69, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            display: none;
        }

        .status-message.error {
            background: rgba(220, 53, 69, 0.95);
        }

        .status-message.warning {
            background: rgba(255, 193, 7, 0.95);
            color: black;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; transform: scale(1); }
            30% { opacity: 1; transform: scale(1.2); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .session-details {
                flex-direction: column;
                gap: 15px;
            }
            
            .input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-buttons {
                flex-direction: row;
                justify-content: center;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .control-button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div id="statusMessage" class="status-message"></div>
    
    <div class="container">
        <div class="header">
            <h1>è‹±èªã‚³ã‚½ç·´ã‚¢ãƒ—ãƒª</h1>
        </div>

        <div class="session-info">
            <div class="session-details">
                <div class="session-item">
                    <div class="label">ã‚·ãƒŠãƒªã‚ª</div>
                    <div class="value" id="scenarioName">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div class="session-item">
                    <div class="label">é›£æ˜“åº¦</div>
                    <div class="value" id="difficultyLevel">--</div>
                </div>
                <div class="session-item">
                    <div class="label">çµŒéæ™‚é–“</div>
                    <div class="value" id="sessionTimer">00:00</div>
                </div>
                <div class="session-item">
                    <div class="label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</div>
                    <div class="value" id="messageCount">0</div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai">
                <div class="role">AI Assistant</div>
                <div class="content" id="initialMessage">ä¼šè©±ã‚’åˆæœŸåŒ–ä¸­...</div>
                <div class="timestamp" id="initialTimestamp"></div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="role">AI Assistant</div>
                <div class="dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="userInput" 
                        class="user-input" 
                        placeholder="è‹±èªã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„... (éŸ³å£°å…¥åŠ›ã‚‚å¯èƒ½)"
                        rows="3"
                    ></textarea>
                </div>
                <div class="input-buttons">
                    <button id="voiceButton" class="voice-button" title="éŸ³å£°å…¥åŠ›">
                        ğŸ¤
                    </button>
                    <button id="sendButton" class="send-button">
                        é€ä¿¡
                    </button>
                </div>
            </div>
            
            <div class="input-guide">
                <p><strong>ğŸ’¡ ç·´ç¿’ã®ã‚³ãƒ„:</strong></p>
                <p>â€¢ è‡ªç„¶ãªè‹±èªè¡¨ç¾ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†</p>
                <p>â€¢ å…·ä½“çš„ãªå†…å®¹ã§ä¼šè©±ã‚’æ·±ã‚ã¾ã—ã‚‡ã†</p>
                <p>â€¢ ğŸ¤ãƒœã‚¿ãƒ³ã§éŸ³å£°å…¥åŠ›ã‚‚æ´»ç”¨ã§ãã¾ã™</p>
            </div>
        </div>

        <div class="control-buttons">
            <button class="control-button" onclick="pauseSession()">
                ä¸€æ™‚åœæ­¢
            </button>
            <button class="control-button" onclick="saveProgress()">
                é€²æ—ä¿å­˜
            </button>
            <button class="control-button end-session" onclick="endSession()">
                ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
            </button>
        </div>

        <div class="footer">
            <p>developed by T.H.</p>
        </div>
    </div>

    <script>
        console.log('ğŸ’¬ Conversation page loaded');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let conversationHistory = [];
        let sessionStartTime = Date.now();
        let sessionTimer = null;
        let messageCounter = 0;
        let currentScenario = 'ãƒ“ã‚¸ãƒã‚¹è‹±ä¼šè©±ç·´ç¿’';
        let currentDifficulty = 'normal';
        let recognition = null;
        let isRecording = false;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOM Content Loaded');
            
            try {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
                loadSessionInfo();
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã‚’é–‹å§‹
                startSessionTimer();
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupEventListeners();
                
                // åˆæœŸåŒ–å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                showStatus('ã‚¢ãƒ—ãƒªãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ', 'success');
                
                // éŸ³å£°èªè­˜ã‚’åˆæœŸåŒ–ï¼ˆé…å»¶å®Ÿè¡Œï¼‰
                setTimeout(initializeSpeechRecognition, 1000);
                
                console.log('âœ… Conversation session initialized');
                
            } catch (error) {
                console.error('âŒ Initialization error:', error);
                showStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        });

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showStatus(message, type = 'success') {
            const statusElement = document.getElementById('statusMessage');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status-message ${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±èª­ã¿è¾¼ã¿
        function loadSessionInfo() {
            try {
                console.log('ğŸ“‹ Loading session info...');
                
                // UIã«åæ˜ 
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = getDifficultyLabel(currentDifficulty);
                
                // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
                generateInitialMessage();
                
                console.log('âœ… Session info loaded successfully');
                
            } catch (error) {
                console.error('âŒ Error loading session info:', error);
                showStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
                document.getElementById('scenarioName').textContent = currentScenario;
                document.getElementById('difficultyLevel').textContent = 'ä¸­ç´š';
                generateInitialMessage();
            }
        }

        // é›£æ˜“åº¦ãƒ©ãƒ™ãƒ«å–å¾—
        function getDifficultyLabel(difficulty) {
            const labels = {
                'easy': 'åˆç´š',
                'normal': 'ä¸­ç´š',
                'hard': 'ä¸Šç´š'
            };
            return labels[difficulty] || 'ä¸­ç´š';
        }

        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        function generateInitialMessage() {
            const initialMessage = "Hello! I'm excited to practice English conversation with you today. Let's have a great discussion about our business scenario. How would you like to begin?";
            
            // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            document.getElementById('initialMessage').textContent = initialMessage;
            document.getElementById('initialTimestamp').textContent = new Date().toLocaleTimeString('ja-JP');
            
            // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
            conversationHistory.push({
                role: 'ai',
                content: initialMessage,
                timestamp: new Date().toISOString()
            });
            
            console.log('ğŸ’¬ Initial message generated');
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const voiceButton = document.getElementById('voiceButton');
            
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
            
            if (userInput) {
                userInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            if (voiceButton) {
                voiceButton.addEventListener('click', toggleVoiceInput);
            }
            
            console.log('ğŸ§ Event listeners set up');
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) {
                showStatus('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            console.log('ğŸ“¤ Sending message:', message);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            addMessage('user', message);
            
            // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            userInput.value = '';
            
            // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.disabled = true;
            }
            
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
            showTypingIndicator();
            
            // AIã®å¿œç­”ã‚’ç”Ÿæˆï¼ˆé…å»¶ä»˜ãï¼‰
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                hideTypingIndicator();
                addMessage('ai', aiResponse);
                
                if (sendButton) {
                    sendButton.disabled = false;
                }
                userInput.focus();
            }, 1500 + Math.random() * 1000);
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const roleSpan = document.createElement('div');
            roleSpan.className = 'role';
            roleSpan.textContent = role === 'user' ? 'You' : 'AI Assistant';
            
            const contentSpan = document.createElement('div');
            contentSpan.className = 'content';
            contentSpan.textContent = content;
            
            const timestampSpan = document.createElement('div');
            timestampSpan.className = 'timestamp';
            timestampSpan.textContent = new Date().toLocaleTimeString('ja-JP');
            
            messageDiv.appendChild(roleSpan);
            messageDiv.appendChild(contentSpan);
            messageDiv.appendChild(timestampSpan);
            
            // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆæœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆï¼‰
            if (messageCounter === 0) {
                const initialMessage = chatContainer.querySelector('.message.ai');
                if (initialMessage && initialMessage.querySelector('#initialMessage')) {
                    chatContainer.removeChild(initialMessage);
                }
            }
            
            chatContainer.appendChild(messageDiv);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ›´æ–°
            messageCounter++;
            document.getElementById('messageCount').textContent = messageCounter;
            
            // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
            conversationHistory.push({
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            });
            
            console.log(`âœ… Message added: ${role} - ${content.substring(0, 50)}...`);
        }

        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'block';
                
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼éè¡¨ç¤º
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        }

        // AIå¿œç­”ç”Ÿæˆ
        function generateAIResponse(userMessage) {
            const responses = [
                "That's a great point! I think we should definitely consider that approach. What do you think the timeline would look like for implementation?",
                "I appreciate you bringing that up. How do you think this aligns with our current objectives?",
                "Excellent! That could really help us move forward. Should we assign someone to look into this further?",
                "That's interesting. Could you elaborate on how you see this working in practice?",
                "I agree with your assessment. What would be the next steps to make this happen?",
                "Thank you for that question. Let me address that point specifically.",
                "That's an excellent observation. You're absolutely right to focus on that aspect.",
                "I understand your concern, and I'm here to help resolve this for you.",
                "That makes a lot of sense. How do you think we should proceed with this?",
                "You raise a good point. I hadn't considered that angle before."
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // éŸ³å£°èªè­˜åˆæœŸåŒ–
        function initializeSpeechRecognition() {
            console.log('ğŸ¤ Initializing speech recognition...');
            
            try {
                // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    throw new Error('éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // éŸ³å£°èªè­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // è¨­å®š
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                recognition.onstart = function() {
                    console.log('ğŸ¤ Speech recognition started');
                    isRecording = true;
                    updateVoiceButton();
                    showStatus('éŸ³å£°èªè­˜é–‹å§‹ - è©±ã—ã¦ãã ã•ã„', 'success');
                };
                
                recognition.onresult = function(event) {
                    console.log('ğŸ¤ Speech recognition result received');
                    
                    if (event.results && event.results.length > 0) {
                        const transcript = event.results[0][0].transcript.trim();
                        console.log('ğŸ¤ Transcript:', transcript);
                        
                        if (transcript) {
                            const userInput = document.getElementById('userInput');
                            if (userInput) {
                                const currentText = userInput.value.trim();
                                userInput.value = currentText ? currentText + ' ' + transcript : transcript;
                                userInput.focus();
                                showStatus('éŸ³å£°èªè­˜æˆåŠŸ: ' + transcript, 'success');
                            }
                        }
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('ğŸ¤ Speech recognition error:', event.error);
                    isRecording = false;
                    updateVoiceButton();
                    
                    let errorMessage = 'éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = 'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
                            break;
                        case 'audio-capture':
                            errorMessage = 'ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“';
                            break;
                        case 'not-allowed':
                            errorMessage = 'ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“';
                            break;
                        case 'network':
                            errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                            break;
                        default:
                            errorMessage = `éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`;
                    }
                    
                    showStatus(errorMessage, 'error');
                };
                
                recognition.onend = function() {
                    console.log('ğŸ¤ Speech recognition ended');
                    isRecording = false;
                    updateVoiceButton();
                };
                
                console.log('âœ… Speech recognition initialized successfully');
                showStatus('éŸ³å£°èªè­˜ãŒåˆ©ç”¨å¯èƒ½ã§ã™', 'success');
                
            } catch (error) {
                console.error('âŒ Failed to initialize speech recognition:', error);
                
                const voiceButton = document.getElementById('voiceButton');
                if (voiceButton) {
                    voiceButton.disabled = true;
                    voiceButton.textContent = 'ğŸš«';
                    voiceButton.title = 'éŸ³å£°èªè­˜åˆ©ç”¨ä¸å¯';
                }
                
                showStatus('éŸ³å£°èªè­˜ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'error');
            }
        }

        // éŸ³å£°å…¥åŠ›ãƒˆã‚°ãƒ«
        function toggleVoiceInput() {
            console.log('ğŸ¤ Toggle voice input, isRecording:', isRecording);
            
            if (!recognition) {
                showStatus('éŸ³å£°èªè­˜ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            if (isRecording) {
                try {
                    recognition.stop();
                    isRecording = false;
                    updateVoiceButton();
                    showStatus('éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'success');
                } catch (error) {
                    console.error('ğŸ¤ Error stopping recognition:', error);
                    isRecording = false;
                    updateVoiceButton();
                }
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('ğŸ¤ Error starting recognition:', error);
                    showStatus('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }
        }

        // éŸ³å£°ãƒœã‚¿ãƒ³æ›´æ–°
        function updateVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            if (!voiceButton) return;
            
            if (isRecording) {
                voiceButton.classList.add('recording');
                voiceButton.textContent = 'ğŸ”´';
                voiceButton.title = 'éŒ²éŸ³ä¸­ - ã‚¯ãƒªãƒƒã‚¯ã§åœæ­¢';
            } else {
                voiceButton.classList.remove('recording');
                voiceButton.textContent = 'ğŸ¤';
                voiceButton.title = 'ã‚¯ãƒªãƒƒã‚¯ã§éŸ³å£°å…¥åŠ›é–‹å§‹';
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€æ™‚åœæ­¢
        function pauseSession() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
                showStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ', 'success');
                
                // å†é–‹ãƒœã‚¿ãƒ³ã«å¤‰æ›´
                const pauseButton = event.target;
                pauseButton.textContent = 'å†é–‹';
                pauseButton.onclick = resumeSession;
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹
        function resumeSession() {
            startSessionTimer();
            showStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å†é–‹ã—ã¾ã—ãŸ', 'success');
            
            // ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ã«æˆ»ã™
            const resumeButton = event.target;
            resumeButton.textContent = 'ä¸€æ™‚åœæ­¢';
            resumeButton.onclick = pauseSession;
        }

        // é€²æ—ä¿å­˜
        function saveProgress() {
            try {
                const progressData = {
                    conversationHistory: conversationHistory,
                    messageCount: messageCounter,
                    sessionTime: Date.now() - sessionStartTime,
                    scenario: currentScenario,
                    difficulty: currentDifficulty,
                    timestamp: new Date().toISOString()
                };
                
                // ãƒ¡ãƒ¢ãƒªå†…ä¿å­˜ï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ localStorage ã‚„ ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼‰
                console.log('ğŸ’¾ Progress saved:', progressData);
                showStatus('é€²æ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('âŒ Error saving progress:', error);
                showStatus('é€²æ—ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
        function endSession() {
            if (confirm('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')) {
                // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                    sessionTimer = null;
                }
                
                // éŸ³å£°èªè­˜åœæ­¢
                if (recognition && isRecording) {
                    try {
                        recognition.stop();
                        isRecording = false;
                        updateVoiceButton();
                    } catch (error) {
                        console.error('Error stopping recognition:', error);
                    }
                }
                
                // æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                saveProgress();
                
                showStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼', 'success');
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã®å‡¦ç†
                setTimeout(() => {
                    // ã“ã“ã§é€šå¸¸ã¯ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹ã‹ã€çµæœç”»é¢ã‚’è¡¨ç¤º
                    console.log('Session ended successfully');
                    showSessionSummary();
                }, 2000);
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¦‚è¦è¡¨ç¤º
        function showSessionSummary() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'message ai';
                summaryDiv.innerHTML = `
                    <div class="role">Session Summary</div>
                    <div class="content">
                        <strong>ğŸ‰ ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼</strong><br>
                        ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${messageCounter}<br>
                        â±ï¸ çµŒéæ™‚é–“: ${document.getElementById('sessionTimer').textContent}<br>
                        ğŸ“‹ ã‚·ãƒŠãƒªã‚ª: ${currentScenario}<br>
                        ğŸ’ª é›£æ˜“åº¦: ${getDifficultyLabel(currentDifficulty)}<br><br>
                        ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã¾ãŸç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚
                    </div>
                    <div class="timestamp">${new Date().toLocaleTimeString('ja-JP')}</div>
                `;
                
                chatContainer.appendChild(summaryDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(event) {
            console.error('âŒ Global error:', event.error);
            showStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + event.error.message, 'error');
        });

        // æœªå‡¦ç†ã® Promise ã‚¨ãƒ©ãƒ¼
        window.addEventListener('unhandledrejection', function(event) {
            console.error('âŒ Unhandled promise rejection:', event.reason);
            showStatus('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        });

        // ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã‚‹å‰ã®ç¢ºèª
        window.addEventListener('beforeunload', function(event) {
            if (messageCounter > 0) {
                event.preventDefault();
                event.returnValue = 'ä¼šè©±ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ã€‚æœ¬å½“ã«çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ';
                return event.returnValue;
            }
        });

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
        function showDebugInfo() {
            console.log('ğŸ” Debug Info:', {
                messageCounter,
                conversationHistory: conversationHistory.length,
                isRecording,
                currentScenario,
                currentDifficulty,
                speechRecognitionAvailable: !!recognition,
                userAgent: navigator.userAgent
            });
        }

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«
        window.showDebugInfo = showDebugInfo;
        
        console.log('âœ… Application fully loaded and ready');
        console.log('ğŸ’¡ Type showDebugInfo() in console for debug information');
    </script>
</body>
</html>