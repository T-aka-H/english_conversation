<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Situational AI English - Conversation Practice</title>
    <link rel="icon" href="data:,">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: white; 
            padding: 20px; 
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
            overflow: hidden;
        }
        
        .header {
            background: rgba(255,255,255,0.05);
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: #4A90E2;
            margin-bottom: 5px;
            font-weight: 300;
        }
        
        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .info-item {
            background: rgba(255,255,255,0.05);
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .info-item h4 {
            color: #4A90E2;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .info-item p {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            min-height: calc(100vh - 200px);
        }
        
        .conversation-area {
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
        }
        
        .conversation-display {
            flex: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            line-height: 1.4;
        }
        
        .message.ai {
            background: rgba(74, 144, 226, 0.1);
            border-left: 3px solid #4A90E2;
        }
        
        .message.user {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28a745;
            margin-left: 20px;
        }
        
        .message .sender {
            font-weight: bold;
            font-size: 12px;
            color: #4A90E2;
            margin-bottom: 5px;
        }
        
        .message.user .sender {
            color: #28a745;
        }
        
        .input-area {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .input-group {
            flex: 1;
        }
        
        .input-textarea {
            width: 100%;
            min-height: 60px;
            max-height: 120px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .input-textarea:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.2);
        }
        
        .input-textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 100px;
        }
        
        .button:hover:not(:disabled) {
            background: linear-gradient(135deg, #357ABD, #2E6DA4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.primary {
            background: linear-gradient(135deg, #28A745, #20A042);
        }
        
        .button.primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #20A042, #1E7E3A);
        }
        
        .button.secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .button.secondary:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .sidebar {
            background: rgba(255,255,255,0.03);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 30px 20px;
        }
        
        .sidebar h3 {
            color: #4A90E2;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .sidebar-section {
            margin-bottom: 25px;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28A745, #20A042);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #4A90E2;
        }
        
        .stat-label {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-top: 2px;
        }
        
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.7);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-left: 2px solid #4A90E2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-left: none;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
            
            .conversation-area {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .session-info {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .input-area {
                flex-direction: column;
            }
            
            .input-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Business English Conversation Practice</h1>
            
            <div class="session-info">
                <div class="info-item">
                    <h4>Scenario</h4>
                    <p id="scenarioDisplay">Loading...</p>
                </div>
                <div class="info-item">
                    <h4>Difficulty</h4>
                    <p id="difficultyDisplay">Loading...</p>
                </div>
                <div class="info-item">
                    <h4>Session Time</h4>
                    <p id="sessionTimer">00:00</p>
                </div>
                <div class="info-item">
                    <h4>Messages</h4>
                    <p><span id="messageCount">0</span> exchanges</p>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="conversation-area">
                <div class="conversation-display" id="conversationDisplay">
                    <div class="message ai">
                        <div class="sender">AI Assistant</div>
                        <p>Welcome to your business English conversation practice! I'm ready to engage in the scenario you've selected. Please start the conversation whenever you're ready.</p>
                    </div>
                </div>
                
                <div class="loading-indicator" id="loadingIndicator">
                    <span class="loading-spinner"></span>
                    AI is thinking...
                </div>
                
                <div class="input-area">
                    <div class="input-group">
                        <textarea 
                            id="userInput" 
                            class="input-textarea"
                            placeholder="Type your response in English here..."
                            rows="3"
                        ></textarea>
                    </div>
                    
                    <div class="input-buttons">
                        <button id="sendButton" class="button primary" onclick="sendMessage()">
                            Send
                        </button>
                        <button class="button secondary" onclick="clearConversation()">
                            Clear
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>üìä Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.7);">
                        <span id="progressText">0% Complete</span>
                    </p>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="accuracyScore">--</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="fluencyScore">--</div>
                            <div class="stat-label">Fluency</div>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3>‚ö° Quick Actions</h3>
                    <div class="quick-actions">
                        <button class="button secondary" onclick="getHint()">
                            üí° Get Hint
                        </button>
                        <button class="button secondary" onclick="requestFeedback()">
                            üìù Get Feedback
                        </button>
                        <button class="button secondary" onclick="finishSession()">
                            ‚úÖ Finish Session
                        </button>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3>‚öôÔ∏è Session Control</h3>
                    <div class="quick-actions">
                        <button class="button secondary" onclick="restartSession()">
                            üîÑ Restart
                        </button>
                        <button class="button secondary" onclick="goBack()">
                            ‚Üê Back
                        </button>
                        <button class="button secondary" onclick="logout()">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let messageCount = 0;
        let sessionStartTime = new Date();
        let timerInterval;
        let conversationHistory = [];
        
        console.log('üí¨ Conversation page loaded');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Initializing conversation session...');
            
            // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
            if (!checkAuthentication()) {
                return;
            }
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
            loadSessionInfo();
            
            // „Çø„Ç§„Éû„Éº„ÇíÈñãÂßã
            startSessionTimer();
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupEventListeners();
            
            console.log('‚úÖ Conversation session initialized');
        });
        
        function checkAuthentication() {
            try {
                const isAuthenticated = sessionStorage.getItem('isAuthenticated');
                const authTime = sessionStorage.getItem('authTime');
                
                if (!isAuthenticated) {
                    console.log('‚ùå No authentication found');
                    alert('Please login first.');
                    window.location.replace('index.html');
                    return false;
                }
                
                // Ë™çË®º„ÅÆÊúâÂäπÊúüÈôê„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà24ÊôÇÈñìÔºâ
                if (authTime) {
                    const currentTime = new Date().getTime();
                    const authTimeStamp = parseInt(authTime);
                    const hoursDiff = (currentTime - authTimeStamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        console.log('‚è∞ Authentication expired');
                        sessionStorage.clear();
                        alert('Session expired. Please login again.');
                        window.location.replace('index.html');
                        return false;
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Authentication check error:', error);
                window.location.replace('index.html');
                return false;
            }
        }
        
        function loadSessionInfo() {
            try {
                // „Ç∑„Éä„É™„Ç™ÊÉÖÂ†±„ÇíË°®Á§∫
                const scenario = sessionStorage.getItem('selectedScenario');
                const difficulty = sessionStorage.getItem('selectedDifficulty');
                
                document.getElementById('scenarioDisplay').textContent = 
                    scenario || 'No scenario selected';
                    
                document.getElementById('difficultyDisplay').textContent = 
                    difficulty ? (difficulty.charAt(0).toUpperCase() + difficulty.slice(1)) : 'Normal';
                
                console.log('üìã Loaded scenario:', scenario);
                console.log('‚öôÔ∏è Loaded difficulty:', difficulty);
                
            } catch (error) {
                console.error('‚ùå Error loading session info:', error);
            }
        }
        
        function setupEventListeners() {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            
            // Enter „Ç≠„Éº„Åß„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÔºàShift+Enter „ÅßÊîπË°åÔºâ
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´„Éï„Ç©„Éº„Ç´„Çπ
            userInput.focus();
        }
        
        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = now - sessionStartTime;
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) {
                alert('Please enter a message.');
                return;
            }
            
            console.log('üì§ Sending message:', message);
            
            // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            addMessageToDisplay('user', 'You', message);
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
            userInput.value = '';
            
            // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            document.getElementById('sendButton').disabled = true;
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            showLoading(true);
            
            // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
            conversationHistory.push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            
            // AI„É¨„Çπ„Éù„É≥„Çπ„Çí„Ç∑„Éü„É•„É¨„Éº„ÉàÔºàÂÆüÈöõ„ÅÆAIÈÄ£Êê∫ÊôÇ„ÅØ„Åì„Åì„ÇíÂ§âÊõ¥Ôºâ
            setTimeout(() => {
                generateAIResponse(message);
            }, 1000 + Math.random() * 2000); // 1-3Áßí„ÅÆ„É©„É≥„ÉÄ„É†ÈÅÖÂª∂
        }
        
        function generateAIResponse(userMessage) {
            // „Åì„Çå„ÅØÁ∞°ÊòìÁöÑ„Å™„Éá„É¢ÂøúÁ≠î„Åß„Åô„ÄÇÂÆüÈöõ„ÅÆAIÈÄ£Êê∫ÊôÇ„ÅØÈÅ©Âàá„Å™API„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            const responses = [
                "That's an interesting point. Could you elaborate on the specific challenges you're facing?",
                "I understand your perspective. How do you think we can move forward with this proposal?",
                "Thank you for sharing that information. What would be the next steps in your opinion?",
                "That's a valid concern. Have you considered alternative approaches to address this issue?",
                "I appreciate your input. Could you provide more details about the timeline you have in mind?",
                "Good point. How do you see this impacting our current operations?",
                "That makes sense. What resources would you need to implement this solution?",
                "Interesting approach. How would you measure the success of this initiative?"
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            // AI„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            addMessageToDisplay('ai', 'AI Assistant', randomResponse);
            
            // ‰ºöË©±Â±•Ê≠¥„Å´ËøΩÂä†
            conversationHistory.push({
                role: 'assistant',
                content: randomResponse,
                timestamp: new Date().toISOString()
            });
            
            // UIÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            showLoading(false);
            document.getElementById('sendButton').disabled = false;
            document.getElementById('userInput').focus();
            
            // ÈÄ≤Êçó„Å®„Çπ„Ç≥„Ç¢„ÇíÊõ¥Êñ∞
            updateProgress();
        }
        
        function addMessageToDisplay(type, sender, message) {
            const conversationDisplay = document.getElementById('conversationDisplay');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            messageDiv.innerHTML = `
                <div class="sender">${sender}</div>
                <p>${message}</p>
            `;
            
            conversationDisplay.appendChild(messageDiv);
            
            // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏ãÈÉ®„Å´
            conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
            
            // „É°„ÉÉ„Çª„Éº„Ç∏„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
            if (type === 'user') {
                messageCount++;
                document.getElementById('messageCount').textContent = messageCount;
            }
        }
        
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = show ? 'block' : 'none';
        }
        
        function updateProgress() {
            // Á∞°ÊòìÁöÑ„Å™ÈÄ≤ÊçóË®àÁÆóÔºà„É°„ÉÉ„Çª„Éº„Ç∏Êï∞„Å´Âü∫„Å•„ÅèÔºâ
            const progress = Math.min(messageCount * 10, 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '% Complete';
            
            // Á∞°ÊòìÁöÑ„Å™„Çπ„Ç≥„Ç¢Ë®àÁÆó
            const accuracy = Math.floor(Math.random() * 20) + 80; // 80-100
            const fluency = Math.floor(Math.random() * 15) + 75;  // 75-90
            
            document.getElementById('accuracyScore').textContent = accuracy + '%';
            document.getElementById('fluencyScore').textContent = fluency + '%';
        }
        
        function clearConversation() {
            if (confirm('Are you sure you want to clear the conversation?')) {
                document.getElementById('conversationDisplay').innerHTML = `
                    <div class="message ai">
                        <div class="sender">AI Assistant</div>
                        <p>Conversation cleared. Let's start fresh! Please begin the conversation.</p>
                    </div>
                `;
                conversationHistory = [];
                messageCount = 0;
                document.getElementById('messageCount').textContent = '0';
                updateProgress();
            }
        }
        
        function getHint() {
            const hints = [
                "Try using more professional business vocabulary in your responses.",
                "Consider asking follow-up questions to show engagement.",
                "Use transition phrases like 'Furthermore' or 'In addition' to connect your ideas.",
                "Practice active listening by acknowledging the other person's points.",
                "Try to be more specific with numbers, dates, or concrete examples."
            ];
            
            const randomHint = hints[Math.floor(Math.random() * hints.length)];
            alert('üí° Hint: ' + randomHint);
        }
        
        function requestFeedback() {
            if (conversationHistory.length === 0) {
                alert('Please have a conversation first before requesting feedback.');
                return;
            }
            
            alert('üìù Feedback will be provided at the end of the session. Continue practicing!');
        }
        
        function finishSession() {
            if (confirm('Are you sure you want to finish this session?')) {
                // „Çª„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„Çø„Çí‰øùÂ≠ò
                const sessionData = {
                    scenario: sessionStorage.getItem('selectedScenario'),
                    difficulty: sessionStorage.getItem('selectedDifficulty'),
                    messageCount: messageCount,
                    conversationHistory: conversationHistory,
                    sessionDuration: new Date() - sessionStartTime
                };
                
                sessionStorage.setItem('sessionData', JSON.stringify(sessionData));
                
                // ÊúÄÁµÇ„É¨„Éù„Éº„Éà„Éö„Éº„Ç∏„Å´ÈÅ∑ÁßªÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
                window.location.href = 'final-report.html';
            }
        }
        
        function restartSession() {
            if (confirm('Are you sure you want to restart this session?')) {
                window.location.reload();
            }
        }
        
        function goBack() {
            if (confirm('Are you sure you want to go back? Current progress will be lost.')) {
                window.location.href = 'difficulty.html';
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.clear();
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                window.location.replace('index.html');
            }
        }
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', function(e) {
            console.error('‚ùå Page error:', e.error);
        });
        
        // „Éö„Éº„Ç∏„ÇíÈõ¢„Çå„ÇãÂâç„ÅÆÁ¢∫Ë™ç
        window.addEventListener('beforeunload', function(e) {
            if (messageCount > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        console.log('üìú Conversation script loaded');
    </script>
</body>
</html>